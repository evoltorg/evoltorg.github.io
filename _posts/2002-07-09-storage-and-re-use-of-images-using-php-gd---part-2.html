---
layout: post
permalink: Storage_and_re_use_of_images_using_PHP_GD_Part_2
ratings: 7
avgrate: 4.2857
user: gvtulder
real_name: "Gijs van Tulder"
user_since: 2002-02-05
avatar: "/images/pictures/picture-20899.jpg"
article_count: 7
excerpt: "Publishing images on the web is nice, but tedious. It would be nice if we could use a system that automates the uploading, storage, converting and resizing of our images. We could feed that system our images once, and retrieve them later in many different formats. In this article, we will write some"
---
<p></p>Publishing images on the web is nice, but tedious. It would be nice if we could use a system that automates the uploading, storage, converting and resizing of our images. We could feed that system our images once, and retrieve them later in many different formats. In this article, we will write some scripts that come close to this ideal system. PHP and the GD-library will provide us with an easy method of uploading, searching and publishing our images. (This article is a follow-up on <a href="http://www.evolt.org/article/Storage_and_re_use_of_images_using_PHP_GD_Part_1/20/27237/index.html">part 1</a>).</p></p></p><p><p></p>In this second part, we will write scripts that you can use to retrieve images and search your image database. To be able to use these scripts, you should have read <a href="http://www.evolt.org/Storage_and_re_use_of_images_using_PHP_GD_Part_1">the first part of this article</a> and saved the scripts we wrote there. You also need the image resize script explained in <a href="http://www.evolt.org/Automated_Creation_of_Thumbnails_With_PHP">an earlier article</a>. (This was also stated in part 1.)</p></p></p><p><h2>What we will do in this second part</h2></p><p></p>We will write scripts that allow us to:</p></p></p><ol><li>automatically generate an appropriate img tag for an image;</li></p><li>search and find our images;</li></p><li>a popup that shows us a larger version of an image. (This isn't that difficult, but it's a nice example of how we can use our scripts to create img tags.)</li></ol></p><p><h2>Creating the img tag</h2></p><p></p>First, we need a function that, when provided with an image name, does this:</p></p></p><ol><li>looks up the image information in the database;</li></p><li>calculates the height and width of the image after resizing;</li></p><li>builds the URL to the image retrieval script;</li></p><li>combines these three parts in a nice img tag for use in our html.</li></ol></p><p><h3>The function</h3></p><p></p>In <code>imgtag.php</code>, we start with defining the name of the table containing the image info and connecting to the database. Then, we open a function called <code>img_tag</code>, that will return the img tag.</p></p></p><pre>// define database table containing image info</p>$img_table = "images";</p><p>// connect with database</p>mysql_connect("yourhost", "youruser", "password");</p>mysql_select_db("yourdb");</p><p>// generates and returns an img-tag</p>function img_tag($img_file, $attrib) {</p>	global $img_table;</pre></p><p><p></p>To create an img tag, our function needs the following arguments passed:</p></p></p><ul><li><code>$img_file</code>: the 13-character filename of the image, as saved in the database and in the filesystem;</li></p><li><code>$attrib</code>: an array describing how we want the image to be. This associative array consists of the same one-letter keys we used in the <a href="http://www.evolt.org/Automated_Creation_of_Thumbnails_With_PHP">resize script</a>.</li></p></ul></p><p><h3>Preserving the attributes</h3></p><p></p>Not only will the information in <code>$attrib</code> be used in this function, but it will also get passed to the image resize script. The data in <code>$attrib</code> gets changed later in the function, so we should preserve it now to put it in the img tag. The values in the array get concatenated and saved as a string in <code>$attribs</code>.</p></p></p><pre>	// concatenate the attributes in $attrib</p>	$attribs = "";</p>	foreach ($attrib as $key =&gt; $value) {</p>		$attribs .= '+'."$key($value)";</p>	}</pre></p><p><h3>Retrieving the image from the database</h3></p><p></p>Now, we have to look in the database and see if our image can be found. We use the provided <code>$img_name</code> to find the right entry.</p></p></p><pre>	// retrieve image info from database</p>	$result = mysql_query("SELECT * FROM $img_table ".</p>	            "WHERE img_file='$img_file'");</p><p>	// check that an entry is found</p>	if (mysql_num_rows($result)!=1) {</p>		return false;</p>	}</p><p>	// get this row</p>	$img_info = mysql_fetch_array($result);</pre></p><p><h3>Calculating image height and width</h3></p><p></p>We've got the image information in the <code>$img_info</code> array. We've also got any possible resize instructions in the <code>$attrib</code> array. Using this information, we can calculate what proportions the image will have. We can then specify the height and width in our img tag.</p></p></p><p></p>We use a slightly modified version of the code we used in the <a href="http://www.evolt.org/Automated_Creation_of_Thumbnails_With_PHP">image resize script</a> to calculate the new width and height.</p></p></p><pre>	// check for maximum width and height</p>	if (isset($attrib["x"])) {</p>		if ($attrib["x"] &lt; $img_info["img_width"]) {</p>			$attrib["w"] = $attrib["x"];</p>		}</p>	}</p>	if (isset($attrib["y"])) {</p>		if ($attrib["y"] &lt; $img_info["img_height"]) {</p>			$attrib["h"] = $attrib["y"];</p>		}</p>	}</p>	</p>	// check for need to resize</p>	// convert relative to absolute</p>	if (isset($attrib["w"])) {</p>		if (strstr($attrib["w"], "%")) {</p>			$attrib["w"] = (intval(substr($attrib["w"], 0, -1)) / 100) *</p>			              $img_info["img_width"];</p>		}</p>	}</p>	if (isset($attrib["h"])) {</p>		if (strstr($attrib["h"], "%")) {</p>			$attrib["h"] = (intval(substr($attrib["h"], 0, -1)) / 100) *</p>			              $img_info["img_height"];</p>		}</p>  }</p><p>  // resize</p>  if (isset($attrib["w"]) and isset($attrib["h"])) {</p>		$out_w = $attrib["w"];</p>		$out_h = $attrib["h"];</p>  } elseif (isset($attrib["w"]) and !isset($attrib["h"])) {</p>		$out_w = $attrib["w"];</p>		$out_h = $img_info["img_height"] * ($attrib["w"] / $img_info["img_width"]);</p>  } elseif (!isset($attrib["w"]) and isset($attrib["h"])) {</p>		$out_w = $img_info["img_width"] * ($attrib["h"] / $img_info["img_height"]);</p>		$out_h = $attrib["h"];</p>  } else {</p>		$out_w = $img_info["img_width"];</p>		$out_h = $img_info["img_height"];</p>  }</pre></p><p><h3>The img tag</h3></p><p></p>The last thing our function has to do, is actually create the img tag and return that.</p></p></p><pre>	// create and return the img-tag</p>	$img = '&lt;img src="img.php?f('.$img_file.')'.$attribs.'" '.</p>	       'width="'.$out_w.'" height="'.$out_h.'" '.</p>	       'alt="'.$img_info["img_alt"].'" border="0"&gt;';</p><p>	return $img;</p>}</pre></p><p><h2>The search form</h2></p><p></p>To search the images, we start with a simple form. We can search by title, description, alt-text and image size. Save the form as, for example, <code>search.html</code>. You can change the form to suit your needs, but basically it would look like this:</p></p></p><pre>&lt;form enctype="multipart/form-data" method="post" action="search.php"&gt;</p>&lt;b&gt;Search image&lt;/b&gt;&lt;br&gt;</p>Title: &lt;input name="title" type="text"&gt;&lt;br&gt;</p>Description: &lt;input name="descr" type="text"&gt;&lt;br&gt;</p>Alt-text: &lt;input name="alt" type="text"&gt;&lt;br&gt;</p>Width: &lt;select name="width_expr"&gt;&lt;option value="="&gt;=&lt;/option&gt;&lt;option value="&amp;gt;"&gt;&amp;gt;&lt;/option&gt;&lt;option value="&amp;lt;"&gt;&amp;lt;&lt;/option&gt;&lt;/select&gt; &lt;input name="width" type="text"&gt;&lt;br&gt;</p>Height: &lt;select name="height_expr"&gt;&lt;option value="="&gt;=&lt;/option&gt;&lt;option value="&amp;gt;"&gt;&amp;gt;&lt;/option&gt;&lt;option value="&amp;lt;"&gt;&amp;lt;&lt;/option&gt;&lt;/select&gt; &lt;input name="height" type="text"&gt;&lt;br&gt;</p>Bytes: &lt;select name="bytes_expr"&gt;&lt;option value="="&gt;=&lt;/option&gt;&lt;option value="&amp;gt;"&gt;&amp;gt;&lt;/option&gt;&lt;option value="&amp;lt;"&gt;&amp;lt;&lt;/option&gt;&lt;/select&gt; &lt;input name="bytes" type="text"&gt;&lt;br&gt;</p>Type: &lt;select name="type"&gt;&lt;option value=""&gt;any&lt;/option&gt;&lt;option value="JPG"&gt;JPG&lt;/option&gt;&lt;option value="PNG"&gt;PNG&lt;/option&gt;&lt;/select&gt;&lt;br&gt;</p>&lt;input type="submit" value="Search"&gt;</p>&lt;/form&gt;</pre></p><p><h2>The search script</h2></p><p></p>The input from the search form is sent to <code>search.php</code>. We will write this script now. After doing a search, it should return the images with the appropriate data. The user should also be able to click on the images for a popup larger version. </p></p></p><p></p>The first step is the inclusion of the img tag-script. Normally, you would also have to connect to the database. We already did that in the included script, so that's not necessary here.</p></p></p><p></p><code>include("imgtag.php");</code></p></p></p><p><h3>The query</h3></p><p></p>Using the data posted by the form, we can now build a search query. (We only search for width, height and bytes if a value is given.)</p></p></p><pre>// build query</p>$query = "SELECT * FROM images WHERE ";</p><p>// title</p>$query .= "img_title LIKE '%".$HTTP_POST_VARS["title"]."%' AND ";</p><p>// description</p>$query .= "img_descr LIKE '%".$HTTP_POST_VARS["descr"]."%' AND ";</p><p>// alt</p>$query .= "img_alt LIKE '%".$HTTP_POST_VARS["alt"]."%' AND ";</p><p>// width</p>if (trim($HTTP_POST_VARS["width"])!="") {</p>	$query .= "img_width".$HTTP_POST_VARS["width_expr"].</p>	           $HTTP_POST_VARS["width"]." AND ";</p>}</p><p>// height</p>if (trim($HTTP_POST_VARS["height"])!="") {</p>	$query .= "img_height".$HTTP_POST_VARS["height_expr"].</p>	           $HTTP_POST_VARS["height"]." AND ";</p>}</p><p>// bytes</p>if (trim($HTTP_POST_VARS["bytes"])!="") {</p>	$query .= "img_bytes".$HTTP_POST_VARS["bytes_expr"].</p>	           $HTTP_POST_VARS["bytes"]." AND ";</p>}</p><p>// type</p>$query .= "img_alt LIKE '%".$HTTP_POST_VARS["type"]."%' AND ";</p><p>// finish the query (we ended every part with AND)</p>$query .= "1";</pre></p><p><p></p>Execute and count the results:</p></p></p><pre>// execute the query</p>$result = mysql_query($query);</p><p>// get the number of results</p>$num_rows = mysql_num_rows($result);</pre></p><p><h3>The results</h3></p><p></p>We start with a basic html-page. We also include a JavaScript function (borrowed from <a href="http://www.vpro.nl/index/index.shtml?2781170+3788383+3779624" target="_new" title="One of the Dutch broadcasting organisations, very active on the internet">www.vpro.nl</a>) to display the popup with a larger version of the image.</p></p></p><pre>?&gt;&lt;html&gt;</p>&lt;script language="javascript"&gt;</p>/* source: www.vpro.nl */</p>function bigImage(name) { </p> if (navigator.appName=="Netscape") {</p>  var imagewindow = window.open('bigimage.php?f='+name,'imagewindow'+name, 'resizable=yes,scrollbars=no,status=1,innerWidth=450,innerHeight=402');</p> }</p> else {</p>  var imagewindow = window.open('bigimage.php?f='+name,'imagewindow'+name, 'resizable=yes,scrollbars=yes,status=1,width=450,height=402');</p> }</p>}</p>&lt;/script&gt;</p>&lt;body&gt;</p>&lt;h1&gt;Search Results&lt;/h1&gt;</p>&lt;table&gt;&lt;?php</pre></p><p><p></p>Per image, we display one table row. We add a popup link to <code>bigimage.php</code>, a script that displays a larger version of the image. We just link to it for now, we will write <code>bigimage.php</code> in the next step. The <code>img_tag</code> function is used to generate the img tag.</p></p></p><pre>// one row for each result</p>for ($i=0; $i&lt;$num_rows; $i++) {</p>	// fetch row</p>	$img_info = mysql_fetch_array($result);</p><p>	// start table row</p>	echo '&lt;tr&gt;&lt;td&gt;&lt;a href="bigimage.php?f='.$img_info["img_file"].'" '.</p>	     'target="_new" onclick="bigImage('."'".$img_info["img_file"]."')".</p>	     '; return false;"&gt;';</p><p>	// generate the image tag</p>	echo img_tag($img_info["img_file"], array("x"=&gt;"250"));</p><p>	// echo image information</p>	echo "&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;".$img_info["img_title"]."&lt;/b&gt;&lt;br&gt;".</p>	     $img_info["img_descr"]."&lt;hr&gt;&lt;b&gt;Alt:&lt;/b&gt; ".$img_info["img_alt"].</p>	     "&lt;br&gt;&lt;b&gt;Pixels:&lt;/b&gt; ".$img_info["img_width"]."x".</p>	     $img_info["img_height"]."&lt;br&gt;&lt;b&gt;Bytes:&lt;/b&gt; ".</p>	     $img_info["img_bytes"]."&lt;br&gt;&lt;b&gt;Type:&lt;/b&gt; ".</p>	     $img_info["img_type"]."&lt;/td&gt;&lt;/tr&gt;</p>";</p>}</pre></p><p><p></p>Now just close the table, body and html tags and your search script is finished.</p></p></p><p><h2>Bigimage.php</h2></p><p></p>As said, this script isn't very complicated. It uses the <code>img_tag</code> function to display a larger version of the image. That image links to the full-size version of the image. Save the code as <code>bigimage.php</code> and you're ready.</p></p></p><pre>&lt;html&gt;</p>&lt;body&gt;</p>&lt;?php</p>include("imgtag.php");</p><p>echo '&lt;a href="img.php?f('.$HTTP_GET_VARS["f"].')"&gt;';</p>echo img_tag($HTTP_GET_VARS["f"], array("x"=&gt;"400"));</p>echo '&lt;/a&gt;';</p>?&gt;</p>&lt;/body&gt;</p>&lt;/html&gt;</pre></p><p></p><h2>What we did in part 2</h2></p><p></p>In this last instalment, we wrote an easy-to-use function that generates img tags based on database data. We also made a search script to find the images in the database. In the last section of the article, we tried writing a real script using our newly created function.</p></p></p><p></p>If you're finished with these two parts, you've now got the following files and directories:</p></p></p><ul></p><li><code>imgtag.php</code>: the script that generates the <code>img</code> tag;</li></p><li><code>search.html</code>: the search form;</li></p><li><code>search.php</code>: the search script;</li></p><li><code>upload.html</code>: the upload form;</li></p><li><code>upload.php</code>: the upload script;</li></p><li><code>bigimage.php</code>: the pop-up script;</li></p><li><code>img.php</code>: the script that does the actual resizing;</li></p><li><code>bin/</code>: a directory containing the external conversion software;</li></p><li><code>img/</code>: the directory containing the images.</li></p></ul></p><p></p>You can also download the complete directory structure as <a href="http://gvtulder.f2o.org/evolt/img/image_complete.tar.gz" title="All files (102 kB)">a tar.gz (102 kB)</a>.</p></p>