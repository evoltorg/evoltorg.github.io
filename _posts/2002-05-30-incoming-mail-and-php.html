---
layout: post
permalink: incoming_mail_and_php
ratings: 14
avgrate: 4.2143
rating: 4.13
categories: [Backend]
user: gvtulder
real_name: "Gijs van Tulder"
user_biog: "<p>
<a href=\"http://vantulder.net/\" rel=\"nofollow\">Gijs van Tulder</a> is a Dutch student. He likes to play with all things web related and fancies himself as a part-time amateur web developer.
</p>"
user_since: 05 Feb 2002
avatar: /images/pictures/picture-20899.jpg
article_count: 7
excerpt: "We all know how to send email from PHP. Actually, it\'s quite easy: mail(&quot;to@me&quot;, &quot;Hello&quot;, &quot;Hello&quot;); Handling mail the other way, sending email to PHP is a task much more unknown. In this article, we will write and install a script that we can send an email to..."
---
<p></p>We all know how to send email <em>from</em> PHP. Actually, it's quite easy: <code>mail(&quot;to@me&quot;, &quot;Hello&quot;, &quot;Hello&quot;);</code> Handling mail the other way, sending email <em>to</em> PHP is a task much more unknown. In this article, we will write and install a script that we can send an email to.</p></p></p><p><h2>What do we want?</h2></p><p></p>We want to write and install a script that handles incoming mail. We want our script not to be reachable by a web browser, but by our email client. Sending an email to script@example.com would suffice for running our script and processing the mail.</p></p></p><p><h2>Why would we want this?</h2></p><p></p>Well, that's a stupid question, because we don't know how to do it and it's fun. You're reading evolt because you want to learn something, aren't you? But this script could be useful. For example:</p></p></p><ul></p><li>we could write our own mailing list;</li></p><li>we could send out a survey by email, that can be filled out by just clicking 'reply';</li></p><li>we could manage parts of our site by sending commands by email;</li></p><li>etc...</li></p></ul></p><p><h2>What do we need?</h2></p><p></p>Because the script is triggered by an email, we will have to take a bit of a different approach than when our script is run by someone requesting a web page. Our script has to be started by the mail system. You will need:</p></p></p><ul></p><li>PHP compiled as a <a href="http://www.php.net/install.commandline" target="_blank" title="How to compile PHP; Opens in new window">CGI binary</a>, not just as an Apache module;</li></p><li>a local mail system or <acronym title="Message Transfer Agent">MTA</acronym>, (are you using <a href="http://www.sendmail.org/" target="_ blank " title="What is Sendmail? Opens in new window">Sendmail</a>, <a href="http://www.exim.org/" target="_ blank " title="What is Exim? Opens in new window">Exim</a>, <a href="http://www.qmail.org/" target="_ blank " title="What is Qmail? Opens in new window">Qmail</a> or some other system);</li></p><li>shell access to your server, whether or not you have to be root depends on your mail system.</li></p></ul></p><p><h2>Step 1: Email to PHP</h2></p><p></p>The first thing we have to do, is tell our mail system to send all mail addressed to script@example.com to our script. How to accomplish this, depends on which mail system you use.</p></p></p><p><h3>Sendmail</h3></p><p></p>There are two different approaches for forwarding mail to a program in Sendmail. You can create a real user for our script and create a .forward file, or you can create an alias in your aliases file. If you have root access, the latter would be the best option.</p></p></p><p><p></p>If using the aliases file, this can be found in /etc, you add the following line. <code>script</code> is the email alias for our script, <code>/our/script.php</code> should be substituted with the full path to the script.</p></p></p><p><p></p><code>script: &quot; /our/script.php&quot;</code></p></p></p><p><p></p>If using a forward file, create a file named <code>.forward</code> in your home dir. Then add the following line and save the file. Email sent to you, will be forwarded to the script. If you'd also like the email sent to another address, you can add that address before the script and tailed by a comma. <code>/our/script.php</code> should be substituted with the full path to the script. </p></p></p><p><p></p><code>&quot; /our/script.php&quot;</code><br></p>or:<br></p>myemail@example.com,&quot; /our/script.php&quot;</code></p></p></p><p><p></p><strong>Watch out: if you don't add another address to your .forward file, the email is deleted after being sent to the script. You will lose your email.</strong></p></p></p><p><h3>Exim</h3></p><p></p>There are two different approaches for forwarding mail to a program in Exim. You can create a real user for our script and create a .forward file, or you can create an alias in your aliases file. If you have root access, the latter would be the best option.</p></p></p><p><p></p>If using the aliases file, this can be found in /etc, you add the following line. <code>script</code> is the email alias for our script, <code>/our/script.php</code> should be substituted with the full path to the script.</p></p></p><p><p></p><code>script:  /our/script.php</code></p></p></p><p><p></p>You also have to edit your exim.conf, found at /etc/exim.conf. Look for a part containing 'address_pipe'. If there is such a part, replace it with the text below. If there is no such text, paste this text somewhere in exim.conf. Save the file.</p></p></p><p><pre>address_pipe:</p>  driver = pipe</p>  pipe_as_creator</p></pre></p><p><p></p>If using a forward file, create a file named <code>.forward</code> in your home dir. Then add the following line and save the file. Email sent to you, will be forwarded to the script. If you'd also like the email sent to another address, you can add that address before the script and tailed by a comma. <code>/our/script.php</code> should be substituted with the full path to the script. </p></p></p><p><p></p><code> /our/script.php</code><br></p>or:<br></p><code>myemail@example.com, /our/script.php</code></p></p></p><p><p></p><strong>Watch out: if you don't add another address to your .forward file, the email is deleted after being sent to the script. You will lose your email.</strong></p></p></p><p><h3>Qmail</h3></p><p></p>There are two different approaches for forwarding mail to a program in Qmail. You can create a real user for our script and create a .qmail file, or you can create an alias. If you have root access, the latter would be the best option.</p></p></p><p><p></p>One thing I like about Qmail, is the possibility of creating custom aliases. If you are a normal user, you can create an alias by saving a file called .qmail-foo in your home directory. Email sent to yourusername-foo@example.com is then sent as specified in this file.</p></p></p><p><p></p>If you want to create just an alias, without being an user, eg. myscript@example.com, you create a .qmail file in the /var/qmail/alias directory. .qmail-myscript should do it.</p></p></p><p><p></p>Add the following to your .qmail file and save it. <code>/our/script.php</code> should be substituted with the full path to the script.</p></p></p><p><p></p><code> /our/script.php</code></p></p></p><p><h2>Step 2: The email</h2></p><p></p>Because the email is passed to the script as a raw email, it is useful to take a closer look at the structure of an email.</p></p></p><p><pre></p>Received: from gijs ([192.168.55.2])</p>	by debian with smtp (Exim 3.12 #1 (Debian))</p>	id 17AYXZ-0002BE-00</p>	for <gijs@debian>; Wed, 22 May 2002 18:00:41 +0200</p>From: &quot;Gijs van Tulder&quot; <gijs@debian></p>To: <gijs@debian></p>Subject: Test</p>Date: Wed, 22 May 2002 18:00:41 +0200</p>Message-ID: &lt;KNEOKJCOCHEDPIMPAIMIOEOJCJAA.gijs@debian&gt;</p>MIME-Version: 1.0</p>Content-Type: text/plain;</p>	charset=&quot;iso-8859-1&quot;</p>Content-Transfer-Encoding: 7bit</p>X-Priority: 3 (Normal)</p>X-MSMail-Priority: Normal</p>X-Mailer: Microsoft Outlook IMO, Build 9.0.2416 (9.0.2910.0)</p>Importance: Normal</p>X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2600.0000</p><p>This is my message.</p><p>Thank you.</p></pre></p><p><p></p>The first part of the raw email contains the headers. A header contains information about the email. The header has a name, before the colon, and a value: <code>Header-Name: Value</code>. Important headers are the Subject header, containing the subject of the email, the From header, containing the origin of the email, and the To header, which tells us something about the recipient. The other headers are of minor importance.</p></p></p><p><p></p>An empty line marks the end of the header part. After the first empty line, follows the body of the email.</p></p></p><p><h2>Step 3: The script</h2></p><p></p>Since our script will function as a shell script, the first line should contain the path to the PHP CGI program. This is most likely located at /usr/bin/php of /usr/local/bin/php. This tells the operating system that this script must be parsed by PHP.</p></p></p><p><pre></p>#!/usr/bin/php</p>&lt;?php</p></pre></p><p><p></p>The email is sent to the script through <a href="http://www.php.net/manual/en/function.fopen.php" target=";_blank"; title="Read more about stdin in PHP";>stdin</a>. This is a special 'file' that can be reached by opening <code>php://stdin</code>. We will do that now and read the email.</p></p></p><p><pre></p>// read from stdin</p>$fd = fopen(&quot;php://stdin&quot;, &quot;r&quot;);</p>$email = &quot;&quot;;</p>while (!feof($fd)) {</p>    $email .= fread($fd, 1024);</p>}</p>fclose($fd);</p></pre></p><p><p></p>Now we have the full text of the email in the <code>$email</code> variable, we can start splitting headers from body. We will do that line by line, so the first step would be splitting the email. We also empty the variables that we will fill with the From header, the Subject header, and save other information in.</p></p></p><p><pre></p>// handle email</p>$lines = explode(&quot;</p>&quot;, $email);</p><p>// empty vars</p>$from = &quot;&quot;;</p>$subject = &quot;&quot;;</p>$headers = &quot;&quot;;</p>$message = &quot;&quot;;</p>$splittingheaders = true;</p></pre></p><p><p></p>We have just set the <code>$splittingheaders</code> variable to true. As long as this variable is true, and we have not yet seen an empty line, the text should be added to <code>$headers</code>. If we find a Subject or a From header, we will save it in the appropriate variable.</p></p></p><p><p></p>After we have seen the first empty line, we have processed the headers and can start adding the lines to <code>$message</code>.</p></p></p><p><pre></p>for ($i=0; $i < count($lines); $i++) {</p>    if ($splittingheaders) {</p>        // this is a header</p>        $headers .= $lines[$i].&quot;</p>&quot;;</p><p>        // look out for special headers</p>        if (preg_match(&quot;/^Subject: (.*)/&quot;, $lines[$i], $matches)) {</p>            $subject = $matches[1];</p>        }</p>        if (preg_match(&quot;/^From: (.*)/&quot;, $lines[$i], $matches)) {</p>            $from = $matches[1];</p>        }</p>    } else {</p>        // not a header, but message</p>        $message .= $lines[$i].&quot;</p>&quot;;</p>    }</p><p>    if (trim($lines[$i])==&quot;&quot;) {</p>        // empty line, header section has ended</p>        $splittingheaders = false;</p>    }</p>}</p><p>?&gt;</p></pre></p><p><p></p>We now have the headers, the message, the From and Subject information and can save these in a database. You could also use the <code>mail()</code> function to send an automatic reply. That's up to you.</p></p></p><p><h2>Step 4: Copying</h2></p><p></p>Now you wrote and saved the script, you have to copy it to its final destination, the location you configured in your mail system. You should also make the script executable: <code>chmod 755</code> Remember: it's a shell script, not a web page.</p></p></p><p><h2>The process</h2></p><p></p>When an email arrives at the address you configured, it is piped to the script we just wrote. The script processes the headers and the message and returns is in a few useful variables. You can use this as a first building block to write your own mailing list, or do something else with it.</p></p></p><p><p></p>As usually, you can copy and paste the parts of this script, or <a href="http://gvtulder.f2o.org/evolt/mail/mail.php.txt" title="The complete script; opens in new window" target="_blank">download it as a text file</a>.</p></p>