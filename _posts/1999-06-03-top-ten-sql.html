---
layout: post
permalink: node/131
ratings: 11
avgrate: 4.3636
user: r937
real_name: "rudy limeback"
user_since: 1998-12-14
avatar: "/images/pictures/picture-20.jpg"
article_count: 12
excerpt: "What is the \"top ten\" problem?  Using SQL, how do you select only those rows that have one of the top ten values for a certain column?"
---
<p>What is the &quot;top ten&quot; problem?  Using SQL, how do you select only those rows that have one of the top ten values for a certain column?</p></p><p><p>Suppose we have a <code>SAMPLETABLE</code> of people and scores.</p></p><p>The &quot;top ten&quot; problem here is how to select the people who have the top ten scores.</p></p><p><br clear="all"></p><p><p>Here's an example:</p><table cellpadding="0" cellspacing="0" border="1"></p><tr></p>  <th align="left"><small>PERSON</small></th></p>  <th><small>SCORE</small></th></p></tr></p><tr></p>  <td><small>Tom</small></td></p>  <td align="center"><small>2</small></td></p></tr></p><tr></p>  <td><small>Dick</small></td></p>  <td align="center"><small>15</small></td></p></tr></p><tr></p>  <td><small>Harry</small></td></p>  <td align="center"><small>4</small></td></p></tr></p><tr></p>  <td><small>Winken</small></td></p>  <td align="center"><small>3</small></td></p></tr></p><tr></p>  <td><small>Blinken</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Nod</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Dopey</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Sneezy</small></td></p>  <td align="center"><small>21</small></td></p></tr></p><tr></p>  <td><small>Bashful</small></td></p>  <td align="center"><small>17</small></td></p></tr></p><tr></p>  <td><small>Doc</small></td></p>  <td align="center"><small>2</small></td></p></tr></p><tr></p>  <td><small>Dasher</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Dancer</small></td></p>  <td align="center"><small>9</small></td></p></tr></p><tr></p>  <td><small>Comet</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Cupid</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Donner</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Blitzen</small></td></p>  <td align="center"><small>13</small></td></p></tr></p></table></p><p><h3>Can't I just sort the data?</h3></p><p><p>One way to find the top ten values in a column would be to select <em>all</em> rows and bring them back sorted in descending order by that column:</p></p><p><pre></p>SELECT PERSON</p>     , SCORE</p>  FROM SAMPLETABLE</p> ORDER BY SCORE DESC</p> </pre></p> </p><table cellpadding="0" cellspacing="0" border="1" align="left" style="margin-right: 20px"></p><tr></p>  <th align="left"><small>PERSON</small></th></p>  <th><small>SCORE</small></th></p></tr></p><tr></p>  <td><small>Sneezy</small></td></p>  <td align="center"><small>21</small></td></p></tr></p><tr></p>  <td><small>Bashful</small></td></p>  <td align="center"><small>17</small></td></p></tr></p><tr></p>  <td><small>Dick</small></td></p>  <td align="center"><small>15</small></td></p></tr></p><tr></p>  <td><small>Blitzen</small></td></p>  <td align="center"><small>13</small></td></p></tr></p><tr></p>  <td><small>Blinken</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Donner</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Cupid</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Dancer</small></td></p>  <td align="center"><small>9</small></td></p></tr></p><tr></p>  <td><small>Nod</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Dopey</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Dasher</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Comet</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Harry</small></td></p>  <td align="center"><small>4</small></td></p></tr></p><tr></p>  <td><small>Winken</small></td></p>  <td align="center"><small>3</small></td></p></tr></p><tr></p>  <td><small>Tom</small></td></p>  <td align="center"><small>2</small></td></p></tr></p><tr></p>  <td><small>Doc</small></td></p>  <td align="center"><small>2</small></td></p></tr></p></table></p><p></p><p>Since the result set comes back sorted, all you need to do is use the top ten records.</p></p><p><p>Some front-end programs, like Sybase's <a href="http://www.sybase.com/products/infomaker/" target="_blank" title="opens in a new window">Infomaker</a> and Microsoft's <a href="http://www.microsoft.com/products/prodref/3_ov.htm" target="_blank" title="opens in a new window">Access</a>, allow you to specify a parameter to limit the number of rows in the result set.</p></p><p><p>In Infomaker it's called <strong>maximum number of rows retrieved</strong>, but for this discussion, we'll use the Access term, <strong>TopValues</strong>.</p><p><br clear="all"></p><p><h3>Uh oh, what about ties?</h3></p><p><p>Take another look at the sorted scores, this time with the results numbered like they do in races.</p></p><p><table cellpadding="0" cellspacing="0" border="1" align="left" style="margin-right: 20px"></p><tr></p>   <th align="left"><small>PERSON</small></th></p>   <th><small>SCORE</small></th></p>   <th style="color: #cc0000"><small>PLACE</small></th></p> </tr></p><tr></p>  <td><small>Sneezy</small></td></p>  <td align="center"><small>21</small></td></p>  <th align="right" style="color: #cc0000"><small>1st</small></th></p></tr></p><tr></p>  <td><small>Bashful</small></td></p>  <td align="center"><small>17</small></td></p>  <th  align="right" style="color: #cc0000"><small>2nd</small></th></p></tr></p><tr></p>  <td><small>Dick</small></td></p>  <td align="center"><small>15</small></td></p>  <th  align="right" style="color: #cc0000"><small>3rd</small></th></p></tr></p><tr></p>  <td><small>Blitzen</small></td></p>  <td align="center"><small>13</small></td></p>  <th  align="right" style="color: #cc0000"><small>4th</small></th></p></tr></p><tr></p>  <td><small>Blinken</small></td></p>  <td align="center"><small>11</small></td></p>  <th  align="right" style="color: #cc0000"><small>5th</small></th></p></tr></p><tr></p>  <td><small>Donner</small></td></p>  <td align="center"><small>11</small></td></p>  <th  align="right" style="color: #cc0000"><small>5th</small></th></p></tr></p><tr></p>  <td><small>Cupid</small></td></p>  <td align="center"><small>11</small></td></p>  <th  align="right" style="color: #cc0000"><small>5th</small></th></p></tr></p><tr></p>  <td><small>Dancer</small></td></p>  <td align="center"><small>9</small></td></p>  <th  align="right" style="color: #cc0000"><small>8th</small></th></p></tr></p><tr></p>  <td><small>Nod</small></td></p>  <td align="center"><small>7</small></td></p>  <th  align="right" style="color: #cc0000"><small>9th</small></th></p></tr></p><tr></p>  <td><small>Dopey</small></td></p>  <td align="center"><small>7</small></td></p>  <th  align="right" style="color: #cc0000"><small>9th</small></th></p></tr></p><tr></p>  <td><small>Dasher</small></td></p>  <td align="center"><small>7</small></td></p>  <th  align="right" style="color: #cc0000"><small>9th</small></th></p></tr></p><tr></p>  <td><small>Comet</small></td></p>  <td align="center"><small>7</small></td></p>  <th  align="right" style="color: #cc0000"><small>9th</small></th></p></tr></p><tr></p>  <td><small>Harry</small></td></p>  <td align="center"><small>4</small></td></p>  <th  align="right" style="color: #cc0000"><small>13th</small></th></p></tr></p><tr></p>  <td><small>Winken</small></td></p>  <td align="center"><small>3</small></td></p>  <th  align="right" style="color: #cc0000"><small>14th</small></th></p></tr></p><tr></p>  <td><small>Tom</small></td></p>  <td align="center"><small>2</small></td></p>  <th  align="right" style="color: #cc0000"><small>15th</small></th></p></tr></p><tr></p>  <td><small>Doc</small></td></p>  <td align="center"><small>2</small></td></p>  <th  align="right" style="color: #cc0000"><small>16th</small></th></p></tr></p></table></p><p><p>Did you notice that there are actually several people tied for 9th place?</p></p><p><p>How would you interpret the &quot;top ten&quot; problem in light of the possibility of ties across 10th place?</p></p><p><p>Most people would agree that it makes sense to include ties.</p></p><p><br clear="all"></p><p><p><small><strong>Note</strong>: No, the <code>SAMPLETABLE</code> does not contain a <code>PLACE</code> column (if it did, you could just select all rows where <code>PLACE < 10</code>, and then where would this tutorial be?). The place values are for illustrative purposes only, and no, it is <em>not</em> easy to generate <code>PLACE</code> values into a table -- that's another SQL tutorial for another day.</small></p></p><p><h3>Okay, I understand the problem -- what's the solution?</h3></p><p><h4>If you don't have a TopValues feature.....</h4></p><p><p>If your front end program doesn't have a TopValues feature, you can just select the entire table with an <code>ORDER BY</code>, then inspect the results (watching for ties), and discard all records past the place you're looking for -- or past the last of the ties.</p></p><p><p>This is a manual procedure but it's simple.</p></p><p><p>Once you have determined what the cutoff point is, you would then re-run the query with an absolute value like this:</p></p><p><pre></p>SELECT PERSON</p>     , SCORE</p>  FROM SAMPLETABLE</p> WHERE SCORE >= 7</p> ORDER BY SCORE DESC</pre></p> </p><h4>Why TopValues doesn't work well</h4></p> </p><p>If your front end program <em>does</em> have a TopValues feature, go ahead and use it -- but be sure to set it high enough to get at least one record beyond any ties for the last place you're looking for.</p></p><p><p>This, too, is a manual procedure, and here's the problem -- you may have to repeat it a few times, or turn off the TopValues feature at least once.</p></p><p><p>Why is this?</p></p><p><p>In the last example above, you would have to set TopValues to 13 in order to get past the ties for 9th place. The problem here, of course, is that you don't know in advance how high to go, whether 13 is high enough to snag all the ties across 10th place.</p></p><p><p>Imagine the case where every person has the same score, i.e. everybody is tied for first place. You would have to set TopValues to a number that is higher than the number of records in the table. With luck, you might happen to notice that the first 10 people had the same score, and realize that something was up.</p></p><p><p>In the worst case scenario, though, the top few scores are all different, but there's a tie that starts at 10th place and goes on from there. You probably wouldn't realize that you needed to increase TopValues. Therefore it's always a good idea to set it substantially higher than you need to.</p></p><p><p>This, in turn, means that even when you do use the TopValues feature, you will <em>still</em> have to inspect the results -- you have to make sure you got past any ties, and discard any records past the place you're looking for or past the last of the ties.</p></p><p><p>But with or without the TopValues feature, sorting the table is simple and efficient -- although it does require manual intervention.</p></p><p><h3>Isn't there an automated way?</h3></p><p><p>Yes, with the &quot;top ten&quot; SQL -- </p><p><pre></p>SELECT PERSON</p>     , SCORE</p>  FROM SAMPLETABLE XXX</p> WHERE 10 > (</p>   SELECT COUNT(*)</p>     FROM SAMPLETABLE</p>     WHERE SCORE > XXX.SCORE )</pre></p>     </p><p>Let's try to understand this in stages.</p></p><p><p>First, the query uses a <strong>correlated subquery</strong>. Basically, a correlated subquery is an inner query that must be evaluated for <em>each</em> row of the outer query. The <code>XXX</code> identifies the table in the outer query, so that in the subquery, the <code>XXX.SCORE</code> identifies that column as belonging to the outer query's table.</p></p><p><p>So for each row of the outer query, the subquery counts the number of rows with a larger score than that of the outer row under consideration.</p></p><p><p>If there are fewer than 10 rows with a larger score, then the outer row satisfies the outer <code>WHERE</code> clause, i.e. it's in the top ten.</p></p><p><h3>Are ties across 10th place included by the top ten SQL?</h3></p><p><p>Yes.</p></p><p><table cellpadding="0" cellspacing="0" border="1" align="left" style="margin-right: 20px"></p><tr></p>  <th align="left"><small>PERSON</small></th></p>  <th><small>SCORE</small></th></p></tr></p><tr></p>  <td><small>Sneezy</small></td></p>  <td align="center"><small>21</small></td></p></tr></p><tr></p>  <td><small>Bashful</small></td></p>  <td align="center"><small>17</small></td></p></tr></p><tr></p>  <td><small>Dick</small></td></p>  <td align="center"><small>15</small></td></p></tr></p><tr></p>  <td><small>Blitzen</small></td></p>  <td align="center"><small>13</small></td></p></tr></p><tr></p>  <td><small>Blinken</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Donner</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Cupid</small></td></p>  <td align="center"><small>11</small></td></p></tr></p><tr></p>  <td><small>Dancer</small></td></p>  <td align="center"><small>9</small></td></p></tr></p><tr></p>  <td><small>Nod</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Dopey</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Dasher</small></td></p>  <td align="center"><small>7</small></td></p></tr></p><tr></p>  <td><small>Comet</small></td></p>  <td align="center"><small>7</small></td></p></tr></p></table></p><p><p>To see why this is so, let's take Dasher as a test case.</p></p><p><p>Count the number of rows that have a score <em>greater</em> than 7, which is Dasher's score.  <p>The answer is eight rows, so Dasher must be in the top ten.</p></p><p><p>The top ten SQL automatically includes all ties across 10th place.</p></p><p><br clear="all"></p><p><h3>What about efficiency?</h3></p><p><p>Clearly, a correlated subquery could cause a performance problem -- the database has to look at all rows of a table <em>for every row</em>.</p></p><p><p>On the face of it, this looks like it will have &quot;n-squared&quot; efficiency, which means processing requirements go up by the square of the number of rows.</p></p><p><p>Thankfully, the difference is not too noticeable for tables with a modest number of rows. If your table is large and the query seems to perform poorly, try declaring a descending index on the <code>SCORE</code> column.</p></p><p><p>For very large tables, you should be on an industrial-strength database server (all of which have a built-in <strong>optimizer</strong> for situations like this).</p></p><p><h3>For further information...</h3></p><p><p>Please feel free to send your SQL questions to</p></p><p><blockquote><a href="mailto:r937@interlog.com">Rudy Limeback</a> (r937@interlog.com)</blockquote>