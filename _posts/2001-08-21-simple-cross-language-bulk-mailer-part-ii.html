---
layout: post
permalink: Simple_Cross_Language_Bulk_Mailer_Part_II
ratings: 2
avgrate: 4.0000
category: Backend
user: djc
real_name: "Daniel Cody"
user_biog: "<p>Dan lives a quiet life in the bustling city of Milwaukee, WI. Although he founded what would become evolt.org in 1998, he\'s since moved on to other projects and is now the owner of <a href=\"http://hostprogressive.com/\" title=\"Zimbra hosting, web hosting for Wisconsin\" rel=\"nofollow\">Progressive Networks, a Zimbra hosting</a> company based in Milwaukee.</p><p> His personal site can be found at <a href=\"http://dancody.org/\" title=\"Dan Cody\" rel=\"nofollow\">http://dancody.org/</a></p>"
user_since: 14 Dec 1998
avatar: ""
article_count: 146
excerpt: "In part two of a three part series on developing a simple bulk mailer application, we\'ll get started with the Cold Fusion piece of our cross-platform pie. Building on our database foundation discussed in part one, we\'ll now see our application start to take shape."
---
<h2>The Cold Fusion architecture.</h2></p><p><p></p>In<a href="http://evolt.org/article/Simple_Cross_Language_Bulk_Mailer_Part_1/18/9279/index.html" title="Part I of this article" target="_new"> the first installment</a> of this article, we got our database in place and laid out the foundation for our application. Now, let's take a peak at what the Cold Fusion end of our application will look like. <em>(Just a side note here, but I wanted to point out that my coding style may or may not be different than yours. You may scope your variables and floss your teeth differently than me, and that's cool. That's what makes us all unique little snowflakes.)</em></p></p></p><p><p></p>After working with <a href="/user/jeff/15/index.html" title="Opens in new window" target="_new">.jeff</a> for about a year and a half now on the evolt site, I've started picking up some of his coding habits, one of which is the nearly obsessive use of <code>&lt;cfinclude&gt;</code> and templates. Therefore, each of our main 'sections' will be contained within their own directory underneath the root of our application. Combined with some methods similar to the <a href="http://fusebox.org/" title="More info on fusebox (new window)" target="_new">fusebox</a> style, this allows for nice separation between all the major functions of our application. Therefore, we'll have a directory named <strong>home</strong> for our default pages, <strong>images</strong> should be self-explanatory, <strong>login</strong> will hold the files that we'll use for authentication, <strong>msg</strong> contains files relating to the sending and posting of messages, and <strong>user</strong> will pertain to things like subscribing and unsubscribing users. Now then, onto the code!</p></p></p><p><p></p><pre></p>&lt;--- our Application.cfm file ---&gt;</p>&lt;CF_fu2a&gt;</p>&lt;cfapplication name="lists" clientmanagement="no" sessionmanagement="yes" setclientcookies="yes" &gt;</p><p>&lt;--- data source name ---&gt;</p>&lt;cfparam name="data" default="lists"&gt;</p><p>&lt;cfparam name="session.loggedin" default="no"&gt;</p><p>&lt;cfparam name="url.a" default="home"&gt;</p>&lt;cfparam name="url.b" default=""&gt;</p>&lt;cfparam name="url.c" default=""&gt;</p>&lt;cfparam name="url.d" default=""&gt;</p></pre></p></p></p><p><p></p>As you can see, our Application.cfm file is fairly simple. The <code>&lt;CF_fu2a&gt;</code> declaration at the top is a highly modified</p>version of the FormURL2Attributes tag from Fusebox. We've turned on session management, set our default datasource, and declared four URL variables a, b, c, and d (named for simplicity). The <strong>session.loggedin</strong> variable is what we'll be using to authenticate people, which is set to a negative value to start.</p></p></p><p><p></p>Next, lets take a look at our 'index.cfm' and header/footer files. The 'index.cfm' page is simply a switch expression to check whether the user has been logged in yet using the <strong>session.loggedin</strong> variable, and a header/footer include.</p></p></p><p><a name="index.cfm"></a></p><p><p></p><pre></p>&lt;cfinclude template="index.cfm"&gt;</p>&lt;cfswitch expression="#session.loggedin#"&gt;</p>&lt;cfcase value="yes"&gt;</p>&lt;cfinclude template="dsp_home.cfm"&gt;</p>&lt;/cfcase&gt;</p>&lt;cfdefaultcase&gt;</p>&lt;cfinclude template="login/act_login.cfm"&gt;</p>&lt;cfinclude template="login/dsp_login.cfm"&gt;</p>&lt;/cfdefaultcase&gt;</p>&lt;/cfswitch&gt;</p><p>&lt;cfinclude template="dsp_footer.cfm"&gt;</p></pre></p></p></p><p><p></p>Just to make sure you're still following, our cfswitch statement looks at the <strong>session.loggedin</strong> variable. If it sees that the variable is set to 'yes', we get sent to 'dsp_home.cfm' - otherwise, we include the 'act_login.cfm' and the 'dsp_login.cfm' files from the login directory. Regardless of that, our application is still wrapped in a header and footer that contain basic HTML at this time. Let's follow the natural progression here and assume that we haven't logged in yet; in that case, we get shown the 'login/act_login.cfm' and 'login/dsp_login.cfm' files.</p></p></p><p><a name="dsp_login"></a></p><p><p></p><pre></p>&lt;!--- dsp_login.cfm ---&gt;</p>&lt;p&gt;</p>Welcome, please enter your list name and login:</p>&lt;/p&gt;</p>&lt;form action="/lists/index.cfm" method="post"&gt;</p><p>&lt;strong&gt; Username:&lt;/strong&gt; &lt;input type="text" name="list_name" size="15" value="#form.list_name#"&gt;&lt;br&gt;</p>&lt;strong&gt; Password:&lt;/strong&gt; &lt;input type="password" name="list_pass" size="15" value="#form.list_pass#"&gt;&lt;br&gt;</p>&lt;input type="submit" value=" Go &gt; "&gt;</p><p>&lt;/form&gt;</p></pre></p></p></p><p><p></p>A fairly simple form. We're asking the user for a list name and the password for the list they have control over. Take notice of the structure of the URL in our form action where we set the <strong>url.a</strong> variable to 'login' and the <strong>url.b</strong> variable to 'process'. Also take note that even though we included both 'act_login.cfm' and 'dsp_login.cfm', nothing from 'act_login.cfm' gets included because no <strong>url.b</strong> variable was declared yet. Therefore, the '<code>&lt;defaultcase&gt;</code>' section of our '<code>&lt;cfswitch&gt;</code>', which is empty, gets included.</p></p></p><p><a name="act_login"></a></p><p><p></p><pre></p>&lt;!--- act_login.cfm ---&gt;</p><p>&lt;cfparam name="form.list_name" default=""&gt;</p>&lt;cfparam name="form.list_pass" default=""&gt;</p>&lt;cfparam name="form.submit" default=""&gt;</p><p>&lt;cfswitch expression="#url.b#"&gt;</p>&lt;cfcase value="process"&gt;</p>&lt;cfquery name="checklogin" datasource="#data#"&gt;</p>select * from lists</p>where list_name = '#trim(form.list_name)#'</p>and list_passwd = '#trim(form.list_pass)#'</p>&lt;/cfquery&gt;</p><p>&lt;cfif checklogin.recordcount&gt;</p><p>&lt;cfset session.loggedin="yes"&gt;</p>&lt;cfset session.list_id="#checklogin.list_id#"&gt;</p>&lt;cfset session.list_email="#checklogin.list_email#"&gt;</p>&lt;cfset session.list_name="#checklogin.list_name#"&gt;</p><p>&lt;cflocation url="/lists" addtoken="no"&gt;</p>&lt;cfelse&gt;</p>&lt;cflocation url="/lists/index.cfm/a/login/b/error" addtoken="no"&gt;</p>&lt;/cfif&gt;</p><p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="error"&gt;</p>&lt;strong&gt;Sorry, there was an error signing you in, please try again.&lt;/strong&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="logout"&gt;</p>&lt;cfset session.loggedin="no"&gt;</p>&lt;cfset session.list_id=""&gt;</p><p>&lt;cflocation url="/lists/index.cfm"&gt;</p>&lt;/cfcase&gt;</p>&lt;cfdefaultcase&gt;</p><p>&lt;/cfdefaultcase&gt;</p><p>&lt;/cfswitch&gt;</p></pre></p></p></p><p><p></p>Let's explain what is going on in <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_login">'act_login.cfm'</a>. We're setting a cfswitch on the <strong>url.b</strong> variable, which we declared in our Application.cfm to have no value. However, the form we just submitted set the <strong>url.b</strong> variable to 'process'. The cfswitch</p>catches that, and runs a simple query on the submitted information against the <strong>lists</strong> table from our database. If both the username</p>and the password match (hence a recordset is returned), we set the <strong>session.loggedin</strong> variable to 'yes', <strong>session.list_id</strong></p>to the <strong>list_id</strong> associated with the username and password we entered, the <strong>session.list_email</strong> and <strong>session.list_name</strong> also get set to their respective values from the lists table in the database. Finally, we redirect ourselves back to the front page of our application with the '<code>&lt;cflocation url="/lists" addtoken="no"&gt;</code>' line. If no records are returned from the database, we pretty much</p>redirect ourselves back to this page with the '<code>&lt;cflocation url="/lists/index.cfm/a/login/b/error" addtoken="no"&gt;</code>' line, but this time</p>we set the <strong>url.b</strong> variable to 'error'. We come back to this page (because of the includes) but now the cfswitch will tell us there was an error with our login. The cool thing, in my opinion, about doing it this way is the <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#dsp_login">'dsp_login.cfm'</a> page still gets displayed, but</p>there's an error message from this page that gets included letting the user know they entered incorrect information. Lastly, we include an option for a 'logout' variable that will kill our session and return us to the main page.</p></p></p><p><p></p><em>Whew!</em></p></p></p><p><p></p>I know that's a lot to digest in one sitting, so take this opportunity to grab a cold drink and stretch those tendons! .....</p></p></p><p><p></p>So, let's just do a quick recap here to make sure I'm not losing anyone. We did a check on the <strong>session.loggedin</strong> variable to verify if we were authenticated. Since we had set that variable to 'no' in our Application.cfm, we were not authenticated and were sent to the login section of the site. If we entered the correct list name and password, we set the <strong>session.loggedin</strong> variable to 'yes' and redirected ourselves back to the front page, otherwise we gave a small error, leave the <strong>session.loggedin</strong> variable set to 'no' and display the authentication form again.</p></p></p><p><h2>Moving past the authentication.</h2></p><p><p></p>If you'll recall from our index.cfm page above, once the <strong>session.loggedin</strong> variable was set to yes, we were passed on to the 'dsp_home.cfm' template.</p></p></p><p><a name="dsp_home"></a></p><p><p></p><pre></p>&lt;!--- dsp_home.cfm ---&gt;</p><p>&lt;cfswitch expression="#url.a#"&gt;</p>&lt;cfcase value="user"&gt;</p>&lt;cfinclude template="user/act_user.cfm"&gt;</p>&lt;cfinclude template="user/dsp_user.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="info"&gt;</p>&lt;cfinclude template="info/dsp_info.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="login"&gt;</p>&lt;cfinclude template="login/act_login.cfm"&gt;</p>&lt;cfinclude template="login/dsp_login.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="msg"&gt;</p>&lt;cfinclude template="msg/act_msg.cfm"&gt;</p>&lt;cfinclude template="msg/dsp_msg.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfdefaultcase&gt;</p>&lt;cfinclude template="home/act_home.cfm"&gt;</p>&lt;cfinclude template="home/dsp_home.cfm"&gt;</p>&lt;/cfdefaultcase&gt;</p><p>&lt;/cfswitch&gt;</p></pre></p></p></p><p><p></p>You guessed it, another huge '<code>&lt;cfswitch&gt;</code>' statement! This time though, we're assessing the value of the <strong>url.a</strong> variable which we gave a default value of 'home' in our Application.cfm file. At the end of our authentication file ('<a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#dsp_login">dsp_login.cfm</a>') you'll remember we didn't pass any URL variables when we used to the '<code>&lt;cflocation&gt;</code>' tag to redirect ourselves. Therefore, we slide right into the</p>'<code>&lt;defaultcase&gt;</code>' section of the '<code>&lt;cfswitch&gt;</code>' which again, leads us to a set of templates, this time in the home directory.</p></p></p><p><a name="act_home"></a></p><p><p></p><pre></p>&lt;!--- act_home.cfm ---&gt;</p><p>&lt;cfswitch expression="#url.b#"&gt;</p>&lt;cfcase value="info"&gt;</p>&lt;cfquery name="listinfo" datasource="#data#"&gt;</p>select * from lists where</p>list_id = "#session.list_id#"</p>&lt;/cfquery&gt;</p>&lt;/cfcase&gt;</p>&lt;cfdefaultcase&gt;</p>&lt;cfquery name="gethomeinfo" datasource="#data#"&gt;</p>select list_name, list_id, list_email, list_desc</p>from lists</p>where</p>list_id = '#session.list_id#'</p>&lt;/cfquery&gt;</p>&lt;/cfdefaultcase&gt;</p>&lt;/cfswitch&gt;</p></pre></p></p></p><p><p></p>Again, a '<code>&lt;cfswitch&gt;</code>' on the <strong>url.b</strong> variable. Since we haven't yet defined that variable, we slide into the '<code>&lt;defaultcase&gt;</code>' section that runs a simple query that grabs some values from the lists table based on the <strong>session.list_id</strong> variable which was set when we logged in. The other template Cold Fusion was told to process is the 'dsp_home.cfm' file from the 'home' directory.</p></p></p><p><a name="dsp_home2"></a></p><p><p></p><pre></p>&lt;!--- dsp_home.cfm ---&gt;</p><p>&lt;cfswitch expression="#url.b#"&gt;</p><p>&lt;cfcase value="info"&gt;</p>&lt;cfinclude template="act_home.cfm"&gt;</p>&lt;cfinclude template="dsp_info.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfdefaultcase&gt;</p>&lt;table width="100%" cellpadding="4" cellspacing="4" border="0"&gt;</p>&lt;tr&gt;</p>&lt;td width="5%" align="left" valign="top"&gt;</p>&nbsp;</p>&lt;/td&gt;</p>&lt;td align="left" valign="top"&gt;</p>&lt;cfoutput query="gethomeinfo"&gt;</p>&lt;p&gt;</p>Welcome to &lt;strong&gt;#list_name#&lt;/strong&gt;! All email will appear to come from &lt;strong&gt;#list_email#&lt;/strong&gt;.&lt;br&gt;</p>Please select from the list of options on the left.</p>&lt;/p&gt;</p>&lt;/cfoutput&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;/table&gt;</p>&lt;/cfdefaultcase&gt;</p>&lt;/cfswitch&gt;</p></pre></p></p></p><p><p></p>Once again, no <strong>url.b</strong> variable is currently defined, so we process what is in the '<code>&lt;cfdefaultcase&gt;</code>' tag which <em>finally</em> gives us an option to perform an action. We also grab some information from the 'gethomeinfo' query that we performed in <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_home">'act_home.cfm'</a> above to just re-affirm to the user the name and email address of their list. You'll notice in the code above that it states you can 'select from a list of options on the left'. These options are static links in our 'dsp_header.cfm' file and now that we have a minute to get our bearings,</p>let's take a look at the header file we've been using this whole time.</p></p></p><p><a name="dsp_header"></a></p><p><p></p><pre></p>&lt;-- dsp_header.cfm # --&gt;</p>&lt;HTML&gt;</p>&lt;HEAD&gt;</p>&lt;TITLE&gt;Mailing List Administration&lt;/TITLE&gt;</p>&lt;/HEAD&gt;</p>&lt;BODY BGCOLOR="#FFFFFF" LINK="#003300" VLINK="#336666" ALINK="#CC6600"&gt;</p>&lt;table border="0" cellspacing="0" cellpadding="0"&gt;</p>&lt;tr&gt;</p>&lt;td valign="top" align="left" width="20%"&gt;</p>&nbsp;</p>&lt;/td&gt;</p><p>&lt;TD VALIGN="TOP" ALIGN="left" colspan="2"&gt;</p>&lt;IMG SRC="/lists/images/head_admin.gif" WIDTH="479" HEIGHT="47" BORDER="0"&gt;</p>&lt;/TD&gt;</p>&lt;/tr&gt;</p>&lt;/table&gt;</p>&lt;table border="0" cellspacing="0" cellpadding="0"&gt;</p>&lt;tr&gt;</p>&lt;cfif session.loggedin eq "yes"&gt;</p>&lt;td valign="TOP" align="left" width="138"&gt;</p>&lt;A HREF="/lists/index.cfm/a/msg"&gt;Send&lt;/A&gt;&lt;BR&gt;</p>&lt;A HREF="/lists/index.cfm/a/user"&gt;Who's on my list&lt;/A&gt;&lt;BR&gt;</p>&lt;A HREF="/lists/index.cfm/a/user/b/sub"&gt;Subscribe a new user&lt;/A&gt;&lt;BR&gt;</p>&lt;A HREF="/lists/index.cfm/a/user/b/unsub"&gt;Unsubscribe an existing user&lt;/A&gt;&lt;BR&gt;</p>&lt;A HREF="/lists/index.cfm/a/home/b/info"&gt;Get info on your list&lt;/A&gt;&lt;BR&gt;</p>&lt;A HREF="/lists/index.cfm/a/login/b/logout"&gt;Log out&lt;/A&gt;&lt;BR&gt;</p>&lt;/td&gt;</p>&lt;/cfif&gt;</p>&lt;TD ALIGN="left" VALIGN="top"&gt;</p>&lt;!-- # end dsp_header.cfm # --&gt;</p></pre></p></p></p><p><p></p>Nothing special here other than a couple of options which we give our user to interact with their list. Do take notice though of how I set the URL variables for each of the options statically. Again, this is just my preference, and will get us by for this simple bulk emailer. Obviously you could change the HTML formatting here quite a bit to suit your own tastes.</p></p></p><p><p></p>In our application, we have the ability to send a message to our list, see who's on our list, subscribe and unsubscribe people, get basic information on our list, and lastly, logout. We'll go through each of these functions starting with our main feature, sending email.</p></p></p><p><h2>Sending email.</h2></p><p><p></p>So, we're finally ready to send out email! First, let's summarize:</p></p></p><p><ul></p><li>When we click on the 'Send' link as shown in <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#dsp_header">'dsp_header.cfm'</a> above, the <strong>url.a</strong> variable will get set to 'msg'.</li></p><li>We have <strong>session.list_id</strong>, <strong>session.list_name</strong>, and <strong>session.list_email</strong> all defined with</p>their respective values and sitting in the 'session' variable scope.</li></p><li>We're good enough, we're smart enough, and doggone it, people like us!</li></p></ul></p><p><p></p>Now that we've had our daily affirmation, let's continue!</p></p></p><p><p></p>Because the <strong>url.a</strong> variable is now set to 'msg', our initial <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#dsp_home">'dsp_home.cfm'</a> file up towards the top of this article includes the 'act_msg.cfm' and 'dsp_msg.cfm' templates in the msg directory. You can probably start sensing the pattern here of including two files;</p>one for processing and one for displaying it's particular section of our application. Here's the 'act_msg.cfm' template:</p></p></p><p><a name="act_msg"></a></p><p><p></p><pre></p>&lt;!--- act_msg.cfm ---&gt;</p><p>&lt;cfswitch expression="#url.b#"&gt;</p>&lt;cfcase value="post"&gt;</p>&lt;cfquery name="insertmsg" datasource="#data#"&gt;</p>insert into messages ( msg_from_id, msg_body, msg_date, msg_list_id)</p>values ('#form.msg_from_id#', '#form.msg_body#', '#form.msg_date#', '#form.msg_list_id#')</p>&lt;/cfquery&gt;</p>&lt;cfquery name="getemails" datasource="#data#"&gt;</p>select member_email, member_id, member_subscribed, member_subscribedto</p>list_id, list_email from members, lists</p>where</p>member_subscribedto = '#form.msg_list_id#'</p>and</p>list_id = member_subscribedto</p>and member_subscribed = '1'</p>&lt;/cfquery&gt;</p>&lt;cfmail query="getemails" to="#member_email#" from="#getemails.list_email#" Subject="#form.msg_subject#"&gt;</p>#form.msg_body#</p><p>&lt;/cfmail&gt;</p><p>&lt;cflocation url="/lists/index.cfm/a/msg/b/thanks" addtoken="no"&gt;</p><p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="preview"&gt;</p>&lt;cfquery name="showpreview" datasource="#data#"&gt;</p>select * from lists where list_id = '#session.list_id#'</p>&lt;/cfquery&gt;</p>&lt;/cfcase&gt;</p>&lt;cfdefaultcase&gt;</p><p>&lt;/cfdefaultcase&gt;</p>&lt;/cfswitch&gt;</p></pre></p></p></p><p><p></p>As you're more than likely getting used to by now, we're performing a <code>&lt;cfswitch&gt;</code> on the <strong>url.b</strong> variable, this time grepping for the 'post' and 'preview' values. When this template sees the <strong>url.b</strong> variable set to 'post' it's going to insert the message into the database and get the addresses of the people who are subscribed to the list (based on what our <strong>'session.list_id'</strong> is). If the <strong>url.b</strong> variable is set to 'preview', the template only performs a single query. By default, this template does nothing, so let's see how we get those <strong>url.b</strong> variables</p>assigned to a value in the 'dsp_msg.cfm' template.</p></p></p><p><a name="dsp_msg"></a></p><p><p></p><pre></p>&lt;!--- dsp_msg.cfm ---&gt;</p><p>&lt;cfswitch expression="#url.b#"&gt;</p>&lt;cfcase value="post"&gt;</p>&lt;cfinclude template="act_msg.cfm"&gt;</p>&lt;cfinclude template="dsp_post.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="preview"&gt;</p>&lt;cfinclude template="act_msg.cfm"&gt;</p>&lt;cfinclude template="dsp_preview.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfcase value="thanks"&gt;</p>&lt;cfinclude template="dsp_post.cfm"&gt;</p>&lt;/cfcase&gt;</p><p>&lt;cfdefaultcase&gt;</p>&lt;table width="100%" cellpadding="4" cellspacing="4" border="0"&gt;</p>&lt;tr&gt;</p>&lt;td width="5%" align="left" valign="top"&gt;</p>&nbsp;</p>&lt;/td&gt;</p>&lt;td align="left" valign="top"&gt;</p>&lt;p&gt;Either type or cut & paste your message and subject in the box below. Hit the send button to send the message to your users.&lt;/p&gt;</p>&lt;form action="/lists/index.cfm/a/msg/b/preview" method="post"&gt;</p>&lt;table width="50%" cellpadding="4" cellspacing="2" border="0"&gt;</p>&lt;tr bgcolor="#ffffff"&gt;</p>&lt;td align="left" valign="top"&gt;</p>&lt;p&gt;</p>&lt;strong&gt;Subject:&lt;/strong&gt;&lt;br&gt;&lt;input type="text" name="msg_subject" size="30"&gt;</p>&lt;/p&gt;</p>&lt;p&gt;</p>&lt;strong&gt;Message:&lt;/strong&gt;&lt;br&gt;</p>&lt;input type="hidden" name="list_id" value="&lt;cfoutput&gt;#session.list_id#&lt;/cfoutput&gt;"&gt;</p>&lt;textarea wrap="virtual" cols="60" rows="15" name="msg_body" class="main"&gt; &lt;/textarea&gt;</p>&lt;/p&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td align="right" valign="top"&gt;</p>&lt;input type="submit" value=" Preview! "&gt;</p>&lt;/td&gt;</p>&lt;/form&gt;</p>&lt;/table&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;/table&gt;</p>&lt;/cfdefaultcase&gt;</p>&lt;/cfswitch&gt;</p></pre></p></p></p><p><p></p>Ok, now we're obviously getting a bit more complex. Let's try to make sense of it all. The <strong>url.b</strong> variable is still not defined, so we process the information within the '<code>&lt;cfdefaultcase&gt;</code>' tag which displays instructions on how to write the email and two form fields for the information to go. These are the Subject(msg_subject) and the Body(msg_body) pieces of our email, so nothing too crazy there. After the user submits this information, you'll notice it doesn't get sent to the mail server right away, but rather we want the user to preview their message first to correct any typos and give it 'the once over' before sending it out. Finally, we set the <strong>url.b</strong> variable to 'preview' but keep the <strong>url.a</strong> variable to 'msg'. This means that we pretty much get sent back to this page, but the <code>&lt;cfswitch&gt;</code> catches the <strong>url.b</strong> variable and includes the <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_msg">'act_msg.cfm'</a> template above and the <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#dsp_preview">'dsp_preview.cfm'</a> template which simply reformats the message in a manner somewhat similar to how it might look in an email client.</p></p></p><p><p></p>I just want to take a minute here to explain why the hell I'm <em>re</em>-including the 'act_msg.cfm' template since a couple of people I know have gotten mixed up right about here. Because the 'act_msg.cfm' template does a '<code>&lt;cfswitch&gt;</code>' on the <strong>url.b</strong> variable, we can use one template to do many different things. Some people may prefer to break up every piece of the application into strictly separate templates, and as I said before, that's cool - just not how I prefer to do things. This way may seem harder and you might not grasp it at first but once you get used to it, it's really quite slick and efficient. Like I said, we're all unique little snowflakes.</p></p></p><p><p></p>So, once the user fills in the form with a Body and Subject and hits the 'Preview!' button, they're whisked right back to this same template page but this time the '<code>&lt;cfswitch&gt;</code>' picks up the 'preview' value for the <strong>url.b</strong> variable and displays the 'dsp_preview.cfm' template</p>instead of the information inside the '<code>&lt;cfdefaultcase&gt;</code>' tag. The 'dsp_preview.cfm' page is quite simple, and looks like this:</p></p></p><p><a name="dsp_preview"></a></p><p><p></p><pre></p>&lt;!--- dsp_preview.cfm ---&gt;</p><p>&lt;table width="100%" cellpadding="4" cellspacing="4" border="0"&gt;</p>&lt;tr&gt;</p>&lt;td width="5%" align="left" valign="top"&gt;</p>&nbsp;</p>&lt;/td&gt;</p>&lt;td align="left" valign="top"&gt;</p>&lt;p&gt;</p>Here is a preview of how your message will look:</p>&lt;/p&gt;</p>&lt;table width="100%" cellpadding="4" cellspacing="4" border="0"&gt;</p>&lt;cfoutput query="showpreview"&gt;</p>&lt;tr&gt;</p>&lt;td class="code" align="left" valign="top"&gt;</p>&lt;strong&gt;To: &lt;em&gt;yourusers&lt;/em&gt;&lt;/strong&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td class="side" align="left" valign="top"&gt;</p>&lt;strong&gt;From:&lt;/strong&gt; &lt;em&gt;#list_name# &lt;#list_email#&gt;&lt;/em&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td class="code" align="left" valign="top"&gt;</p>&lt;strong&gt;Subject:&lt;/strong&gt;&lt;em&gt;#form.msg_subject#&lt;/em&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td class="side" align="left" valign="top"&gt;</p>&lt;strong&gt;Date:&lt;/strong&gt; #dateformat(now(), "DDD MMM dd yyyy")#&lt;/em&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td class="code" align="left" valign="top"&gt;</p>&lt;strong&gt;Message:&lt;/strong&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td class="main" align="left" valign="top"&gt;</p>#paragraphformat(form.msg_body)#</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;/cfoutput&gt;</p>&lt;/table&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;tr&gt;</p>&lt;td width="5%" align="left" valign="top"&gt;</p>&nbsp;</p>&lt;/td&gt;</p>&lt;td width="50%" align="left" valign="top"&gt;</p>&lt;p&gt;&lt;hr noshade&gt;&lt;br&gt;</p>If you'd like to post this to all your members, hit the &lt;strong&gt;send&lt;/strong&gt; button! Otherwise, use the '&lt;em&gt;back&lt;/em&gt;' button</p>on your browser to edit this message again.&lt;br&gt;</p>&lt;form action="/lists/index.cfm/a/msg/b/post" method="post"&gt;</p>&lt;cfoutput&gt;</p>&lt;input type="hidden" name="msg_list_id" value="#session.list_id#"&gt;</p>&lt;input type="hidden" name="msg_subject" value="#trim(form.msg_subject)#"&gt;</p>&lt;input type="hidden" name="msg_from" value="#trim(showpreview.list_name)#"&gt;</p>&lt;input type="hidden" name="msg_date" value="#dateformat(now(), "mm/dd/yyyy")#"&gt;</p>&lt;input type="hidden" name="msg_from_id" value="#showpreview.list_admin_id#"&gt;</p>&lt;input type="hidden" name="msg_body" value="#trim(form.msg_body)#"&gt;</p>&lt;input type="submit" value="Send!"&gt;</p>&lt;/cfoutput&gt;</p>&lt;/form&gt;&lt;/p&gt;</p>&lt;/td&gt;</p>&lt;/tr&gt;</p>&lt;/table&gt;</p></pre></p></p></p><p><p></p>As you can see, we simply take the <strong>form.msg_subject</strong> and <strong>form.msg_body</strong> fields that the user entered and display them in a format that's easy on the eyes. We also grab all other list variables from the query in <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_msg">'act_msg.cfm'</a> (<em>Because since the <strong>url.b</strong> variable was now 'preview' in that template, a simple query was run that got all list information based on the <strong>session.list_id</strong> variable ... starting to make sense now!</em>) and stuff everything inside hidden form fields at the bottom of the template. Assuming the user likes what they see, they click on the 'Send!' button which whisks all our hidden form variables <strong>back</strong> to the <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#dsp_msg">'dsp_msg.cfm'</a> template, this time with a <strong>url.b</strong> value of 'post'.</p></p></p><p><p></p>Same as with the 'preview' function now, the '<code>&lt;cfswitch&gt;</code>' in 'dsp_msg.cfm' greps our 'post' value for <strong>url.b</strong> and includes</p>the <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_msg">'act_msg.cfm'</a> template (again) and the 'dsp_post.cfm' template. The 'dsp_post.cfm' template is nothing more than a file with 'Your post has been sent!' in it. All the magic this time happens in the <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_msg">'act_msg.cfm'</a> file as you can see above. Specifically, all the hidden form fields get inserted into the 'messages' table of the database for safekeeping based on the <strong>'session.list_id'</strong> variable. An email gets built using CFMail with the 'To:' fields of the email filled in by doing a query on all records in the 'members' table that match our hidden <strong>form.msg_list_id</strong> field. This allows us to have multiple bulk mailing lists each with their own separate set of members. Hopefully you're starting to see the big picture here! Take <a href="/Simple_Cross_Language_Bulk_Mailer_Part_II#act_msg">another look</a> at the 'act_msg.cfm' template if you like to make sure everything makes sense.</p></p></p><p><p></p>Hopefully you're starting to see the method to my madness! Based on what we've covered today, you should be able to send an email to a group of people through our web based interface. Managing that list of people by subscribing them and unsubscribing them will be covered in the next installment of this article, which you'll hopefully be looking forward to! Please feel free to leave any comments, suggestions, or requests for clarification in the comment section below :)</p></p></p><p></body></p></html>