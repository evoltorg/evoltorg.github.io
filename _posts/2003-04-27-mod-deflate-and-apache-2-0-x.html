---
layout: post
permalink: mod_deflate_and_Apache_2
ratings: 3
avgrate: 4.0000
user: spierzchala
real_name: "Stephen Pierzchala"
user_since: 13 Mar 2003
avatar: "/images/pictures/picture-60160.jpg"
article_count: 1
excerpt: "Content Compression can be cheap and easy when you use mod_deflate in the new Apache 2.0.x"
---
<p>In a <a href="http://www.webcompression.org/gzip-compress.html" target="_blank">previous paper</a>, the use of <i>mod_gzip</i> to dynamically compress the output from an Apache server was described. With the growing use of the Apache 2.0.x family of Web servers, the question arises of how to perform a similar GZIP-encoding function within this server. The developers of the Apache 2.0.x servers have included a module in the codebase for the server to perform just this task.</p></p><p><p><code>mod_deflate</code> is included in the Apache 2.0.x source package, and compiling it in is a simple matter of adding it to the configure command.</p></p><p><pre></p>./configure --enable-modules=all --enable-mods-shared=all --enable-deflate</p></pre></p><p><p>When the server is made and installed, the GZIP-encoding of documents can be enabled in one of two ways: explicit exclusion of files by extension; or by explcit inclusion of files by MIME type. These methods are specified in the httpd.conf file.</p></p><p><h2>Explicit Exclusion</h2></p><pre></p>SetOutputFilter DEFLATE</p>DeflateFilterNote ratio</p>SetEnvIfNoCase Request_URI \.(?:gif jpe?g png)$ no-gzip dont-vary</p>SetEnvIfNoCase Request_URI \.(?:exe t?gz zip bz2 sit rar)$ no-gzip dont-vary</p>SetEnvIfNoCase Request_URI \.pdf$ no-gzip dont-vary</p></pre></p><p><h2>Explicit Inclusion</h2></p><pre></p>DeflateFilterNote ratio</p>AddOutputFilterByType DEFLATE text/*</p>AddOutputFilterByType DEFLATE application/ms* application/vnd* application/postscript</p></pre></p><p><p>Both methods enable the automatic GZIP-encoding of all MIME-types, except image and PDF files, as they leave the server. Image files and PDF files are excluded as they are already in a highly compressed format. In fact, PDFs become unreadable by Adobe's Acrobat Reader if they are further compressed by mod_deflate or mod_gzip.</p></p><p><p>On the server used for testing mod_deflate for this article, no Windows executables or compressed files are served to visitors. However, for safety's sake, please ensure that compressed files and binaries are <em>not</em> GZIP-encoded by your Web server application.</p></p><p><p>For the file-types indicated in the exclude statements, the server is told explicitly not to send the <code>Vary</code> header. The Vary header indicates to any proxy or cache server which particular condition(s) will cause this response to Vary from other responses to the same request.</p></p><p><p>If a client sends a request which does not include the <code>Accept-Encoding: gzip</code> header, then the item which is stored in the cache cannot be returned to the requesting client if the Accept-Encoding headers do not match. The request must then be passed directly to the origin server to obtain a non-encoded version. In effect, proxy servers may store 2 or more copies of the same file, depending on the client request conditions which cause the server response to Vary.</p></p><p><p>Removing the Vary response requirement for objects not handled means that if the objects do not vary due to any other directives on the server (browser type, for example), then the cached object can be served up without any additional requests until the <code>Time-To-Live</code> (<acronym title="Time To Live">TTL</acronym>) of the cached object has expired.</p></p><p><p>In examing the performance of mod_deflate against mod_gzip, the one item that seems to distinguish mod_deflate from mod_gzip is the compression algorithm used. The mod_deflate algorithm uses the ZLIB compression library and the functions in this library do not seem to be as effective at compressing files in real time as the GZIP functions used for mod_gzip. The examples below demonstrate that the compression algorithm for mod_gzip produces between 4-6% more compression than mod_deflate for the same file.<a href="/mod_deflate_and_Apache_2#1" class="light">[1]</a></p></p><p><h2>Table 1 &mdash; /compress/homepage2.html</h2></p><table class="data" cellspacing="0"></p><tr><th width="30%">Compression</th><th width="30%">Server</th><th width="20%" align="right">Size</th><th width="20%" align="right">Compression %</td></tr></p><tr><td>No compression</td><td>http://www.pierzchala.com/</td><td align="right">56380 bytes</td><td align="right">n/a</td></tr></p><tr><td>Apache 1.3.x/mod_gzip</td><td>http://www.pierzchala.com:9280/</td><td align="right">16333 bytes</td><td align="right">29% of original</td></tr></p><tr><td>Apache 2.0.x/mod_deflate</td><td>http://www.pierzchala.com/</td><td align="right">19898 bytes</td><td align="right">35% of original</td></tr></p></table></p><p><h2>Table 2 &mdash; /documents/spierzchala-resume.ps</h2></p><p><table class="data" cellspacing="0"></p><tr><th width="30%">Compression</th><th width="30%">Server</th><th width="20%" align="right">Size</th><th width="20%" align="right">Compression %</th></tr></p><tr><td >No Compression</td><td >http://www.pierzchala.com/</td><td  align="right">63451 bytes</td><td  align="right">n/a</td></tr></p><tr><td >Apache 1.3.x/mod_gzip</td><td >http://www.pierzchala.com:9280/</td><td  align="right">19758 bytes</td><td  align="right">31% of original</td></tr></p><tr><td >Apache 2.0.x/mod_deflate</td><td >http://www.pierzchala.com/</td><td  align="right">23407 bytes</td><td  align="right">37% of original</td></tr></p></table>	</p><p><p>Attempts to increase the compression ratio of mod_deflate using the directives provided for this module produced no further decrease in transferred file size. A comment from one of the authors mod_deflate states that the module was written specifically to ensure that server performance was not degraded by using this compression method. With future releases of this module, the authors of mod_deflate may want to compare their algorithm to the one used in mod_gzip to see if there are ways to improve the achieved compression ratio in mod_deflate without compromising server performance.</p></p><p><p>Despite the fact that the compression algorithm is not as effective as the one found in mod_gzip, using mod_deflate for Apache 2.0.x is still a quick and effective way to decrease the size of the files that sent to clients. Anything that can produce between 50% and 80% in bandwidth savings with so little effort should definitely be considered for any and all Apache 2.0.x deployments wishing to use the default Apache codebase.</p></p><p></p><h2>A note on the compression in mod_deflate:<a name="1">[1]</a></h2> </p><p>The level of compression can be modified by changing the ZLIB compression setting in <code>mod_deflate.c</code> from <code>Z_BEST_SPEED</code> (equivalent to "gzip -1") to <code>Z_BEST_COMPRESSION</code> (equivalent to "gzip -9"). These defaults can also be replaced with a numeric value between 1 and 9. A "hacked" version of the mod_deflate.c code is available <a href="http://www.webcompression.org/mod_deflate.txt" target="_blank">here</a>; the compression level has been set to "6", which is regarded as a good balance between speed and compression.</p></p><p>More info on hacking mod_deflate for Apache 2.0.x can be found <a href="http://www.webcompression.org/mod_deflate-hack.php" target="_blank">here</a>.</p>