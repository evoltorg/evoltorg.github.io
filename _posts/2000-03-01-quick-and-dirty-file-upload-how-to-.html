---
layout: post
permalink: node/1238
ratings: 1
avgrate: 5.0000
user: AnthonyB
real_name: "Anthony Baratta"
user_since: 1999-07-10
avatar: "/images/pictures/picture-140.jpg"
article_count: 12
excerpt: "Quick and Dirty File Uploads via Form How To:Uploading files is a semi-complex process </p>                involving the right incantations on both the client forms and the server - but it can be tamed."
---
<P>Uploading files is a semi-complex process involving the right incantations on both the client forms and the server - but it can be tamed. Here's a quick over view of what you need to have to accept file uploads.</p></p><P>Example "simple" upload form...</p></p><code></p><pre></p>&lt;form name=&quot;UploadForm&quot; method=&quot;post&quot; action=&quot;./file.cgi&quot;</p>      enctype=&quot;multipart/form-data&quot; &gt; </p><p>&lt;INPUT TYPE=FILE NAME=&quot;FileName1&quot; VALUE=&quot;&quot;&gt;</p>&lt;INPUT TYPE=SUBMIT NAME=&quot;Upload&quot; VALUE=&quot;Upload File&quot;&gt;</p>&lt;/form&gt;    </p></pre></p></code></p><p></p><dl></p>	</p>    <dt></p>        <strong>REQ 1</strong></p>    </dt>    </p>        <dd></p>           <p></p>           You must be using a browser and server that supports HTTP 1.1 (Apache 1.3.x </p>           and IIS 4.0. 3.x Netscape and above and 3.02? IE and above). Note that the </p>           upload form needs a enctype. For file uploads you need</p>     </p>           <p><code>multipart/form-data.</code></p>    </p>        </dd></p>    <dt></p>        <strong>REQ 2</strong></p>    </dt></p>         <dd></p>            <p></p>            It's best that you use a CGI library like cgi-lib.pl or CGI.pm to assist you in </p>            uploading files. These libraries can help you limit the file sizes and upload </p>            locations as well as other niceties that will make the process </p>            easier.</p></p><p>            <dl></p>            	<dt>CGI-LIB</dt></p>                   <dd><A HREF="http://cgi-lib.stanford.edu/cgi-lib/">    </p>                                http://cgi-lib.stanford.edu/cgi-lib/</A></p>                   </dd></p>                <dt>CGI.PM</dt></p>                    <dd><A HREF="http://stein.cshl.org/software/WWW/CGI/"></p>                        http://stein.cshl.org/software/WWW/CGI/</A>     </p>                    </dd></p>            </dl></p>            <p>I'm partial to cgi-lib because its a smaller library and I only currently use the </p>            upload and form parsing functions. But both libraries are very good.</p></p>        </dd></p>            </p>    <dt></p>        <strong>REQ 3</strong></p>    </dt></p>         <dd></p>            <p>An understanding that you are allowing anonymous (unless the upload area </p>            is password protected) people to upload files to your server. Make sure you </p>            write code that chmod's the files to 666 or some other type of readable but </p>            not executable form. Check for .cgi , .pl for extensions and strip them off. </p>            Look for shebangs in the first line of all files - remove them or quarantine </p>            them. Also, people have the potential to upload malicious HTML pages and </p>            other 'tainted' stuff.</p></p>          </dd></p>     <dt></p>         <strong>REQ 4</strong></p>     </dt></p>         <dd></p>            Be paranoid. God is always building a better idiot.</p>         </dd></p></dl></p><p><P>After constructing the proper form, everything else is set within the CGI program. With cgi-lib.pl you have the following variables that can be set to control the upload process: (There are more than these variables that can be set - read the library's documentation to ferret out all the other options.)</p></p></p><code></p><pre></p># Spool the files to the ______ directory</p># (directory needs to be 777)</p>$cgi_lib::writefiles = &quot;/full/path/to/upload/dir&quot;;</p><p># Limit upload size </p>$cgi_lib::maxdata = 50000000; </p># set to 50 megs;</p></pre></p></code></p><p><p>The Upload directory is a &quot;temp&quot; location and the files are given unique names by the web server 23455.1 for file number one and 23455.2 for file number two (if you are doing multi-uploads). You are then responsible for getting the temp files renamed and put in their proper locations.</p></p><p><P>By parsing the form you can glean all the info you need to rename the files back to their original names. Cgi-Lib.pl uses the following parse function:</p></p><p><code></p><pre></p># Reading and pare the data.  Save the return value to $ret</p># Pass references to retrieve the data, the filenames,</p># and the content-type</p>$ret = &amp;ReadParse(\%cgi_data,\%cgi_cfn,\%cgi_ct,\%cgi_sfn);</p></pre></p></code></p><p></p>Where:  </p></p></p><p><UL></p>    <li><strong><P>%cgi_data</strong> - is the form data sent (for files is the full temp path and name on server)</li></p>    <li><strong>%cgi_cfn</strong> - is the common (original) file name (full path, may need to be truncated)</li></p>    <li><strong>%cgi_ct</strong> - is the content-type of the file (not always accurate)</li></p>    <li><strong>%cgi_sfn</strong> - is the just temp name of the file (no path) as given by the server</li></p></UL></p><p><P>For example:</p></p><code></p><pre></p><p>&lt;FORM NAME=UPLOADFORM ENCTYPE=&quot;multipart/form-data&quot; </p>          ACTION=&quot;/cgi-bin/upload.cgi&quot; METHOD=&quot;POST&gt;</p>&lt;INPUT TYPE=&quot;file&quot; NAME=&quot;File1&quot;&gt; # User puts in: c:\autoexec.bat</p>&lt;INPUT TYPE=&quot;file&quot; NAME=&quot;File2&quot;&gt; # User puts in: c:\config.sys</p>&lt;INPUT TYPE=&quot;file&quot; NAME=&quot;File3&quot;&gt; # User puts in: c:\bootlog.txt</p>&lt;INPUT TYPE=&quot;text&quot; NAME=&quot;UserName&quot;&gt; # User puts in: Howdy Doody</p>&lt;INPUT TYPE=&quot;SUBMIT&quot; NAME=&quot;SUBMIT&quot;&gt;</p>&lt;/FORM&gt;</p></pre></p></code></p><p><h3>** upload.cgi **</h3>    </p><p><code></p><pre></p>#!/usr/bin/perl</p>require 5.001;</p>require &quot;cgi-lib.pl&quot;;</p><p># Spool the files to the ______ directory</p># (directory needs to be 777)</p>$cgi_lib::writefiles = &quot;/tmp/uploads&quot;;</p><p># Limit upload size </p>$cgi_lib::maxdata = 50;  </p><p># set to 50k ;</p><p>$ret = &amp;ReadParse(\%cgi_data,\%cgi_cfn,\%cgi_ct,\%cgi_sfn);</p></pre></p></code></p>    </p><p>** You would now have the following info...</p></p><p></p>    <code></p>        $cgi_data{'UserName'} = &quot;Howdy Doody&quot;<br></p>        $cgi_data{'File1'} = &quot;/tmp/uploads/2343235.1&quot;<br></p>        $cgi_cfn{'File1'} = &quot;c:\autoexec.bat&quot;<br></p>        $cgi_ct{'File1'} = &quot;text/plain&quot;<br></p>        $cgi_sfn{'File1'} = &quot;2343235.1&quot;</p>    </code></p></p></p><p></p>    <code></p>        $cgi_data{'File2'} = &quot;/tmp/uploads/2343235.2&quot;<br></p>        $cgi_cfn{'File2'} = &quot;c:\config.sys&quot;<br></p>        $cgi_ct{'File2'} = &quot;text/plain&quot;<br></p>        $cgi_sfn{'File2'} = &quot;2343235.2&quot;</p>    </code></p></p></p><p><p></p>    <code></p>        $cgi_data{'File3'} = &quot;/tmp/uploads/2343235.3&quot;<br></p>        $cgi_cfn{'File3'} = &quot;c:\bootlog.txt&quot;<br></p>        $cgi_ct{'File3'} = &quot;text/plain&quot;<br></p>        $cgi_sfn{'File3'} = &quot;2343235.3&quot;</p>    </code></p></p></p>      </p><p>                Hope this helps. Good Luck.    </p>