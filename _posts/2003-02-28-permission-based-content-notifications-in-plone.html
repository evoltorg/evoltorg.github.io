---
layout: post
permalink: node/57758
ratings: 3
avgrate: 5.0000
categories: [Site Development]
user: MartinB
real_name: "Martin Burns"
user_biog: "<p>Martin Burns has been doing this stuff since <a href=\"http://news.com.com/Netscape+bowed%2C+but+not+broken/2100-1032_3-5406682.html\" rel=\"nofollow\">Netscape 1.0</a> days. Starting with the communication ends that online media support, he moved back through design, HTML and server-side code. Then he got into running the whole show.
These days he\'s working for <a href=\"http://www-5.ibm.com/services/uk/services/bcs.html\" rel=\"nofollow\">these people</a> as a Project Manager, and still thinks (nearly 6 years on) it\'s a hell of a lot better than working for a dot-com. In his Copious Free Time&trade;, he helps out running a <a href=\"http://www.purpur.co.uk/shop/\" rel=\"nofollow\">Cloth Nappies</a> online store.
</p>

<p>Amongst his favourite things is <del><strike><a href=\"http://www.zope.org/\" rel=\"nofollow\" target=\"_foo\" title=\"Opens in a new window\">Zope</a></strike></del><ins><a href=\"http://drupal.org\" rel=\"nofollow\">Drupal</a></ins>, which he uses to run his <a href=\"http://www.easyweb.co.uk/\" rel=\"nofollow\" target=\"_foo\" title=\"Opens in a new window\">personal site</a>. He\'s starting to (re)gain a sneaking regard for ECMAscript since the arrival of unobtrusive scripting.</p> 

<p>He\'s been a member of evolt.org since the very early days, a board member, a president, a writer and even contributed a modest amount of template code for the current site. Above all, he likes evolt.org to do things because it knowingly chooses to do so, rather than randomly stumbling into them. He\'s also one of the boys and girls who beervolts in the UK, although the arrival of small children in his life have knocked the frequency for 6.</p>

<p><strong>Most likely to ask:</strong> <q>Why would a client pay you to do that?</q></p>
<p><strong>Least likely to ask:</strong> <q>Why isn\'t that navigation frame in Flash?</q></p>"
user_since: 26 Apr 1999
avatar: /images/pictures/picture-32.jpg
article_count: 143
excerpt: "Many sites need to be able to announce new content to their registered users. Wouldn\'t it be good if they did so only when the users have given them permission to do so and the content was genuinely of interest to each recipient? Here\'s a system for doing just that, using the Plone/Zope ..."
---
<p></p>    A common requirement of sites with registered users or members is to be able</p>    to email different groups of members with information that might be of interest</p>    or use to them.</p></p></p><p></p>    This might be with notifications of new content, matching users'</p>    preferences and interests, or it could be more generic <q>send an email to</p>    all of such-and-such a group</q> business requirement. In either case,</p>    you'll probably be interested in respecting the </p>    <a href="http://www.amazon.com/exec/obidos/tg/detail/-/0684856360/evolt-0220">permissions</a></p>    your users have given you to contact them.</p></p></p><p></p>    This will always mean only sending emails to people who have given you</p>    permission to do so, and often matching the emails to people whose interest</p>    you know matches the thing you want to send.</p></p></p><p></p>    Because you're running your site professionally (you are, right?), you'll</p>    also want to send emails as part of a workflow. This means that only appropriate</p>    people will have the rights to send email, and you'll have an audit trail</p>    of who sent what, when. That way, if you get complaints of spam, you can</p>    quickly find out the facts (<q>You gave us permission to do it and have</p>    an interest in the subject,</q> or otherwise) and respond appropriately.</p></p></p><h2>Business Requirements</h2></p><p></p>    For a system which announces new content on a site, our system </p>    requirements are basically:</p></p></p><ol></p>    <li></p>        To be able to send email to registered users of the site.</p>    </li></p>    <li></p>        To enable users to give and retract permission for you to email them,</p>        and for your email dispatch to respect that permission.</p>    </li></p>    <li></p>        To enable users to register areas of interest, and for your email dispatch</p>        to only send email to users who are interested in areas which relate to</p>        what you propose to send.</p>    </li></p>    <li></p>        To have emails only sent out when the content is signed off for dispatch.</p>    </li></p>    <li></p>        To have the email contain </p>        <ol type="a"></p>           <li>A standard short message</li></p>            <li>A paragraph of content-specific text </p>            (this will be a synopsis of the content, and is an existing data </p>            field in our content schema)</li></p>            <li>A link to the content</li></p>        </ol></p>    </li></p>    <li></p>        To have the person who sends the announcement (the actor in the</p>        workflow transition, in UML-speak) receive a notification of who the</p>        email announcement went to.</p>    </li></p>    </p></ol></p><p><p></p>    We <em>could</em> have a requirement that emails are sent on a schedule,</p>    and pick up all new content published in the last <code>n</code> hours.</p>    But for simplicity, that's not how I've chosen to do it. The normal thing</p>    to say here is that that's <a href="http://www.jargon.net/jargonfile/e/exerciseleftasan.html" </p>    target="_blank" title="Opens in a new window">left as an exercise</a> to the</p>    reader.</p></p></p><p><h2>System</h2></p><p></p>    The system I'll use to demonstrate this is </p>    <a href="http://www.plone.org/" target="_blank" title="Opens in a new window">Plone</a> -</p>    a <a href="http://www.zope.org" target="_blank" title="Opens in a new window">Zope</a>-based CMS</p>    which provides a rich API that provides hooks for adding user data elements</p>    and state &amp transition workflow scripting, making all of the following </p>    extremely simple.</p></p></p><p></p>    I'm not going to cover installing Zope, Plone, or Plone sites here - there's</p>    some reasonable <a href="http://plone.org/documentation/book/2" target="_blank" </p>    title="Opens in a new window">install documentation </a>on the Plone site, </p>    with some handy all-in-one <a href="http://plone.org/download" target="_blank" </p>    title="Opens in a new window">installers </a>for Windows &amp; Mac OSX.</p></p></p><p></p>    This <em>should</em> also work on basic <a href="http://cmf.zope.org/" </p>    target="_blank" title="Opens in a new window">CMF</a>, but is untested on</p>    that platform. <span lang="lt">Caveat Emptor</span>.</p></p></p><p><h2>Data Requirements</h2></p><p></p>    The basis of the solution is (pseudo-code):</p></p></p><p></p>    <code>If <strong>user</strong> has <strong>emailPermission</strong> and</p>    <strong>userInterest(any)</strong> matches <strong>contentKeyword(any)</strong></p>    then <strong>sendEmail</strong></p>    </code></p></p></p><p></p>    Therefore, there are four key pieces of data:</p></p></p><h3>Content Data</h3></p><ol></p>	<li></p>        <strong>Metadata Keywords</strong><br></p>        Plone provides this out of the box, with a light</p>        <a href="http://dublincore.org/" target="_blank" </p>        title="Opens in a new window">Dublin Core</a> implementation.</p>    </li></p></ol></p><h3>User Data</h3></p><ol start="2"></p>    <li></p>        <strong>Email Address</strong><br></p>        Self-evidently, you need this. It's an existing user attribute in</p>        Plone, and is already required.</p>    </li></p>    <li></p>        <strong>Email Permission</strong><br></p>        This is a simple user-settable boolean flag to say that the user grants permission</p>        to you to send them relevant email. Plone does not provide this out of</p>        the box, so we'll need to add it. We <em>could</em> use the <code>Listed</code></p>        user property, but it's less confusing to keep them separate, and gives</p>        the user better control over their preferences.</p>    </li></p>    <li></p>        <strong>User Interests</strong><br></p>        This is a list data-type, each element being an area that the user</p>        is interested in. If it's not there, they're not interested.</p>    </li></p></ol></p><h2>Implementation</h2></p><p><h3>Adding User Data Elements</h3></p><p></p>    Adding data elements to users in Plone is pretty simple (unlike adding elements</p>    to content, which is a whole other story). Plone keeps its user data schema in the </p>    <code>portal_memberdata</code> tool. In the <abbr title="Zope Management Interface">ZMI</abbr>,</p>    navigate to there, and select the <code>Properties</code> tab. This will give</p>    you a list of the currently available user properties, and their default</p>    values.</p></p></p><p></p>    You need to add two new properties (all values is case-sensitive):</p></p></p><table class="data"  cellspacing="0"></p>    <tr></p>        <th>Property Name</th></p>        <th>Property Type</th></p>        <th>Default Value</th></p>    </tr></p>    <tr></p>        <td>interest</td></p>        <td>lines</td></p>        <td>null</td></p>    </tr></p>    <tr></p>        <td>emailPermission</td></p>        <td>boolean</td></p>        <td>false (ie unchecked)</td></p>    </tr></p></table></p><p></p>    The result is that all current users, and all new users, will have no</p>    interests registered, and have not granted you permission to email them.</p>    This is A Good Thing, as your emails will now be opt-in.</p></p></p><p><h3>Enabling Data Entry</h3></p><p></p>    It's no use having data elements on each user data object if the users can't</p>    enter data into the waiting slots. So we need to customise the standard</p>    Plone form that users use to personalise their experience. This form can</p>    be found at <code>/portal_skins/plone_forms/personalize_form</code>. </p></p>    </p><p>    </p>    If you're not used to customising CMF/Plone sites, you'll be worried that it's</p>    not editable. This is because it's looking at your server's file system (which</p>    Zope won't write to) for the data for this folder. To enable editing, you</p>    need to transfer the HTML file to the <code>/portal_skins/custom</code></p>    folder, where you can edit it. There's a handy button on the locked form</p>    page, labelled <code>Customize</code>. Push it... you can now edit the form.</p>    How and why this works is beyond the scope of this article. For now, accept</p>    that it just does.</p></p></p><p></p>    Once you've hit 'Customize', you'll find the HTML in a normal text-area</p>    form field. Again, don't worry that it appears not to have any of your</p>    site template in. The CMS is picking the main content out and inserting it into</p>    a template slot.</p></p></p><h4>Enabling emailPermission Selection</h4></p><p><p></p>    Grab the HTML and drop it into your favourite HTML editor. Look for <code>div</code>s</p>    labelled thusly:</p></p></p><pre></p>&lt;div class=&quot;row&quot;&gt;</p>    &lt;div class=&quot;label&quot;&gt;</p>        &lt;span i18n:translate=&quot;label_listed_status&quot;&gt;Listed status&lt;/span&gt;</p><p>        &lt;div id=&quot;listed_status_help&quot;</p>             i18n:translate=&quot;help_listed_status&quot; </p>             class=&quot;help&quot; </p>             style=&quot;visibility:hidden&quot;&gt;</p>        Select whether you want to be listed on the public membership listing</p>        or not.	Remember that your Member folder will still be publicly accessible unless</p>        you change its security settings, even if you select 'unlisted' here.</p>        &lt;/div&gt;                </p>    &lt;/div&gt;</p>    &lt;div class=&quot;field&quot;</p>       tal:define=&quot;listed python:request.get('listed', member.listed);</p>                     tabindex tabindex/next;&quot;&gt;</p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;listed&quot; </p>               value=&quot;on&quot;</p>               id=&quot;cb_listed&quot; </p>               checked=&quot;checked&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('listed_status_help',1)&quot; </p>               onblur=&quot;formtooltip('listed_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;listed&quot; </p>               /&gt;</p>               </p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;listed&quot; </p>               value=&quot;on&quot;</p>               id=&quot;cb_listed&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('listed_status_help',1)&quot; </p>               onblur=&quot;formtooltip('listed_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;not: listed&quot; </p>               /&gt;</p>        </p>        &lt;label for=&quot;cb_listed&quot; i18n:translate=&quot;label_member_listed&quot;&gt;Listed&lt;/label&gt;</p>        </p>        &lt;br /&gt;</p>        </p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;listed&quot; </p>               value=&quot;&quot;</p>               id=&quot;cb_unlisted&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('listed_status_help',1)&quot; </p>               onblur=&quot;formtooltip('listed_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;listed&quot; </p>               /&gt;</p>        </p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;listed&quot; </p>               value=&quot;&quot;</p>               id=&quot;cb_unlisted&quot; </p>               checked=&quot;checked&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('listed_status_help',1)&quot; </p>               onblur=&quot;formtooltip('listed_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;not: listed &quot; </p>               /&gt;		   </p>        </p>        &lt;label for=&quot;cb_unlisted&quot; i18n:translate=&quot;label_member_unlisted&quot;&gt;Unlisted&lt;/label&gt;</p>    &lt;/div&gt;</p>&lt;/div&gt;</p><p></pre></p><p><p></p>    (The indentation isn't significant, just useful)</p></p></p><p></p>    This is the field for the <code>Listed</code> field. We're going to crib </p>    it somewhat to produce radio buttons that give the user an opt-in/out </p>    mechanism, selecting and deselecting the <code>emailPermission</code></p>    data element. </p></p></p><p></p>    Let's unpack that a bit.</p></p></p><p></p>    <code>&lt;div class=&quot;row&quot;&gt;</code></p></p></p><p></p>    Each field is enclosed within a div with this class</p></p></p><p></p>    <code></p>&lt;div&nbsp;class=&quot;label&quot;&gt;<br></p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;i18n:translate=&quot;label_listed_status&quot;&gt;Listed&nbsp;status&lt;/span&gt;</p>     </code></p></p></p><p></p>    The <code>label</code> class encapsulates both the field label and the dHTML</p>    tooltip. There's also support for auto-translation, but if you're using this,</p>    for your own fields, you'll need to add your own translations for the new</p>    content</p></p></p><p></p><code></p>&lt;div&nbsp;class=&quot;field&quot;<br></p>&nbsp;&nbsp;&nbsp;tal:define=&quot;listed&nbsp;python:request.get('listed',&nbsp;member.listed);</p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tabindex&nbsp;tabindex/next;&quot;&gt;</p></code></p></p></p><p></p>    Now we're into <a href="http://www.devshed.com/Server_Side/Zope/ZPTBasics" </p>    target="_blank" title="Opens in a new window">Zope Page Templating</a>. We're</p>    setting variables with scope of this div, and the key one is getting the </p>    <code>listed</code> property out of this user's data.</p></p></p><p></p>    Next up, we have a couple of radio buttons. Actually, we have code for</p>    two pairs of radio buttons, but there's some conditionalising going on,</p>    so only the ones which apply to the current state appear and have the appropriate</p>    selection data. Here's the button to make the user unlisted, with non-significant</p>    values removed:</p></p></p><pre></p>&lt;input type=&quot;radio&quot; </p>       name=&quot;listed&quot; </p>       value=&quot;on&quot;</p>       checked=&quot;checked&quot;</p>       tal:condition=&quot;listed&quot; </p>       /&gt;</p>&lt;input type=&quot;radio&quot; </p>       name=&quot;listed&quot; </p>       value=&quot;on&quot;</p>       tal:condition=&quot;not: listed&quot; </p>       /&gt;                   </p></pre></p><p><p></p>    We have a checked button which only appears if the member's <code>listing</code></p>    property is set, and an unchecked one which only appears if the property is</p>    not set. For the other radio button, the values are reversed.</p></p></p><p></p>    With all this knowledge, it should be fairly simple to construct our own</p>    radio button form field. Simply replace all references to <code>listed</code></p>    with <code>emailPermission</code> (ie the data element name you added to</p>    the member), and reword the labelling. Here's my code - I've also added</p>    some more explanatory text as it's a sensitive issue:</p></p></p><p><pre></p>&lt;div class=&quot;row&quot;&gt;</p>    &lt;div class=&quot;label&quot;&gt;</p>        Contact Permission</p>        &lt;div id=&quot;permission_status_help&quot;</p>             i18n:translate=&quot;help_emailPermission_status&quot; </p>             class=&quot;help&quot; </p>             style=&quot;visibility:hidden&quot;&gt;</p>        Select whether you want us to send you relevant information</p>by email. </p>        &lt;/div&gt;                </p>    &lt;/div&gt;</p>    &lt;div style=&quot;margin:0px;&quot;&gt;</p>        We would like to send you email, announcing new content that's relevant</p>        to your interests. Please select whether we have your permission to do this.</p>    &lt;/div&gt;</p>    &lt;div class=&quot;field&quot;</p>       tal:define=&quot;emailPermission python:request.get('emailPermission', member.emailPermission);</p>                     tabindex tabindex/next;&quot;&gt;</p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;emailPermission&quot; </p>               value=&quot;on&quot;</p>               id=&quot;cb_emailPermission&quot; </p>               checked=&quot;checked&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('permission_status_help',1)&quot; </p>               onblur=&quot;formtooltip('permission_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;emailPermission&quot; </p>               /&gt;</p>               </p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;emailPermission&quot; </p>               value=&quot;on&quot;</p>               id=&quot;cb_emailPermission&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('emailPermission_status_help',1)&quot; </p>               onblur=&quot;formtooltip('emailPermission_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;not: emailPermission&quot; </p>               /&gt;</p>        </p>        &lt;label for=&quot;cb_emailPermission&quot; i18n:translate=&quot;label_member_emailPermission&quot;&gt;You may send alerts by email&lt;/label&gt;</p>        </p>        &lt;br /&gt;</p>        </p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;emailPermission&quot; </p>               value=&quot;&quot;</p>               id=&quot;cb_not_emailPermission&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('emailPermission_status_help',1)&quot; </p>               onblur=&quot;formtooltip('emailPermission_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;emailPermission&quot; </p>               /&gt;</p>        </p>        &lt;input type=&quot;radio&quot; </p>               class=&quot;noborder&quot; </p>               name=&quot;emailPermission&quot; </p>               value=&quot;&quot;</p>               id=&quot;cb_not_emailPermission&quot; </p>               checked=&quot;checked&quot;</p>               tabindex=&quot;&quot;</p>               onfocus=&quot;formtooltip('emailPermission_status_help',1)&quot; </p>               onblur=&quot;formtooltip('emailPermission_status_help',0)&quot;</p>               tal:attributes=&quot;tabindex tabindex;&quot; </p>               tal:condition=&quot;not: emailPermission &quot; </p>               /&gt;		   </p>        </p>        &lt;label for=&quot;cb_not_emailPermission&quot;&gt;You may &lt;em&gt;not&lt;/em&gt; send alerts by email&lt;/label&gt;</p>    &lt;/div&gt;</p>&lt;/div&gt;</p></pre></p><p></p>    Drop this in a suitable place in your customised form and test that your selection</p>    saves in your member data and is retrieved when you reload the form. I also</p>    added a customised <code>member_search_results</code> page to let me inspect</p>    all the member data while I was testing - you may find this useful too for</p>    diagnostics.</p></p></p><p></p><h4>Enabling the Member Interest Selection</h4></p><p></p>    We're going to let members select their interests by means of checkboxes. This</p>    is a bit harder than radio buttons as we don't have existing form code to</p>    copy, but knowing how to retrieve data values, it's not hard.</p></p></p><p></p>    Remember that the selections are going to end up as a list data type? Zope</p>    is going to help you out in a big way here. Zope has a wonderful shortcut</p>    to constructing list data - if you label your fields as:</p>    <code>name=&quot;foo:list&quot;</code></p>    Zope will auto-magically bundle all the data together and make it available</p>    as a list called <code>foo</code>. Neat, eh?</p></p></p><p></p>    So all we have to do to save the data is make sure that all our checkboxes</p>    are named <code>interest:list</code> and when we submit, we'll get a list</p>    saved in the member's <code>interest</code> data element.</p></p></p><p></p>    Retrieving the data is also pretty simple. We're using a basic Python list</p>    function for testing whether a value is a member of a list, and if it</p>    is, we're writing in the <code>checked</code> attribute. I've only shown</p>    three checkboxes, but you can have as many as you like in your own layout.</p>    As long as they're within the <code>&lt;div&gt;</code>, it'll work fine.</p></p></p><pre></p>&lt;div class=&quot;row&quot;&gt;</p>    &lt;div class=&quot;label&quot;&gt;Areas of Interest&lt;/div&gt;</p>    &lt;div class=&quot;field&quot;</p>         tal:define=&quot;interestAreas&nbsp;python:request.get('interestAreas', member.interest)&quot;&gt;</p>        &lt;input type=&quot;checkbox&quot; </p>               name=&quot;interest:list&quot; </p>               value=&quot;advertising_promotion&quot; </p>               tal:attributes=&quot;checked python:test('advertising_promotion' in interestAreas, 'checked', '')&quot; /&gt;</p>               Advertising &amp; Promotion</p>        &lt;input type=&quot;checkbox&quot; </p>               name=&quot;interest:list&quot; </p>               value=&quot;brand_marketing&quot;</p>               tal:attributes=&quot;checked python:test('brand_marketing' in interestAreas, 'checked', '')&quot; /&gt;</p>               Brand Marketing</p>        &lt;input type=&quot;checkbox&quot; </p>               name=&quot;interest:list&quot; </p>               value=&quot;category_development&quot;</p>               tal:attributes=&quot;checked python:test('category_development' in interestAreas, 'checked', '')&quot; /&gt;</p>               Category Development</p>    &lt;/div&gt;</p>&lt;/div&gt;</p></pre></p><h3>Enabling the Content Metadata</h3></p><p></p>    This bit's really easy. Just take keywords you used in the checkboxes above</p>    and add them to the content, either through the <code>properties</code></p>    tab when viewing Plone, or via the <code>portal_metadata</code> tool in</p>    the ZMI.</p></p></p><p></p>    Note that these have to be <strong>exactly the field values</strong> you</p>    used for the checkboxes. An easy mistake is to use the field labels.</p></p></p><p><h3>Workflow Scripting</h3></p><p></p>    Now that all the data's in place, we're on the home straight. All we need</p>    to do is add a script that compares the content and user data, checks that</p>    a member has given us permission to email them and fire off a few emails.</p></p></p><p></p>    We'll do this in the standard workflow tool, which is the bundled</p>    <a href="http://www.zope.org/Members/hathawsh/DCWorkflow_docs" target="_blank" name="Opens in a new window">DCWorkflow</a></p>    product. This is a '<a href="http://www.evolt.org/article/The_ABCs_of_CMS/20/24182/index.html" </p>    name="eli's excellent introduction">states-and-transitions</a>' type of workflow.</p>    You set up states that a content object can be in - with permissions attached</p>    to each state - and define transitions between those states. DCWorkflow </p>    also lets you apply scripts to execute before and/or after each transition,</p>    which is what we need.</p></p></p><p></p>    Rather than simply adding a script to an existing transition, we're going</p>    to add a new state and transition specifically for email announcement. This</p>    will ensure that sending announcements is logged in the standard workflow</p>    audit trail, so we know whether a piece of content has been announced, and</p>    if so, when.</p></p></p><h4>Adding a Workflow State</h4></p><p></p>    Go to the <code>portal_workflow</code> tool in the ZMI and select the Contents</p>    tab. This will give you the workflows that your site is currently using.</p>    Unless you've done any customisation already, you'll have 2: a folder</p>    workflow and a Plone workflow. The Plone workflow is the default one which</p>    controls most normal content, so it's this one we'll be editing.</p></p></p><p></p>    Select that workflow and head to the States tab. Add a state called <code>announced</code>.</p>    This is the destination state that the content will be in after the emails</p>    have been sent. Set the permissions to a duplicate of the Published</p>    state. You need to make sure that your email recipients can view the</p>    content that you're announcing, so you'll want to set <code>View</code> and</p>    <code>Access Contents Information</code> permissions for</p>    Anonymous and Authenticated users, and once the content's announced, you</p>    don't want it being edited without further workflow, so only give the</p>    Manager role the permission of <code>Modify Portal Content</code>.</p></p></p><p></p>    Next, select which transitions Announced content can then undergo. Again,</p>    I'd duplicate the Published state, and only permit the <code>Reject</code></p>    and <code>Retract</code> transitions.</p></p></p><p><h4>Adding a Workflow Transition</h4></p><p></p>    Back up to the Plone Workflow, and select the Transitions tab and add a</p>    new transition called 'announce'. The important properties to set are</p>    that there's a role guard - only the Manager role should be able to</p>    send email announcements - and in the 'Display in actions' box fields</p>    have a sensible name (eg <q>Announce by email</q>) and the category 'workflow'.</p>    Also make sure that the destination state is 'announced' and that the trigger</p>    is a user action. We'll add a workflow script after the script is set up.</p></p></p><p><h4></p>    Enabling the transition</p></h4></p><p></p>    Site managers will only be able to use the new transition if it's enabled</p>    as a permitted transition from an existing state. Go to the published state</p>    and add the 'announce' transition to the possible transitions available from</p>    the published state.</p></p></p><p><h4>Adding a Workflow Script</h4></p><p><p></p>    Workflow scripts can be Python scripts, page templates, DTML documents or</p>    any other executable content you can add via the ZMI. We're going to use</p>    a Python script, so go to the workflow's Script tab and add a new script </p>    called <code>email_announce</code>.</p></p></p><p></p>    This will take one parameter, <code>review_state</code> (which refers to</p>    the transition currently underway). Here's the script. Note that as with </p>    all Python coding, the indenting <em>is</em> significant.</p></p></p><pre></p>#This script has been designed to send email to cmf users with appropriate</p>#preferences. The script should be used in conjunction with the workflow tool.  </p>#parameters review_state</p><p># Set up a empty list of email addresses</p># loop through the portal membership, pass memberId to check for</p># Member role. If successful, check to see if the member has given</p># permission to send email, and an area of business interest that </p># coincides with a content keyword. If successful, append the </p># list of email addresses and send them email</p><p># Get the content object we're publishing</p>contentObject = review_state.object</p><p># A nifty little function, which checks to see whether there are any elements</p># that match between two lists, and returns the number of matches. Result: if</p># the function returns 'true', you've got a match</p>def isIn(list1, list2):</p>     y=0</p>     for x in list1:</p>         if x in list2:</p>             y += 1</p>     return y</p><p># Start with an empty list</p>mailList=[]</p><p># Iterate through all the site's users</p>for item in context.portal_membership.listMembers():</p>    memberId = item.id</p>    </p>    # Remember that a real name is not mandatory, so fall back to the username</p>    if item.fullname:</p>        memberName = item.fullname</p>    else:</p>        memberName = memberId</p>    </p>    # Get a list of this member's interests...</p>    memberInterests = item.interest</p>    # ...and another that's the keywords of this object</p>    contentKeywords = contentObject.subject</p>    </p>    # Check to see if there's a match between the two</p>    isInterestedIn = isIn(memberInterests, contentKeywords)</p>    </p>    # This is the key condition:</p>    # If the user has the Member role and</p>    #             we have an email address and</p>    #             the user's interested in this content and</p>    #             we have permission to email them</p>    if 'Member' in context.portal_membership.getMemberById(memberId).getRoles() and (item.email !='') and isInterestedIn and item.emailPermission:</p>        # add them to the list of people we're emailing</p>        mailList.append(item.email)</p>        # check that we can send email via the Zope standard Mail Host</p>        try:</p>           mailhost=getattr(context, context.portal_url.superValues('Mail Host')[0].id)</p>        except:</p>           raise AttributeError, &quot;Cannot find a Mail Host object&quot;</p>       </p>        # Let's write an email:</p>        mMsg = 'Dear ' + memberName + ',</p><p>'</p>        mMsg += 'We thought you\'d be interested in hearing about:</p>'</p>        mMsg += contentObject.TitleOrId() + '</p><p>'</p>        mMsg += 'Description: </p>' + contentObject.Description() + '</p><p>'</p>        mMsg += 'More info at:</p>' + contentObject.absolute_url() + '</p>'</p>        mTo = item.email</p>        mFrom = 'you@yoursite.com'</p>        mSubj = 'New Content available'</p><p>        # and send it</p>        mailhost.send(mMsg, mTo, mFrom, mSubj)</p><p># The change in indentation signals the end of the loop, so we've</p># now sent all the emails. Let's now send a confirmation that we've done it.</p><p># We'll be building the email as a string again, but we have to convert our</p># list data elements into a string before we can append the information</p>recipients = string.join(mailList, sep='</p>')</p>keywordsString = string.join(contentKeywords, sep='</p>')</p><p>mTo = 'you@yourdomain.com'</p>mMsg = 'The following people were sent a link to</p>'</p>mMsg += contentObject.absolute_url() + '</p><p>'</p>mMsg += recipients + '</p><p>'</p>mMsg += 'The keywords were:</p>' + keywordsString</p>mSubj = 'Content announcement email confirmation'</p>mailhost.send(mMsg, mTo, mFrom, mSubj)</p></pre></p><p><p></p>    Once you have the script set up, go back to your announce transition</p>    and select it in the 'before transition' slot - that way, you'll only</p>    complete the transition if the email all gets sent.</p></p></p><p><h2>Summary</h2></p><p></p>    That looks a lot, but it's not that much really. What we've done is:</p></p></p><ol></p>    <li>Added a boolean email permission field to user data</li></p>    <li>Added a list-type area of interest field to user data</li></p>    <li>Amended the personalisation form so that users can store their preferences in the new fields</li></p>    <li>Added appropriate keywords to content</li></p>    <li>Added a new workflow state and transition to the workflow</li></p>    <li>Added a script to select suitable members and send them email announcing the new content</li></p></ol></p><p><p></p>    With a bit of modification, this could be modified to allow the content</p>    metadata to also be matched against user roles, which would help the site management</p>    define user groups in addition to user self-selection.</p></p>