---
layout: post
permalink: node/4415
ratings: 4
avgrate: 4.5000
category: Code
user: MartinB
real_name: "Martin Burns"
user_biog: "<p>Martin Burns has been doing this stuff since <a href=\"http://news.com.com/Netscape+bowed%2C+but+not+broken/2100-1032_3-5406682.html\" rel=\"nofollow\">Netscape 1.0</a> days. Starting with the communication ends that online media support, he moved back through design, HTML and server-side code. Then he got into running the whole show.
These days he\'s working for <a href=\"http://www-5.ibm.com/services/uk/services/bcs.html\" rel=\"nofollow\">these people</a> as a Project Manager, and still thinks (nearly 6 years on) it\'s a hell of a lot better than working for a dot-com. In his Copious Free Time&trade;, he helps out running a <a href=\"http://www.purpur.co.uk/shop/\" rel=\"nofollow\">Cloth Nappies</a> online store.
</p>

<p>Amongst his favourite things is <del><strike><a href=\"http://www.zope.org/\" rel=\"nofollow\" target=\"_foo\" title=\"Opens in a new window\">Zope</a></strike></del><ins><a href=\"http://drupal.org\" rel=\"nofollow\">Drupal</a></ins>, which he uses to run his <a href=\"http://www.easyweb.co.uk/\" rel=\"nofollow\" target=\"_foo\" title=\"Opens in a new window\">personal site</a>. He\'s starting to (re)gain a sneaking regard for ECMAscript since the arrival of unobtrusive scripting.</p> 

<p>He\'s been a member of evolt.org since the very early days, a board member, a president, a writer and even contributed a modest amount of template code for the current site. Above all, he likes evolt.org to do things because it knowingly chooses to do so, rather than randomly stumbling into them. He\'s also one of the boys and girls who beervolts in the UK, although the arrival of small children in his life have knocked the frequency for 6.</p>

<p><strong>Most likely to ask:</strong> <q>Why would a client pay you to do that?</q></p>
<p><strong>Least likely to ask:</strong> <q>Why isn\'t that navigation frame in Flash?</q></p>"
user_since: 26 Apr 1999
avatar: "/images/pictures/picture-32.jpg"
article_count: 143
excerpt: "This is a Perl/CGI/Apache/Unix version of Aardvark\'s previous ASP/IIS/NT code to enable users to change the size of the font they see on your site."
---
<p></p>    <a href="http://www.easyweb.co.uk/" title="Opens in new window" target="_foo">My</p>    site</a> is a funny old thing - it attempts to communicate less by</p>    <strong>what</strong> it says than by <strong>how</strong> it says it.</p></p></p><p></p>    A large part of my work is in convincing clients that their site should</p>    be both usable, and accessible to people with a range of disabilities.</p>    It was therefore essential that I enable users with less than perfect</p>    vision to use my site. Unfortunately, <a href="http://www.alistapart.com/stories/fear4/" </p>    title="Fear of StyleSheets at AListApart. Opens in a new window" target="_foo">the </p>    most reliable way to display fonts</a>, which while separating content and presentation as per </p>    <a href="http://www.w3.org/TR/WCAG10-TECHS/#gl-structure-presentation" </p>    target="_foo" title="Opens in a new window.">W3C Accessibility guidelines</a> </p>    doesn't always enable users to resize their fonts using IE and Netscape 'Text</p>    Size' tools.</p></p></p><p></p>    Having read <a href="/article/Give_the_User_Control_Over_Your_Fonts/22/253/evolt.org" </p>    title="Give the User Control Over Your Fonts">Aardvark's excellent article on user font </p>    resizing</a>, I felt sure that this was a sensible way to go for cookie and CSS enabled</p>    browsers. It's not everyone, to be sure, but it's a significant improvement.</p></p></p><p></p>    One problem, though. His article is coded for a Windows NT/IIS/ASP solution. My site is</p>    Unix/Apache/Perl hosted.</p></p></p><p></p>    However, as I do know a bit about this environment, translating the ASP solution to</p>    my system wasn't too hard. If you're wanting to give users control over their font</p>    sizes with Perl/Apache/Unix, here's the code you need.</p></p></p><h2>The Basic Idea</h2></p><p></p>    Exactly as with Adrian's original, it comes in three parts:</p></p></p><ol></p>    <li></p>        Check to see if the browser will do CSS. If so, set a cookie saying</p>        so (so we don't have to check again).</p>    </li></p>    <li></p>        Check to see if the user has requested a non-default size. If so,</p>        set a cookie registering this preference.</p>    </li></p>    <li></p>        Using the cookies, deliver an appropriate stylesheet, chosen from</p>        small, medium and large, and query-string encoded links to the alternative</p>        sized-versions of the same page.</p>    </li></p></ol></p><p></p>    I <em>have</em> added one bit of cleverness - as Macs will display fonts</p>    at a different size than PCs, the default size for PCs is small, and that</p>    for Macs is medium.</p></p></p><p></p><h2>The Code</h2></p><p><h3>Set the cookies</h3></p><p></p>    One problem which Perl/Apache SSIs have is that cookies have to be sent</p>    with the HTTP headers. However, SSIs aren't interpreted until after these</p>    have been sent for the page you're building with SSI. Therefore, throwing</p>    the cookies out by putting them in normal SSIs as ASP does:</p></p></p><p></p>    <code>Response.Cookies("TextSize") = &quot;Normal&quot;</code></p></p></p><p></p>    won't work. Which is a shame. However, you <em>can</em> set cookies with</p>    any files you send as page elements, like images. And Perl/CGI can send</p>    images just as well as it can text.</p></p></p><p></p>    <strong>Solution: Send a dummy 1px image (say your normal transparent</p>    pixel) from a CGI with the cookie(s) in its HTTP headers.</strong>. Which is</p>    exactly what the following script does. It:</p></p></p><ol></p>    <li></p>        Checks to see if the browser is CSS-compatible. This is basically IE or NS 4+, and</p>        Opera as well - note that if IE6 doesn't report itself as IE5, then you</p>        will need to edit this script. NS6 pretends to be NS5, so we're OK on that</p>        score. I've also specifically excluded browsers such as iCab and Lynx, which</p>        allow users to choose to use UA strings which claim version4/5 compatibility. They</p>        also allow users to make up their own, but that's another issue.</p>    </li></p>    <li></p>        Checks to see if there is a querystring of the form: <code>textsize=something</code></p>    </li></p>    <li></p>        Sets cookies appropriately for each of the above by delivering an image content-type</p>        with cookie headers.</p>    </li></p></ol></p><p></p>    Here's the script:</p></p></p><p><code></p><pre></p>#!/usr/bin/perl</p>##############################################################################</p># font_cookie.cgi                         Version 1.0                        #</p># Copyright 2000 Martin Burns             scripts@easyweb.co.uk              #</p># based on ASP code by Adrian Roselli                                        #</p># Created 21/9/00                         Last Modified 21/9/00              #</p>##############################################################################</p># COPYRIGHT NOTICE                                                           #</p># Copyright [and -left] 1999-2000 Martin Burns and Adrian Roselli.           #</p># All Rights Reserved except as provided below.                              #</p>#                                                                            #</p># font_cookie.cgi may be used and modified free of charge by anyone so long  #</p># as this copyright notice and the comments above remain intact. By using    #</p># this code you agree to indemnify Martin Burns, EasyWeb Design and Adrian   #</p># Roselli from any liability that might arise from its use.                  #  </p>#                                                                            #</p># This script is released under the GPL.                                     #</p># Selling the code for this program or any derivative work is expressly      #</p># forbidden. A full copy of the GPL can be found in the Code section of      #</p># http://evolt.org. In all cases copyright and this header must remain       #</p># intact.                                                                    #</p>##############################################################################</p>## ASP Code by Adrian Roselli from http://roselli.org</p>## Provided free for evolt.org and its members.</p>## No catches, just give me credit.</p>## This browser detection only detects IE4.x and</p>## NN4.x, please modify it as you see fit to get</p>## the 5.x and alternate manufacturer CSS-capable</p>## browsers.</p>## Last change July 10, 1999</p><p>############################################################################</p># Set some variables                                                       #</p>############################################################################</p>#Testing:</p>#use diagnostics;</p>#$ENV{'QUERY_STRING'} = 'textsize=larger';</p>#$ENV{'HTTP_USER_AGENT'} = 'Mozilla/4.0'; #(compatible; MSIE 5.5; Windows98)</p>#$ENV{'SERVER_NAME'} = 'www.easyweb.co.uk';</p>#$ENV{'HTTP_COOKIE'} = 'browser=css';</p><p></p>## Get the browser name and version number</p>$USERAGENT = $ENV{'HTTP_USER_AGENT'};</p><p>##initialise other vars</p>#%in=&quot;&quot;;</p>#%cookie=&quot;&quot;;</p>$REQUIRE_DIR = '/full/path/to/dir/with/subroutines/like/your/cgi-bin/';</p>$YES=1;</p>$NO=0;</p>$CSS=$NO;</p><p></p>############################################################################</p># Get Required subroutines which need to be included.                      #</p>############################################################################</p><p># Push the $REQUIRE_DIR onto the @INC array for include file directories.</p><p>if ($REQUIRE_DIR ne '') {</p>    push(@INC, $REQUIRE_DIR);</p>}</p><p># Require Necessary Routines for this script to run.</p>require 'cgi-lib.pl'; #ye olde faithful</p><p>########################</p>## Browser Determination  </p>## Check the UserAgent string to see</p>## if it contains Mozilla or MSIE, and then</p>## to see if it has 4. or 5. in the version number</p>## or alternatively is Opera</p>if (</p>      ((($USERAGENT =~ /mozilla/i)    ($USERAGENT =~ /msie/i))</p>      &amp;&amp; (($USERAGENT =~ /4./)    ($USERAGENT =~ /5./)))</p>        ($USERAGENT =~ /opera/i)) {</p>     </p>     $CSS=$YES;</p>}</p><p>##Cut out sneaky ones like iCab which allow users to set the UA string</p>@sneakybrowsers = ( 'icab', 'lynx');</p>foreach $browser (@sneakybrowsers) {</p>	if ($USERAGENT =~ /$browser/i) {$CSS = $NO}</p>}</p><p>## If the cookie Browser has no value,</p>## then perform the following</p>if (($ENV{'HTTP_COOKIE'} !~ /browser=/i) &amp;&amp; ($CSS)) {</p>    ## Sets a variable for the cookie so that the</p>    ## browser is marked as CSS-capable</p>    $cookie{'browser'} = 'css';</p>}</p><p></p><p>################</p>## Set Text Size</p><p>## If the URL does not have a ?size=value</p>## appended to it (meaning the user clicked</p>## one of the links), then perform the following</p>#if (!&amp;ReadParse) {</p>#   print &amp;PrintHeader, &quot;&lt;!-- script parse error ($!)--&gt;&quot;;</p>#}</p>&amp;ReadParse;</p>if (($in{'textsize'}) &amp;&amp; ($CSS)) {</p>  $cookie{'textsize'} = $in{'textsize'};</p>  #testing</p>  #print $cookie{'textsize'}</p>}  </p>################</p>## Start the headers</p>print &quot;Content-Type: text/html</p>&quot;;</p><p>################</p>## Output the cookies</p>if ((%cookie) &amp;&amp; ($CSS)) {</p><p>    foreach $variable (keys %cookie) {</p>        $cookie_var = $cookie{&quot;$variable&quot;};</p>        print &quot;Set-Cookie: $variable=$cookie_var\; domain=$ENV{'SERVER_NAME'}\; path=\/\;</p>&quot;;</p>    }</p>}</p><p>###############</p>## Output the image</p>## if you want to force the image not to be cached</p>$pragma='Pragma: no-cache';</p>$expires='Expires: Wed, 26 Feb 1997 08:21:57 GMT</p>'; #ie in the past</p><p>$tmpfile=&quot;/full/path/to/your/public_html/resources/transparent.gif&quot;;</p>open( FROM, &quot;&lt; $tmpfile&quot; );</p>binmode FROM;</p>binmode STDOUT;</p><p># Print out the contents of the image file.</p>print &quot;Content-type: image/gif</p>&quot;;</p>print $expires,&quot;</p>&quot;;</p>print $pragma,&quot;</p>&quot;;</p>print &quot;</p>&quot;;</p><p>while (&lt;FROM&gt;) {</p>      print $_;</p>   }</p><p>close FROM;</p><p></p>###############</p>## End the headers</p>print &quot;</p>&quot;;</p></pre></p></code></p><p><p></p>    The way you get this onto your page is by pretending it's a standard image:</p></p></p><p></p>    <code>&lt;img src=&quot;/cgi-bin/font_cookie.cgi?&lt;!--#ECHO VAR="QUERY_STRING&quot;--&gt;&quot; height=&quot;1&quot; width=&quot;1&quot; alt=&quot;&quot; /&gt;</code></p></p></p><p></p>    (The <code>&lt;!--#ECHO VAR=&quot;QUERY_STRING&quot;--&gt;</code> bit just makes sure that</p>    any query strings applied to the page get passed to the CGI. This will principally</p>    be <code>textsize=something</code>.)</p></p></p><p></p>    The only downside to getting the cookies out like this is that a cookie won't</p>    be available to the rest of your script until <strong>after</strong> the first</p>    page the user hits on your site - users will only be able to choose their font</p>    size from the <em>second</em> page they visit.</p></p></p><p><h3>Choose a size</h3></p><p></p>    Obviously, the simple way to give the users choice over which size of fonts they are</p>    to receive is to put a bunch of SSI links on the page like this:</p></p></p><code></p><pre></p>&lt;a href=&quot;&lt;!--#ECHO VAR=&quot;DOCUMENT_URI&quot;--&gt;?textsize=large&quot;&lt;Large fonts&lt;/a&gt;</p>&lt;a href=&quot;&lt;!--#ECHO VAR=&quot;DOCUMENT_URI&quot;--&gt;?textsize=normal&quot;&lt;Medium fonts&lt;/a&gt;</p>&lt;a href=&quot;&lt;!--#ECHO VAR=&quot;DOCUMENT_URI&quot;--&gt;?textsize=small&quot;&lt;Small fonts&lt;/a&gt;</p></pre></p></code></p><p></p>    But then the user has to know what size they have at present, and develop</p>    a mental model for your font calibration. It's also a bit silly to give the</p>    choice of the current size, as it won't do anything! A much more elegant solution is to</p>    only give relative choices of larger or smaller than the present size. This</p>    means that when you're at the smallest size, you only give the choice of 'Larger',</p>    and when you're at the largest size, you only give the choice of 'Smaller'.</p></p></p><p></p>    What this script does is the logic behind that, working out the current size and</p>    only delivering appropriate choices which users can instinctively grasp.</p></p></p><code></p><pre></p>##############################################################################</p># cssResize - css_resize.cgi              Version 1.0                        #</p># Copyright 2000 Martin Burns             scripts@easyweb.co.uk              #</p># based on ASP code by Adrian Roselli                                        #</p># Created 21/9/00                         Last Modified 21/9/00              #</p>##############################################################################</p># COPYRIGHT NOTICE                                                           #</p># Copyright [and -left] 1999-2000 Martin Burns and Adrian Roselli.           #</p># All Rights Reserved except as provided below.                              #</p>#                                                                            #</p># cssResize may be used and modified free of charge by anyone so long        #</p># as this copyright notice and the comments above remain intact. By using    #</p># this code you agree to indemnify Martin Burns, EasyWeb Design and Adrian   #</p># Roselli from any liability that might arise from its use.                  #  </p>#                                                                            #</p># This script is released under the GPL.                                     #</p># Selling the code for this program or any derivative work is expressly      #</p># forbidden. A full copy of the GPL can be found in the Code section of      #</p># http://evolt.org. In all cases copyright and this header must remain       #</p># intact.                                                                    #</p>##############################################################################</p><p>## Code by Adrian Roselli from http://roselli.org</p>## Provided free for evolt.org and its members.</p>## No catches, just give me credit.</p>## Make sure you supply your own images, rollovers,</p>## whatever. These are just suggestions, especially</p>## since text links are not always attractive.</p>## Last change July 10, 1999</p><p>## Request the cookie Browser and see if it is a</p>## CSS-capable browser, based on your previous work.</p>## This ensures that you do not display the buttons</p>## if the browser cannot use them.</p><p></p><p>#Testing</p>#use diagnostics;</p><p></p><p>##Set a variable or two</p>#testing</p>#$ENV{'HTTP_COOKIE'} = 'textsize=small';</p>#$ENV{'QUERY_STRING'} = 'textsize=large';</p>$USER_AGENT = $ENV{'HTTP_USER_AGENT'};</p>require 'cgi-lib.pl';</p>&amp;ReadParse;</p>%size = ('large', '',</p>         'normal', '',</p>         'small', '');</p><p>#Testing</p>#$ENV{'HTTP_COOKIE'} = 'textsize=normal; browser=css';</p>#$ENV{'HTTP_COOKIE'} = 'browser=css';</p>#$ENV{'DOCUMENT_URI'} = '/cv/index2.html';</p>if ($ENV{'HTTP_COOKIE'} =~ /browser=css/i) {</p>    $PAGE = $ENV{'DOCUMENT_URI'};</p>    if ($ENV{'HTTP_COOKIE'} =~ /textsize=(large small normal)/i) {</p>		$textsize=$1;</p><p>   } elsif ($USER_AGENT =~ /windows/i) {</p>       $textsize='small';</p><p>    } else {$textsize='normal'}</p><p></p>      ##Check for query strings</p>   if ($in{'textsize'}) {</p>	    $textsize = $in{'textsize'}; </p>   }</p><p></p><p>   $size{$textsize}='yes';</p>#   print &quot;$textsize</p>&quot;;</p> </p><p>    ###########</p>    ## Output the start of the block - YMMV</p>    print qq &lt;h4 class=&quot;css_swap&quot;&gt;Text not right?&lt;/h4&gt;</p> ;</p>    print qq &lt;p class=&quot;css_swap&quot;&gt;</p> ;</p>	</p>	if ($size{&quot;large&quot;}) {</p>    ## If the text is set to large, offer the option to reduce to normal</p>	print qq &lt;a href=&quot;$PAGE?textsize=normal&quot;&gt;Reduce Text&lt;/a&gt; ;</p>	} elsif ($size{&quot;small&quot;}) {</p>    ## If the text is set to small, offer the option to enlarge to normal</p>	print qq &lt;a href=&quot;$PAGE?textsize=normal&quot;&gt;Enlarge Text&lt;/a&gt; ;</p>	} else {</p>    ## If the text is normal, offer the option to enlarge or reduce</p>	print qq &lt;a href=&quot;$PAGE?textsize=large&quot;&gt;Enlarge Text&lt;/a&gt;&lt;br /&gt;</p> ;</p>    print qq &lt;a href=&quot;$PAGE?textsize=small&quot;&gt;Reduce Text&lt;/a&gt;&lt;br /&gt; ;</p><p>    ###########</p>    ## Output the end of the block - YMMV</p>    print q &lt;/p&gt; ;</p><p>    }</p>} else {</p>    print &quot;&lt;!--No variation for you, sorry--&gt;&quot;;</p>}</p>print &quot;</p><p>&quot;;</p></pre></p></code></p><blockquote></p>    <cite></p>        <strong>Interesting sidenote:</strong><br></p>        I've made the code more readable by using the Perl <code>q</code> and</p>        <code>qq</code> quoting functions. This allows you to use any character</p>        in place of single and double quotes in a <code>print</code> statement,</p>        thereby allowing you to use <strong>real</strong> single and double quotes</p>        in what you're printing without escaping them. This is particularly handy</p>        if you're outputting JavaScript which already plays silly beggers with</p>        single and double quotes.</p>    </cite></p></blockquote></p><p></p>    You bring this into your page at the point where you want the options to appear</p>    with a standard SSI exec call:</p></p></p><p></p>    <code>&lt;!--#exec cmd=&quot;/full/path/to/your/cgi-bin/css_resize.cgi&quot;--&gt;</code></p></p></p><h3>Deliver the stylesheet</h3></p><p></p>    The last thing we need to do is to deliver the appropriate stylesheet, either</p>    the one chosen by the user, or a sensible default where the user either thinks</p>    that the basic size is OK, or (on that vital first page before the cookie is</p>    set) hasn't yet seen the options.</p></p></p><p></p>    I've set it up such that Windows machines get the small size as default, and</p>    Macs, Unix boxen etc get the normal (middle) size. Naturally, this will depend</p>    on how you set up the fonts in your stylesheets. In mine, the normal body text</p>    is set as follows:</p></p></p><ul></p>    <li></p>        <strong>Large:</strong> 12pt </p>    </li></p>    <li></p>        <strong>Normal:</strong> 11pt </p>    </li></p>    <li></p>        <strong>Small:</strong> 10pt </p>    </li></p></ul></p><p></p>    with all &lt;hx&gt; and other text styles also being appropriately scaled.</p></p></p><p></p>    To deliver the appropriate stylesheet, the page will need one of the following:</p></p></p><p></p>    <code></p>    &lt;link rel=&quot;stylesheet&quot; href=&quot;/resources/large.css&quot;&gt;<br></p>    &lt;link rel=&quot;stylesheet&quot; href=&quot;/resources/normal.css&quot;&gt;<br></p>    &lt;link rel=&quot;stylesheet&quot; href=&quot;/resources/small.css&quot;&gt;</p>    </code></p></p></p><p></p>    And here's the code to deliver it:</p></p></p><code></p><pre></p>#!/usr/bin/perl</p>##############################################################################</p># cssSwap - css_swap.cgi                  Version 1.0                        #</p># Copyright 2000 Martin Burns             scripts@easyweb.co.uk              #</p># based on ASP code by Adrian Roselli                                        #</p># Created 21/9/00                         Last Modified 21/9/00              #</p>##############################################################################</p># COPYRIGHT NOTICE                                                           #</p># Copyright [and -left] 1999-2000 Martin Burns and Adrian Roselli.           #</p># All Rights Reserved except as provided below.                              #</p>#                                                                            #</p># cssSwap may be used and modified free of charge by anyone so long          #</p># as this copyright notice and the comments above remain intact. By using    #</p># this code you agree to indemnify Martin Burns, EasyWeb Design and Adrian   #</p># Roselli from any liability that might arise from its use.                  #  </p>#                                                                            #</p># This script is released under the GPL.                                     #</p># Selling the code for this program or any derivative work is expressly      #</p># forbidden. A full copy of the GPL can be found in the Code section of      #</p># http://evolt.org. In all cases copyright and this header must remain       #</p># intact.                                                                    #</p>##############################################################################</p>## Code by Adrian Roselli from http://roselli.org</p>## Provided free for evolt.org and its members.</p>## No catches, just give me credit.</p>## Make sure you point to the right style sheets.</p>## Last change July 10, 1999</p><p>##Set a variable or two</p>#testing</p>#$ENV{'HTTP_COOKIE'} = 'textsize=small';</p>require 'cgi-lib.pl';</p>$size='';</p>$stylesheet_ref='&lt;link rel=&quot;stylesheet&quot; href=&quot;/resources/';</p>$USER_AGENT=$ENV{'HTTP_USER_AGENT'};</p><p></p><p>## Iterate through the size options, with</p>## a default if there are no matches.</p><p>if ($ENV{'HTTP_COOKIE'} =~ /textsize=(large small normal)/i) {</p>    $size=$1;</p>} elsif ($USER_AGENT =~ /windows/i) {</p>    $size='small';</p>} else {$size='normal'} </p><p>################</p>## Check for query string vars</p><p>## If the URL does not have a ?size=value</p>## appended to it (meaning the user clicked</p>## one of the links), then perform the following</p>#if (!&amp;ReadParse) {</p>#   print &amp;PrintHeader, &quot;&lt;!-- script parse error ($!)--&gt;&quot;;</p>#}</p>&amp;ReadParse;</p>if ($in{'textsize'}) {</p>  $size = $in{'textsize'};</p>  #testing</p>  #print $cookie{'textsize'}</p>}  </p><p>#&amp;PrintHeader;</p>#print $ENV{'QUERY_STRING'};</p>print $stylesheet_ref.$size.&quot;.css\&quot; \/&gt;</p><p>&quot;;</p>#print $ENV{'HTTP_COOKIE'};</p></pre></p></code></p><p><p></p>    And once again, you bring this into your page (in the <code>&lt;head&gt;</code> section of</p>    course) with an SSI exec call:</p></p></p><p></p>    <code>&lt!--#exec cmd=&quot;/full/path/to/your/cgi-bin/css_swap.cgi&quot;--&gt;</code></p></p>