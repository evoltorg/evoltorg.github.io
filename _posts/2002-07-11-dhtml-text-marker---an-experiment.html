---
layout: post
permalink: node/29028
---
<h2>What is a text marker?</h2></p><p><p>Anyone who uses google newsgroups search will encounter a text marker a.k.a \n  highlighter. For instance, search on <a target="_blank" title="Google groups. Opens in a new window." href="http://groups.google.com">http://groups.google.com</a> \n  for a recipe to make <strong>Minestrone</strong>. View any of the search \n  results, the word 'minestrone' will appear highlighted (see screen-cap below). \n</p></p><p><p>\n  This feature makes a search engine on a website much more user friendly, the \n  user now does not have to scan the page visually for the part of the text that \n  has the 'minestrone' recipe. Instead, the user now knows immediately which part \n  of the content has the recipe.\n</p></p><p><p>\n  Google achieves this 'marking' of the text by applying a <code>&lt;span style=&quot;background-color:#color&quot;&gt; \n  </code> tag around the search keyword.<br>\n  We will look at one particular way to implement this feature.\n</p></p><p><p class="side" style="padding:5px;">\n<img src="images/20519/29028/minestrone.jpg"\n    alt="Google groups page"\n    align="right" border="1" width="260" height="280" /> \nRIGHT : Screen shot of page from <a href="http://groups.google.com" target="_blank" title="Opens in a new window.">Google Groups</a>, \nI searched for a recipe to make 'Minestrone' (this is a tasty italian creation). This was one of\n the search result pages that I opened.  \n</p></p><p><h2>Various Implementation methods </h2></p><p><p>There are a lot of &quot;out of the box&quot; search engine tools available \n  that can be used with a website. A few of these search engine solutions come \n  with some kind of search results text highlighting, but what about the rest? \n  (I am aware of a couple : <a title="Lotus Domino website. Opens in a new window." target="_blank" href="http://www-10.lotus.com/ldd">Lotus \n  Domino search</a> and <a title="Perlfect solutions. Opens in a new window." target="_blank" href="http://www.perlfect.com/freescripts/search/">Perlfect \n  Search</a> ). Some people also end up rolling out their own site-specific search \n  engine solutions. </p></p><p><p>A good way to implement this feature would be on the server side (as Google \n Groups search does). This involves script based processing of the content using \n  the search keyword (in our example: minestrone) as the parameter, and \n  then output the tagged/highlighted content to the browser. The negative side \n  of this approach is that a different implementation might be needed for a different \n  server side platform. Like many kinds of server side programs this could also \n  turn out be be resource and processor intensive.</p></p><p><p>I decided for the quick 'n' dirty client-side JavaScript route - which I thought \n  I could then re-use on any server side platform or even for static html pages \n  (though as you read on you will learn I wasn't <em>exactly</em> successful).</p></p><p><h2>Compatibility Issues</h2></p><p><p>There are a few compatibility issues in the JavaScript approach. The original \n  (and single unto now) guinea-pig-implementation for the code is a restricted \n   Intranet scenario (my workplace). Almost everybody is compulsorily on <abbr title="Internet Explorer">IE</abbr> 6, \n  so I basically wrote it without giving a damn about other browsers (now, is \n  that evil or what?). But the good news is I got it to work with minimum fuss \n  on Mozilla (yeah! I am a decent guy now). I have tested it successfully on the \n  following browsers:</p></p><p><ul>\n  <li>IE 6 (Windows versions)</li>\n  <li>Mozilla 1 RC1</li>\n</ul></p><p><p>I tested the script on IE 5.0 and IE crapped out completely: when the browser \n  reached a particular regular expression function in the code my CPU hit 100% \n  processor utilization and IE came to a grinding halt. I guess the regular expression \n  object in IE 5 isn't anywhere as sturdy as the one in IE6 and Mozilla. </p></p><p><p>I don't have IE 5.5, IE 5.01, Netscape 6.x installed, nor do I have MacOS running \n  anywhere close by, so I have no idea of how the code would behave on those browsers. \n  Though if the code is not working on IE 5, with IE 4.x your guess is as good \n  as mine.\n</p></p><p><p>\n  Theoretically it should be possible to make it work on <abbr title="Netscape Navigator 4">NN4</abbr> or any browser that \n  supports the <code>innerHTML</code> object, (i.e. if the regular expression \n  object can handle the stress). I did try to make it work on Opera 6 but it doesn't \n  support <code>innerHTML</code> :-(.</p></p><p><p>Which is why I have called this article an experiment ! But at least the article \n  is futuristic with its upward compatibility ;). </p></p><p><h2>JavaScripting our implementation </h2></p><p><p>Here is a summarized list of steps needed to implement this:</p></p><p><ul>\n  <li>Enclose the main content portion of the page within a single named <code>&lt;div&gt; \n    </code> tag </li>\n  <li>Add an <code>onLoad</code> event to the <code>&lt;body&gt;</code> tag .</li>\n  <li>Call the highlighting function from the <code>onLoad</code> event, if a \n    particular query string has been passed to the page.</li>\n</ul></p><p><h3>Step 1 : <code>&lt;div&gt;</code>ing your content</h3></p><p><p>To begin with I designed all my content pages such that, the whole content \n  section on a page was wrapped inside a named <code>&lt;div&gt;</code> tag, something like \n  this:</p></p><p><pre>&lt;div id=&quot;contentdiv&quot;&gt;&lt;!--begin content section--&gt;\n  &lt;p&gt; \n	  skajfl sa fjla safkljasl lkfasj ja akjflka .....&lt;br&gt;\n	  &lt;a href=&quot;dudu.com&quot;&gt;my link&lt;/a&gt; &lt;br&gt;\n  &lt;/p&gt;\n  &lt;ul&gt;&lt;li&gt;....&lt;/ul&gt;\n  &lt;table&gt; ......&lt;/table&gt;\n  &lt;p&gt;......&lt;/p&gt;\n&lt;/div&gt;&lt;!--end content section--&gt;\n</pre></p><p><p><strong>Note:</strong> this is the content area of the page, kind of similar to the article \n  content part of a page on evolt.org. This doesn't include stuff like the evolt \n  side bar or the top menu.</p></p><p><h4>Why did I have to use a <code>&lt;div&gt;</code> tag?</h4></p><p><p>More for convenience, to access all the <abbr title="HyperText Markup Language">HTML</abbr> Content area in a page through \n  JavaScript all I would need to do now is:</p></p><p><p><code> elemObj = document.getElementById('contentdiv');<br> strInHtml = elemObj.innerHTML; \n  </code></p></p><p><p><code>strInHtml</code> is now a string containing all the HTML contained by <code>&lt;div \n  id='contentdiv'&gt;</code>. I used the <code>innerHTML</code> property of the <code>&lt;div&gt;</code> \n  tag to access the raw HTML. The good thing about the <code>innerHTML</code> \n  property is , it is also a settable property.\n</p></p><p><p>\n  I can do something like:\n</p></p><p><p><code>x.innerHTML = '&lt;h2&gt;My new stuff &lt;/h2&gt;'; </code></p></p><p><p>which will overwrite all the HTML within the <code>&lt;div&gt;</code> with my \n  new stuff. Our implementation will be using this powerful little <acronym title="Document Object Model">DOM</acronym> property.</p></p><p><p  class="side" style="padding:5px;"><strong>Note:</strong> There is a big ongoing \n  debate about the pros and cons of using <code>innerHTML</code>. <a title="Launches developer-x.com article - should innerHTML be used at all ? - the debate" target=_blank href="http://www.developer-x.com/content/innerhtml/">Read \n  all about it!</a>. The fact remains that <code>innerHTML</code> is very convenient \n  as against using the more complicated DOM methods which seems the more politically \n  correct method.</p></p><p><h3>Step 2 : the <code>onLoad</code> event</h3></p><p><p>When a keyword on the page needs to be highlighted, the keyword is passed to \n  the page using a query string. If the page is normally invoked like this:\n</p></p><p><p><code>http://server/page/index.asp</code></p></p><p><p>With the highlight query string it will be invoked like this:</p></p><p><p><code>http://server/page/index.asp?hilite=minestrone</code></p></p><p><p>Add an <code>onLoad</code> event in the <code>&lt;body&gt;</code> tag. Something like:</p></p><p><p><code>&lt;body onLoad=&quot;javascript:onLoad();&quot;&gt;</code></p></p><p><h3>Step 3 : Calling the highlighting function from <code>onLoad</code></h3></p><p><p>Here I read the <code>innerHTML</code> property of the <code>&lt;div&gt;</code> \n  as raw HTML into a string variable. Then I do a search and replace of every \n  instance of the keyword with the highlighted version of the keyword. Then finally \n  I write the replaced version of the string back into the <code>&lt;div&gt;</code>.\n</p></p><p><p>\n  The highlighting is achieved using a simple <code>&lt;span&gt;</code> tag with <code>style=&quot;background-color:yellow;&quot; </code>.\n</p></p><p><p>There is a precaution to take here when inserting the tags, consider some content \n  like this:</p></p><p><pre>&lt;p&gt;\n  .............\n  &lt;!--content--&gt;............\n  &lt;a href=&quot;minestrone.com&quot; title=&quot;link to minestrone home page&quot;&gt;minsestrone \n  home page&lt;/a&gt;.\n  .............\n  &lt;!--more content--&gt;............\n&lt;/p&gt;\n</pre></p><p><p>The replace function should not place highlight tags around the word minestrone \n  found within the &quot;title&quot; attribute of the <code>&lt;a&gt;</code> tag, \n  that would break the HTML. It should replace only stuff within the <code>&lt;a&gt;&lt;/a&gt;</code> \n  tags.</p></p><p><p>\n  I used the javascript RegExp object to filter out illegal matches of this kind.\n</p></p><p><p>Just a couple of points before we dive into the actual code.</p></p><p><ul>\n  <li> Instead of trying to match only text within an opening <code>&lt;*&gt;</code> \n    and closing <code>&lt;*/&gt;</code> I match everything to the right of <br>\n    <code>&lt;* &gt;</code> . This is because not all tags have opening and closing \n    pairs and people invariably forget to close the good old <code> &lt;p&gt;</code> \n    tag.</li>\n  <li>The code assumes there are no <code>&lt;script&gt;</code> tags within the content. I \n    didn't build any checks in for these tags.</li>\n</ul></p><p><p>There is some preliminary stuff that <code>onLoad</code> does, that I will not be getting \n  into explaining here as they have been dealt with earlier in articles by other \n  people on this website: </p></p><p><ul>\n  <li>Extracting the keyword to be highlighted from a querystring using a javascript \n    DOM property (<code>document.location.href</code>).</li>\n  <li>Extracting the <code>innerHTML</code> from the <code>&lt;div&gt;</code> \n    again using the DOM properties.</li>\n  <li>Writing back the highlighted text into the <code>&lt;div&gt;</code>'s <code>innerHTML</code>. </li>\n</ul></p><p><p>The actual function that applies the <code>&lt;span&gt;</code> highlighting tags to the \n  <code>innerHTML </code> is quite small , lets examine it part by part:</p></p><p><pre>function markText(txtKeyword, inputHtml) \n{	\nvar re; /*regex object*/\nvar varMatches; /*matches array*/\nvar outHtml; /*output html*/\nvar replaceText;/*build the span tag with the keyword in advance*/</p><p>replaceText = '&lt;span style=&quot;background-color:yellow;color:red;font-weight:bold;&quot;&gt;'+txtKeyword+ '&lt;/span&gt;';\n</pre></p><p><p> The function takes two paramters, the keyword to be highlighted (<code>txtKeyword</code>) \n  and the raw HTML content string extracted using the <code>innerHTML</code> property (<code>inputHtml</code>).</p></p><p><p> All the neccessary string and regular expression object variables are declared. \n  The highlighted keyword string is built up in advance, in Line 6 by prefixing \n  &amp; suffixing it with a <code>&lt;span style=....&gt;</code> tag.</p>	\n	\n<pre>re=new RegExp(&quot;(\&lt;[^&gt;][^&lt;]*\&gt;)([^&lt;]*)&quot;,&quot;g&quot;); /*create non-greedy regex match*/\noutHtml=new String('');	/*init html string*/\n	</pre></p><p><p>A new instance of the <code>RegExp</code> Object is declared ,every opening \n  (<code>&lt;</code>) and closing (<code>&gt;</code>) tag is matched and any \n  non-tag expression to the right of the closing tag. The second parameter to \n  the RegExp object (&quot;g&quot;) indicates that the RegExp \n  match will be done recursively(globally).</p></p><p><p class="side" style="padding: 5px;">I had to slip in the extra <code>[^&lt;]</code> \n  in the first part of the expression, sometimes the match used to bomb on encountering \n  a non-visible character. The extra expression seemed to fix that.</p></p><p><pre>	\nwhile ((varMatches = re.exec(inputHtml)) != null)/*exec sequentially to apply span tags*/\n {\noutHtml+=varMatches[1]; 	/*html tag part*/\noutHtml+=replaceMe(varMatches[2], txtKeyword, replaceText); /*call the search &amp; replace function*/\n }\nreturn outHtml;\n}\n</pre></p><p><p>The <code>innerHTML</code> string is now evaluated against the regular expression \n  object. The <code>exec()</code> method searches the string using the regular \n  expression and returns an array (<code>varMatches</code>) containing the results \n  of the search. Dimension 1 of the array (<code>varMatches[1]</code>) contains \n  the matched HTML tag and Dimension 2 (<code>varMatches[2]</code>) contains the \n  non-tagged text to the right of the matched tag . </p></p><p><p>For example if the following is one of the matches : <br>\n  <code>&lt;p class=&quot;xclass&quot;&gt;hello there</code> <br>\n  <code>varMatches[1]</code> would contain <code> &lt;p class=&quot;xclass&quot;&gt; </code><br>\n  and <br>\n  <code>varMatches[2]</code> would contain the string: &quot;hello there&quot;</p></p><p><p>The string in <code>varMatches[2]</code> is now searched for the keyword to \n  be highlighted and every instance of it is replaced with the <code>&lt;span&gt;</code> \n  tagged keyword (using the <code>replaceMe()</code> function).</p></p><p><p>Subsequently the highlighted output string from the <code>markText()</code> \n  function is written back to the <code>&lt;div&gt;</code> tag by setting the \n  <code>innerHTML</code> property , something like :</p></p><p><p>\n<code>contentDivObj.innerHTML = strOutputFromMarkText;</code> </p></p><p><p>The sample code should be self explanatory and it is commented. Most of the \n  layer writing methods like reading and setting the <code>innerHTML</code>, I learnt from \n  <a href="http://www.xs4all.nl/~ppk/js/" target="_blank" title="Opens in a new window.">ppk's website</a>.</p></p><p><p>That's about it.</p></p><p><p>There is a working example available : <a target="_blank" title="dhtml marker example. Opens in new window." href="http://members.evolt.org/Junglee/samples/dhtmlmarker/sample.htm">DHTML marker sample</a></p></p><p><p>Some possible improvements / optimizations :</p></p><p><ul>\n  <li> Portable code for other minor browsers .</li>\n  <li>Right now the code treats multiple keywords as a phrase, changing this code \n    to handle each word in the phrase individually shouldn't be hard to implement \n    . </li>\n  <li>I don't do character code conversions. For example: if someone searched \n    for a word like: <strong>bonnie&amp;clyde</strong>. I don't convert it to \n    <strong>bonny&amp;amp;clyde</strong>. So maybe this could be added.</li>\n</ul>