---
layout: post
permalink: Storage_and_re_use_of_images_using_PHP_GD_Part_1
---
<p>\nPublishing images on the web is nice, but tedious. It would be nice if we could use a system that automates the uploading, storage, converting and resizing of our images. We could feed that system our images once, and retrieve them later in many different formats. In this article, we will write some scripts that come close to this ideal system. PHP and the GD-library will provide us with an easy method of uploading, searching and publishing our images.\n</p></p><p><p>\nThis article is an extension of <a href="/article/Automated_Creation_of_Thumbnails_With_PHP/20/24498/index.html">an earlier article</a>, which described how to write a script that can resize and convert images on the fly. You will need that script here.\n</p></p><p><h2>Our wish list</h2>\n<p>\nWe want to have a system that we can use to:\n</p>\n<ol>\n<li>upload and store our images;</li>\n<li>search our image database;</li>\n<li>publish our images on our web site;</li>\n<li>maintain a central list of alt-tags.</li>\n</ol></p><p><p>\nWe also want our system as flexible as possible. To make it easy to use, it has to accept and convert the following range of image types: jpeg, gif, png, bmp. Those formats have to be converted to jpeg and png, and stored for later use. When retrieving our images, it would be nice if we could resize them as we need.\n</p></p><p><p>\nIn this first of two instalments, we will build the scripts that upload, convert and store the images. In the second instalment, we will write a simple search function and the image retrieval-part.\n</p></p><p><h2>What we need</h2>\n<p>\nThe mission described above can be accomplished using the following open-source tools and libraries:\n</p>\n<ul>\n<li><a href="http://www.php.net/" target="_blank" title="Opens in a new window">PHP</a>, compiled with the GD-library, MySQL and jpeg-support;</li>\n<li>a working <a href="http://www.mysql.com/" target="_blank" title="Opens in a new window">MySQL-server</a> for storing the image info;</li>\n<li>a working instance of the image conversion and resizing script I described in <a href="/article/Automated_Creation_of_Thumbnails_With_PHP/20/24498/index.html">this article</a>;</li>\n<li>the following converters found in the <a href="http://netpbm.sourceforge.net/" target="_blank" title="Opens in a new window">netpbm-toolkit</a>: bmptoppm, , pngtopnm, pnmtopng, ppmtogif;</li>\n<li>the <a href="http://www.catb.org/~esr/gif2png/" target="_blank" title="Opens in a new window">gif2png utility</a>.</li>\n</ul>\n<p>\nYou can compile your own versions of these conversion utilities. You can also <a href="http://gvtulder.f2o.org/evolt/img/imgutil.tar.gz" target="_blank" title="Opens in a new window">download the binary versions I compiled for Linux i386</a> (97 kB download).\n</p></p><p><h2>The database layout</h2>\n<p>\nWhen uploading, we will store the image information in a MySQL-table for later use. In the database, we will store the following information:\n</p>\n<ul>\n<li>the filename of the image (the generated 13 character name);</li>\n<li>the image type (jpeg or png);</li>\n<li>the image width and height;</li>\n<li>the size of the image in bytes;</li>\n<li>the title of the image for our own search purposes;</li>\n<li>a description of the image, also to search and find;</li>\n<li>the alt-tag of the image, to display when publishing the image.</li>\n</ul>\n<p>\nCreate the database using the following SQL-query.\n</p>\n<pre>\nCREATE TABLE images (\n  img_id mediumint(9) NOT NULL auto_increment,\n  img_file varchar(13) NOT NULL default '',\n  img_type enum('JPG','PNG') NOT NULL default 'JPG',\n  img_height smallint(6) NOT NULL default '0',\n  img_width smallint(6) NOT NULL default '0',\n  img_bytes mediumint(9) NOT NULL default '0',\n  img_title tinytext NOT NULL,\n  img_descr mediumtext NOT NULL,\n  img_alt tinytext NOT NULL,\n  PRIMARY KEY  (img_id)\n) TYPE=MyISAM;\n</pre></p><p><h2>Part 1: The upload script</h2>\n<p>\nIn this first instalment, we will write the scripts that handle the uploading, converting and storing of the image. We will concentrate on the scripting; you can design your own interface.\n</p></p><p><h3>The form</h3>\n<p>\nThe user will fill in a simple html-form to add an image to the database. Save this form as <code>upload.html</code>.\n</p>\n<pre>\n&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;upload.php&quot;&gt;\n&lt;b&gt;Upload image&lt;/b&gt;&lt;br&gt;\nSelect image: &lt;input name=&quot;file&quot; type=&quot;file&quot;&gt;&lt;br&gt;\nTitle: &lt;input name=&quot;title&quot; type=&quot;text&quot;&gt;&lt;br&gt;\nDescription: &lt;textarea name=&quot;descr&quot;&gt;&lt;/textarea&gt;&lt;br&gt;\nAlt-text: &lt;input name=&quot;alt&quot; type=&quot;text&quot;&gt;&lt;br&gt;\n&lt;input type=&quot;submit&quot; value=&quot;Upload&quot;&gt;\n&lt;/form&gt;\n</pre></p><p><h3>The script</h3>\n<p>\nThe form is sent to <code>upload.php</code>. Save the script as <code>upload.php</code>.\n</p></p><p><h4>Settings</h4>\n<pre>\n// define the base image dir \n$base_img_dir = &quot;./img/&quot;;</p><p>// define location of image conversion programs\n$img_conv_dir = &quot;./bin/&quot;;</p><p>// define database table containing image info\n$img_table = &quot;images&quot;;</p><p>// connect with database\nmysql_connect(&quot;yourhost&quot;, &quot;youruser&quot;, &quot;yourpass&quot;);\nmysql_select_db(&quot;yourtable&quot;);\n</pre></p><p><h4>Moving the file</h4>\n<pre>\n// generate unique id for use in filename\n$uniq = uniqid("");</p><p>// new file name\n$filename = $base_img_dir.$uniq;</p><p>// move uploaded file to destination\nmove_uploaded_file($HTTP_POST_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $filename);\n</pre>\n<p>\nFirst, we generate a 13 characters long, unique name for our image. This name will be used to save the image in the file system. We save the value of <code>$uniq</code> in the database, to identify the image. The uploaded file is moved to its destination.\n</p></p><p><h4>Handling the image</h4>\n<pre>\n// retrieve image info\n$imginfo = getimagesize($filename);</p><p>// handle image according to type\nswitch ($imginfo[2]) {\n    case 1: // gif\n        // convert gif to png using shell command\n        $command = $img_conv_dir.&quot;gif2png $filename&quot;;\n        exec($command);\n        \n        // remove original gif file and rename converted png\n        unlink($filename);\n        rename(&quot;$filename.png&quot;, $filename);\n        \n        // check png image by loading and saving the file\n        //  to prevent wrong uploaded files and errors\n        $img = imagecreatefrompng($filename);\n        imagepng($img, $filename);\n        imagedestroy($img);\n        \n        // set image type to png\n        $img_type = &quot;PNG&quot;;\n        break;\n</pre>\n<p>\nWe start handling the file by retrieving the image info using the <code>getimagesize()</code>-method. <code>$imginfo[2]</code> contains a number identifying the image type. In case of a gif-file, we first need to convert it to the more usable png-format. With the <code>gif2png</code> shell command, the image is converted and saved as <code>$filename.png</code>. We then just have to save the image with the original filename, without extension, to continue.\n</p>\n<p>\nTo check for wrong uploaded files, not-png for instance, we let PHP load the image and save it again. By doing so, we get possible errors when uploading, not when retrieving.\n</p></p><p><pre>\n    case 2: // jpeg\n        // check jpeg image by loading and saving the file\n        //  to prevent wrong uploaded files and errors\n        $img = imagecreatefromjpeg($filename);\n        imagejpeg($img, $filename);\n        imagedestroy($img);\n        \n        // set image type to jpeg\n        $img_type = &quot;JPG&quot;;\n        break;</p><p>    case 3: // png\n        // check png image by loading and saving the file\n        //  to prevent wrong uploaded files and errors\n        $img = imagecreatefrompng($filename);\n        imagepng($img, $filename);\n        imagedestroy($img);\n        \n        // set image type to png\n        $img_type = &quot;PNG&quot;;\n        break;\n</pre>\n<p>\nPng and jpeg-images are handled just like gif-files, with the only exception that they do not have to be converted to a png-file.\n</p></p><p><pre>\n    case 4: // bmp\n        // rename file to bmp\n        rename($filename, &quot;$filename.bmp&quot;);\n        \n        // convert bmp to png using shell command\n        $command = $img_conv_dir.&quot;bmptoppm $filename.bmp   &quot;.\n                   $img_conv_dir.&quot;pnmtopng > $filename&quot;;\n        exec($command);\n        \n        // remove original bmp\n        unlink(&quot;$filename.bmp&quot;);\n        \n        // check png image by loading and saving the file\n        //  to prevent wrong uploaded files and errors\n        $img = imagecreatefrompng($filename);\n        imagepng($img, $filename);\n        imagedestroy($img);\n        \n        // set image type to png\n        $img_type = &quot;PNG&quot;;\n        break;</p><p>    default:\n        break;\n}\n</pre>\n<p>\nThe bmp format needs to be converted. We use the programs <code>bmptoppm</code> and <code>pnmtopng</code> to get a nice png. <code>bmptoppm</code> for some reason only accepts files that have a .bmp-extension, so we will have to rename the uploaded file before running it.\n</p></p><p><h4>Collecting the last bits of information</h4>\n<pre>\n// retrieve image file size\n$imgbytes = filesize($filename);\n</pre>\n<p>\nAfter we have asked <code>filesize()</code> for the size of the image, we now know the following about our image:\n</p>\n<ol>\n<li>the unique filename (<code>$uniq</code>);</li>\n<li>the image type (<code>$img_type</code>);</li>\n<li>the image height (<code>$imginfo[1]</code>);</li>\n<li>the image width (<code>$imginfo[0]</code>);</li>\n<li>the image size (<code>$imgbytes</code>);</li>\n<li>the image title (<code>$ title </code>);</li>\n<li>the image description (<code>$descr</code>);</li>\n<li>the image alt-tag (<code>$alt</code>).</li>\n</ol>\n<p>\nThe last step is the actually saving of this information in the database and displaying a message for the user.\n</p>\n<pre>\n// insert image into db\nmysql_query(&quot;INSERT INTO $img_table (img_file, img_type, img_height,\n   img_width, img_bytes, img_title, img_descr, img_alt)\n  VALUES('$uniq', '$img_type', &quot;.$imginfo[1].&quot;, &quot;.$imginfo[0].&quot;,\n         $imgbytes, '&quot;.addslashes($HTTP_POST_VARS[&quot;title&quot;]).&quot;', '&quot;.\n         addslashes($HTTP_POST_VARS[&quot;descr&quot;]).&quot;',\n         '&quot;.addslashes($HTTP_POST_VARS[&quot;alt&quot;]).&quot;');&quot;);</p><p>// display some information\necho &quot;Image uploaded.&lt;br&gt;&lt;img src=\&quot;img.php?f($uniq)+x(300)\&quot;&gt;&lt;br&gt;&quot;.\n     &quot;URL: img.php?f($uniq)&quot;;\n</pre></p><p><h2>What we did in part 1</h2>\n<p>\nWe just made our user an image upload form, with which we can submit the information and the image. We also wrote a script that handles the upload. The image is then converted from jpeg, png, bmp or gif to a better usable jpeg of png format and saved. After this step, the information about the image is saved to the database for later use.\n</p>\n<p>\nYou can <a href="http://gvtulder.f2o.org/evolt/img/upload.php.txt">download the full script we wrote in this article</a>.\n</p></p><p><h2>Part 2</h2>\n<p>\nIn <a href="http://www.evolt.org/article/Storage_and_re_use_of_images_using_PHP_GD_Part_2/20/32030/index.html" title="Go to part 2">part 2</a> we will build the other half of our image storage system, containing an image search function and an PHP-object to get the image from the database and generate the appropriate img-tag.\n</p>