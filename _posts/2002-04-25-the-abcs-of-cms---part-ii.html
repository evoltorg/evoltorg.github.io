---
layout: post
permalink: node/25272
---
<p>\nIn this installment we will cover logging in a user, presenting them with appropriate navigation according to their user level, and setting up an article table.\n</p></p><p><h2>User Registration</h2></p><p><p>\nIn the previous article, <a href="http://www.evolt.org/article/The_ABCs_of_CMS/20/24182/">The ABCs of CMS</a>, we succeeded in creating a users table (tblUser) that will hold the identification and login information. You should have set up a PHP form page to accept the information, insert the information into the database table, and notify an administrator that someone has registered. (Make sure that you have at least one administrator level person entered into tblUser.) If not here is a sample page that will do just that;\n</p></p><p><pre>\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;CMS User Registration&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;</p><p>&lt;h1&gt;CMS User Registration&lt;/h1&gt;\n&lt;form action="cmsregistration.php" method="POST"&gt;\n&lt;table cellpadding="3" cellspacing="0" border="1"&gt;\n&lt;tr&gt;\n&lt;td&gt;User Name&lt;/td&gt;\n&lt;td&gt;&lt;input type="text" name="username" size="64" maxlength="64"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;E-Mail Address&lt;/td&gt;\n&lt;td&gt;&lt;input type="text" name="email" size="64" maxlength="128"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Password&lt;/td&gt;\n&lt;td&gt;&lt;input type="password" name="password" size="32" maxlength="64"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;INPUT type="submit" value="Send"&gt;&nbsp;&lt;INPUT type="reset"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/table&gt;\n&lt;/form&gt;</p><p>&lt;/body&gt;\n&lt;/html&gt;\n</pre></p><p><p>\nAnd here is the PHP (cmsregistration.php) script to process the registration. Make sure that the cms_user has INSERT privileges;\n</p>\n<pre></p><p>&lt;?</p><p>//connect to and select database\nif(!($dbconnect = mysql_pconnect("127.0.0.1", "cms_user", "cms_password"))){\n	print("Failed to connect to database!\n");\n	exit();\n	}\nif(!mysql_select_db("cms", $dbconnect)){\n	print("Failed to select database!\n");\n	exit();\n	}</p><p>//insert user information into table\n$query = "INSERT INTO tblUser (name, email, password) ";\n$query .= "VALUES ('$username', '$email', '$password') ";</p><p>if(!($dbresult = mysql_query($query, $dbconnect))){\n	print("MySQL reports: " . mysql_error() . "\n");\n	exit();\n	}</p><p>//query user table for admin email address\n$qadmin = "SELECT email ";\n$qadmin .= "FROM tblUser ";\n$qadmin .= "WHERE accesslevel = 'admin' ";</p><p>if(!($dbresult = mysql_query($qadmin, $dbconnect))){\n	print("MySQL reports: " . mysql_error() . "\n");\n	exit();\n	}</p><p>//email message to admin\n$dbadmin = mysql_fetch_object($dbresult);\n$messadm = "$username has registered as an Author in the\n";\n$messadm .= "Content Management System.</p><p>";</p><p>mail("$dbadmin->email", "CMS Author Registration", $messadm, "From: CMS System");</p><p>//send them to the login page\nheader("Location: login.php"); exit; </p><p>?&gt;\n</pre></p><p><p>\nThis script could also be modified to send a mail to the user who registered, complete with a copy of their password for their records. Other interfaces you could create for user management would include a form where a user could update their information and a form for administrators that would allow then to perform modification or deletion of user files.\n</p></p><p><h2>User Login</h2>\n<p>\nNext is creating a login page for the CMS. For simplicity we will use the email address as the login name, due to the fact that email addresses are unique and easy for users to remember, and combine that with their password. Once a user is logged in we will check their user level and send them to the appropriate page. \n</p></p><p><pre>\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;CMS User Login&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;</p><p>&lt;h1&gt;CMS User Login&lt;/h1&gt;\n&lt;form action="cmslogin.php" method="POST"&gt;\n&lt;table cellpadding="3" cellspacing="0" border="1"&gt;\n&lt;tr&gt;\n&lt;td&gt;E-Mail Address&lt;/td&gt;\n&lt;td&gt;&lt;input type="text" name="email" size="64" maxlength="128"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Password&lt;/td&gt;\n&lt;td&gt;&lt;input type="password" name="password" size="32" maxlength="64"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;INPUT type="submit" value="Send"&gt;&nbsp;&lt;INPUT type="reset"&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/table&gt;\n&lt;/form&gt;</p><p>&lt;/body&gt;\n&lt;/html&gt;\n</pre></p><p><p>\nWhich will use the following (cmslogin.php) script to process the login;\n</p></p><p><pre>\n<!--login script-->\n&lt;?</p><p>//connect to and select database\nif(!($dbconnect = mysql_pconnect("127.0.0.1", "cms_user", "cms_password"))){\n	print("Failed to connect to database!\n");\n	exit();\n	}\nif(!mysql_select_db("cms", $dbconnect)){\n	print("Failed to select database!\n");\n	exit();\n	}</p><p>//query to compare user to database\n$quser = "SELECT email, password, accesslevel ";\n$quser .= "FROM tblUser ";\n$quser .= "WHERE email = '$email' ";\n$quser .= "AND password = '$password' ";</p><p>if(!($dbresult = mysql_query($quser, $dbconnect))){\n	print("MySQL reports: " . mysql_error() . "\n");\n	exit();\n	}</p><p>//start session\nsession_start();\nsession_register("emailid");\nsession_register("level");</p><p>//set session variables for identification\n$dbuser = mysql_fetch_object($dbresult);\n$emailid = $dbuser->email;\n$level = $dbuser->accesslevel;</p><p>//send the user to a page based on their user level</p><p>switch($level)\n{\n	case "author":\n	header("Location: myart.php"); exit; \n	break;\n	case "editor":\n	header("Location: editor.php"); exit;\n	break;\n	case "approve":\n	header("Location: approve.php"); exit;\n	break;\n	case "schedule":\n	header("Location: sched.php"); exit;\n	break;\n	case "admin":\n	header("Location: admin.php"); exit;\n	break;\n	default:\n	header("Location: loginfail.php"); exit;\n}</p><p>?&gt;\n</pre></p><p><h2>Navigation Within The CMS</h2></p><p><p>\nOnce a user arrives at the appropriate page they will need access to various functions within the CMS based on their user level. One of the cleanest ways to do this is to set up a table in the CMS for navigation items and assign those items user levels as well. This also makes it easy to edit navigation items later as they are located in a single place. Some developers will want to use <code>include</code> files for these navigation items, there is nothing wrong with that.</p></p><p><p>The database approach gives you the opportunity to easily construct an interface (you can do that as an extracurricular activity, it will not be covered here) with which to manage navigation items, part of the beauty of a CMS. If a certain navigation item needs to change access levels, or if new navigation needs to be added for a particular level it is easy to accomplish.\n</p></p><p><pre>\nCREATE TABLE `tblNavigation` (\n  `ID` int(11) NOT NULL auto_increment,\n  `URL` varchar(128) default NULL,\n  `accesslevel` varchar(64) default NULL,\n  PRIMARY KEY  (`ID`)\n)\n</pre></p><p><p>\nWhere do we keep the user level information during the user's session? It's a matter of preference as some developers will want to use cookies, others will pass hidden form fields, and still others will use session variables. The preference for this project will be session variables and we set the user and user level during login.</p></p><p><p>\n<code>\nsession_register(&quot;emailid&quot;);<br>\nsession_register(&quot;level&quot;);<br>\n</code>.\n</p></p><p><p>\nMake sure to put <code>&lt;? session_start(); ?&gt;</code> as the very first line of each page in the CMS. If you fail to do this your session variables will not get passed properly. If you place the code after a <code>print</code> statement it will throw header errors.\n</p></p><p><p>\nTh only activities that will be provided for an Author at this point are;\n</p></p><p><ul>\n<li>Submit An Article</li>\n<li>Edit User Information (only e-mail and password information)</li>\n<li>My Articles (a list of all of the articles for this author, perhaps with publishing dates)</li>\n</ul></p><p><p>\nThe URLs for those items will have to be placed in the navigation table, along with their access level information.\n</p></p><p><pre>\nINSERT INTO tblNavigation (URL, accesslevel) VALUES ('&lt;a href="subart.php" title="Submit An Article"&gt;Submit An Article&lt;/a&gt;', 'author');\nINSERT INTO tblNavigation (URL, accesslevel) VALUES ('&lt;a href="eduser.php" title="Edit User Information"&gt;Edit User Information&lt;/a&gt;', 'author');\nINSERT INTO tblNavigation (URL, accesslevel) VALUES ('&lt;a href="myart.php" title="My Articles"&gt;My Articles&lt;/a&gt;', 'author');\n</pre></p><p><h2>The Author's Experience</h2></p><p><p>\nOnce an author has logged in to the system they are sent to the myart.php (&quot;My Articles&quot;) page where they are presented with a list of navigation items based on their user level and a list of the articles that they have placed in the CMS. This gives them the opportunity to review material that has been published, and we will later give them the opportunity to be able to edit their own article before sending it through the work flow.\n</p></p><p><p>Since myart.php relies on a number of tables (tblUser, tblNavigation, and tblArticle) let's create our article table.</p></p><p><pre>\nCREATE TABLE `tblArticle` (\n  `ID` int(4) NOT NULL auto_increment,\n  `title` varchar(64) default NULL,\n  `teaser` tinytext,\n  `body` longtext,\n  `submitted` datetime default NULL,\n  'edited' date default NULL,	\n  'approved' date default NULL,\n  `publish` date default NULL,\n  `expire` date default NULL,\n  `author` varchar(128) default NULL,\n  `editor` varchar(128) default NULL,\n  `type` varchar(32) default NULL,\n  PRIMARY KEY  (`ID`)\n);\n</pre></p><p><p>This article table will allow control of many factors concerning each article, such as when it gets published, or if it should expire on a certain date. If you need to create an archive of articles that have been published but have now expired you can query for articles whose expiration dates have passed. Aside from dates, the article table also will contain a plethora of information that can be used in multiple ways.\n</p></p><p><p>\nCreate myart.php, which will show an author their list of articles and allow them to navigate through the CMS.\n</p></p><p><pre>\n&lt;?\nsession_start();</p><p>//connect to and select database\nif(!($dbconnect = mysql_pconnect("127.0.0.1", "cms_user", "cms_password"))){\n	print("Failed to connect to database!\n");\n	exit();\n	}\nif(!mysql_select_db("cms", $dbconnect)){\n	print("Failed to select database!\n");\n	exit();\n	}</p><p>//query to get navigation from database\n$qnav = "SELECT URL ";\n$qnav .= "FROM tblNavigation ";\n$qnav .= "WHERE accesslevel = '$level' ";</p><p>if(!($dbnav = mysql_query($qnav, $dbconnect))){\n	print("MySQL reports: " . mysql_error() . "\n");\n	exit();\n	}</p><p>//query to get article information\n$qart = "SELECT a.ID, a.title, a.publish, u.name ";\n$qart .= "FROM tblArticle a, tblUser u ";\n$qart .= "WHERE u.email = '$emailid' ";\n$qart .= "AND a.author = u.email ";</p><p>if(!($dbart = mysql_query($qart, $dbconnect))){\n	print("MySQL reports: " . mysql_error() . "\n");\n	exit();\n	}</p><p>?&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;CMS&lt;/title&gt;\n&lt;LINK REL="StyleSheet" HREF="cms.css" type="text/css"&gt;\n&lt;/head&gt;\n&lt;body&gt;</p><p>&lt;div class="left"&gt;\n&lt;?\nwhile($dbrow = mysql_fetch_object($dbnav)){\n	print($dbrow-&gt;URL . "&lt;br&gt;\n");\n	}\n?&gt;</p><p></div></p><p>&lt;div class="right"&gt;\n&lt;?\n$dbartrow = mysql_fetch_object($dbart);</p><p>if($dbartrow->ID == ""){\n	//if there are no articles for this author\n	print("You have not placed any articles in the Content Management System");\n	}\nelse \n	{\n	//print article links for this author\n	mysql_data_seek($dbart, 0);\n	print("&lt;h3&gt;Welcome " . $dbartrow->name . "&lt;/h3&gt;\n");</p><p>	while($dbartrow = mysql_fetch_object($dbart)){\n		print("&lt;a href=\"artprvw.php?aid=" . $dbartrow->ID . "\"&gt;" . $dbartrow->title . "&lt;/a&gt;&lt;br&gt;\n");\n		}\n	}\n?&gt;\n&lt;/div&gt;</p><p>&lt;/body&gt;\n&lt;/html&gt;\n</pre></p><p><p>\nAnd here is cms.css, the basic style sheet that can be modified for use with the CMS;\n</p></p><p><pre>\n/*general tags*/\nbody {\n	margin: 0px 0px 0px 0px;\n	background-color: #FFFFFF;\n	font-family: Arial, Helvetica, sans-serif;\n}</p><p>/*div tags*/</p><p>div.left {\n	position: absolute;\n	left: 0px;\n	top:10px;\n	width:185px;\n	padding-left: 10px;\n}</p><p>div.right {\n	top: 10px;\n	margin-top: 10px;\n	margin-left: 201px;\n	margin-right: 30px;\n}\n</pre></p><p><h2>On The Horizon</h2></p><p><p>\nPlay around with the system that has been created, add nav items, or perhaps create the pages for other access levels. Your exploration will prepare you for things that are to come.\n</p>\n<p> Meanwhile we have chewed on quite a bit of information, but there is still plenty to consider and do. In the next article we will cover article submission, allowing an author to preview and edit his or her own articles, and more workflow theory.\n</p>