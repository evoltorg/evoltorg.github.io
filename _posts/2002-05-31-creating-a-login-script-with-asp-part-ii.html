---
layout: post
permalink: node/28674
ratings: 4
avgrate: 3.7500
user: Neil
real_name: "Neil McGill"
user_since: 2002-05-31
avatar: ""
article_count: 2
excerpt: "Following on from part I, this article expands on the simple login script in your ASP pages, adding multiple users and querying the user database."
---
<p>In part I, we created a simple password protection for a single user to protect part of a website. Now, we will explore how to add error messages, allow users to logout/re-login, and query a database for the user name and password entered.</p></p><p><h2>Updating the current script</h2></p><p><p>First of all, we are building on the code already produced in part I. Find the code in the login.asp from part I shown below:</p></p><p><h3>login.asp</h3></p><pre></p>If Request.Form(&quot;login&quot;) = &quot;true&quot; Then</p>    CheckLogin</p>Else</p>    ShowLogin</p>End If</p></pre></p><p><p>And replace it with:</p><pre></p>login = Request.Form(&quot;login&quot;)</p>If login = &quot;logout&quot; Then</p>    Session(&quot;UserLoggedIn&quot;) = &quot;&quot;</p>    ShowLogin</p>Else</p>    If Session(&quot;UserLoggedIn&quot;) = &quot;true&quot; Then</p>        AlreadyLoggedIn</p>    Else </p>        If login = &quot;true&quot; Then</p>            CheckLogin</p>        Else</p>            ShowLogin</p>        End If</p>    End If</p>End If</p></pre></p><p><p>Next we will add the subroutine AlreadyLoggedIn to tell the user they are logged in and ask if they want to logout/login again.</p></p><p><pre></p>&lt;&#37;</p>Sub AlreadyLoggedIn</p>&#37;&gt;</p>You are already logged in.</p>Do you want to logout or login as a different user?</p>&lt;form name=form2 action=login.asp method=post&gt;</p>&lt;input type=submit name=button1 value=&quot;Yes&quot;&gt;</p>&lt;input type=hidden name=login value=&quot;logout&quot;&gt;</p>&lt;/form&gt;</p>&lt;&#37;</p>End Sub</p>&#37;&gt;</p></pre></p><p><h2>Error Checking</h2></p><p>Now to add error checking we need to declare a global error message variable, add code to format the error message and print out the message if needed.</p></p><p><p>Declare the variable to hold the error message near the top of the login page.</p></p><p><code>Dim Error_Msg</code></p><p><p>And we add this little bit of code to the beginning of the login form. This will print out an error message if there is one.</p></p><p><code>Response.Write(Error_Msg &amp; &quot;&lt;br&gt;&quot;)</code></p><p></p><h2>What about other users?</h2></p><p><p>Well, now all that is left to do add the code that checks the user name and password against a database. In order to do this we will rewrite the CheckLogin subroutine from Part I. </p></p><p><pre></p>Sub CheckLogin</p>If LCase(Request.Form(&quot;username&quot;)) = &quot;guest&quot; And LCase(Request.Form(&quot;userpwd&quot;)) = &quot;guest&quot; Then </p>    Session(&quot;UserLoggedIn&quot;) = &quot;true&quot;</p>    Response.Redirect &quot;protectedpage.asp&quot;</p>Else</p>    Response.Write(&quot;Login Failed.&lt;br&gt;&lt;br&gt;&quot;)</p>    ShowLogin</p>End If</p>End Sub</p></pre></p><p>will now look like this: (assuming you use an Access Database - change the connections if different)</p></p><pre></p>Sub CheckLogin</p>Dim Conn, cStr, sql, RS, username, userpwd</p>username = Request.Form(&quot;username&quot;)</p>userpwd = Request.Form(&quot;userpwd&quot;)</p>Set Conn = Server.CreateObject(&quot;ADODB.Connection&quot;)</p>cStr = &quot;DRIVER={Microsoft Access Driver (*.mdb)};&quot;</p>cStr = cStr &amp; &quot;DBQ=&quot; & Server.MapPath(&quot;\path\to\database.mdb&quot;) &amp; &quot;;&quot;</p>Conn.Open(cStr)</p>sql = &quot;select username from UserTable where username = '&quot; &amp; LCase(username) &amp; &quot;'&quot;</p>sql = sql &amp; &quot; and userpwd = '&quot; &amp; LCase(userpwd) &amp; &quot;'&quot;</p>Set RS = Conn.Execute(sql)</p>If RS.BOF And RS.EOF Then</p>    Error_Msg = &quot;Login Failed. Try Again.&quot;</p>    ShowLogin</p>Else</p>    Session(&quot;UserLoggedIn&quot;) = &quot;true&quot;</p>    Response.Redirect &quot;protectedpage.asp&quot;</p>End If</p>End Sub</p></pre></p><p><p>We also need to take out the line of code that sets the Session variable equal to "". What this did was logout our user anytime they pulled up the login page. The code is:</p></p><p><code>Session(&quot;UserLoggedIn&quot;) = &quot;&quot;</code></p><p><p>And that's it. Your pages are now protected and multiple users can access them.</p></p><p><h2>The Scripts in full</h2></p><p><h3>login.asp</h3></p><p><pre></p>&lt;&#37;</p>Response.Expires = -1000 'Makes the browser not cache this page</p>Response.Buffer = True 'Buffers the content so our Response.Redirect will work</p><p>Dim Error_Msg</p><p>login = Request.Form(&quot;login&quot;)</p>If login = &quot;logout&quot; Then</p>    Session(&quot;UserLoggedIn&quot;) = &quot;&quot;</p>    ShowLogin</p>Else</p>    If Session(&quot;UserLoggedIn&quot;) = &quot;true&quot; Then</p>        AlreadyLoggedIn</p>    Else </p>        If login = &quot;true&quot; Then</p>            CheckLogin</p>        Else</p>            ShowLogin</p>        End If</p>    End If</p>End If</p><p>Sub ShowLogin</p>Response.Write(Error_Msg &amp; &quot;&lt;br&gt;&quot;)</p>&#37;&gt;</p>&lt;form name=form1 action=login.asp method=post&gt;</p>User Name : &lt;input type=text name=username&gt;&lt;br&gt;</p>Password : &lt;input type=password name=userpwd&gt;&lt;br&gt;</p>&lt;input type=hidden name=login value=true&gt;</p>&lt;input type=submit value=&quot;Login&quot;&gt;</p>&lt;/form&gt;</p>&gt;&#37;</p>End Sub</p><p>Sub AlreadyLoggedIn</p>&#37;&gt;</p>You are already logged in.</p>Do you want to logout or login as a different user?</p>&lt;form name=form2 action=login.asp method=post&gt;</p>&lt;input type=submit name=button1 value=&quot;Yes&quot;&gt;</p>&lt;input type=hidden name=login value=&quot;logout&quot;&gt;</p>&lt;/form&gt;</p>&lt;&#37;</p>End Sub</p><p>Sub CheckLogin</p>Dim Conn, cStr, sql, RS, username, userpwd</p>username = Request.Form(&quot;username&quot;)</p>userpwd = Request.Form(&quot;userpwd&quot;)</p>Set Conn = Server.CreateObject(&quot;ADODB.Connection&quot;)</p>cStr = &quot;DRIVER={Microsoft Access Driver (*.mdb)};&quot;</p>cStr = cStr &amp; &quot;DBQ=&quot; & Server.MapPath(&quot;\path\to\database.mdb&quot;) &amp; &quot;;&quot;</p>Conn.Open(cStr)</p>sql = &quot;select username from UserTable where username = '&quot; &amp; LCase(username) &amp; &quot;'&quot;</p>sql = sql &amp; &quot; and userpwd = '&quot; &amp; LCase(userpwd) &amp; &quot;'&quot;</p>Set RS = Conn.Execute(sql)</p>If RS.BOF And RS.EOF Then</p>    Error_Msg = &quot;Login Failed. Try Again.&quot;</p>    ShowLogin</p>Else</p>    Session(&quot;UserLoggedIn&quot;) = &quot;true&quot;</p>    Response.Redirect &quot;protectedpage.asp&quot;</p>End If</p>End Sub</p>&#37;&gt;</p></pre></p><p><h3>protectedpage.asp</h3></p><p><pre></p>&lt;&#37;</p>Response.Expires = -1000 'Makes the browser not cache this page</p>Response.Buffer = True 'Buffers the content so our Response.Redirect will work</p><p>If Session(&quot;UserLoggedIn&quot;) <> &quot;true&quot; Then</p>    Response.Redirect(&quot;login.asp&quot;)</p>End If</p>&#37;&gt;</p><p>This page is full of password protected content.  If you are reading this you entered &lt;br&gt;</p>the correct name and password.</p><p></pre>