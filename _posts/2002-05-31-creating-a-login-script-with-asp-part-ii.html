---
layout: post
permalink: node/28674
---
<p>In part I, we created a simple password protection for a single user to protect part of a website. Now, we will explore how to add error messages, allow users to logout/re-login, and query a database for the user name and password entered.</p></p><p><h2>Updating the current script</h2></p><p><p>First of all, we are building on the code already produced in part I. Find the code in the login.asp from part I shown below:</p></p><p><h3>login.asp</h3>\n<pre>\nIf Request.Form(&quot;login&quot;) = &quot;true&quot; Then\n    CheckLogin\nElse\n    ShowLogin\nEnd If\n</pre></p><p><p>And replace it with:\n<pre>\nlogin = Request.Form(&quot;login&quot;)\nIf login = &quot;logout&quot; Then\n    Session(&quot;UserLoggedIn&quot;) = &quot;&quot;\n    ShowLogin\nElse\n    If Session(&quot;UserLoggedIn&quot;) = &quot;true&quot; Then\n        AlreadyLoggedIn\n    Else \n        If login = &quot;true&quot; Then\n            CheckLogin\n        Else\n            ShowLogin\n        End If\n    End If\nEnd If\n</pre></p><p><p>Next we will add the subroutine AlreadyLoggedIn to tell the user they are logged in and ask if they want to logout/login again.</p></p><p><pre>\n&lt;&#37;\nSub AlreadyLoggedIn\n&#37;&gt;\nYou are already logged in.\nDo you want to logout or login as a different user?\n&lt;form name=form2 action=login.asp method=post&gt;\n&lt;input type=submit name=button1 value=&quot;Yes&quot;&gt;\n&lt;input type=hidden name=login value=&quot;logout&quot;&gt;\n&lt;/form&gt;\n&lt;&#37;\nEnd Sub\n&#37;&gt;\n</pre></p><p><h2>Error Checking</h2>\n<p>Now to add error checking we need to declare a global error message variable, add code to format the error message and print out the message if needed.</p></p><p><p>Declare the variable to hold the error message near the top of the login page.</p></p><p><code>Dim Error_Msg</code></p><p><p>And we add this little bit of code to the beginning of the login form. This will print out an error message if there is one.</p></p><p><code>Response.Write(Error_Msg &amp; &quot;&lt;br&gt;&quot;)</code></p><p>\n<h2>What about other users?</h2></p><p><p>Well, now all that is left to do add the code that checks the user name and password against a database. In order to do this we will rewrite the CheckLogin subroutine from Part I. </p></p><p><pre>\nSub CheckLogin\nIf LCase(Request.Form(&quot;username&quot;)) = &quot;guest&quot; And LCase(Request.Form(&quot;userpwd&quot;)) = &quot;guest&quot; Then \n    Session(&quot;UserLoggedIn&quot;) = &quot;true&quot;\n    Response.Redirect &quot;protectedpage.asp&quot;\nElse\n    Response.Write(&quot;Login Failed.&lt;br&gt;&lt;br&gt;&quot;)\n    ShowLogin\nEnd If\nEnd Sub\n</pre>\n<p>will now look like this: (assuming you use an Access Database - change the connections if different)</p>\n<pre>\nSub CheckLogin\nDim Conn, cStr, sql, RS, username, userpwd\nusername = Request.Form(&quot;username&quot;)\nuserpwd = Request.Form(&quot;userpwd&quot;)\nSet Conn = Server.CreateObject(&quot;ADODB.Connection&quot;)\ncStr = &quot;DRIVER={Microsoft Access Driver (*.mdb)};&quot;\ncStr = cStr &amp; &quot;DBQ=&quot; & Server.MapPath(&quot;\path\to\database.mdb&quot;) &amp; &quot;;&quot;\nConn.Open(cStr)\nsql = &quot;select username from UserTable where username = '&quot; &amp; LCase(username) &amp; &quot;'&quot;\nsql = sql &amp; &quot; and userpwd = '&quot; &amp; LCase(userpwd) &amp; &quot;'&quot;\nSet RS = Conn.Execute(sql)\nIf RS.BOF And RS.EOF Then\n    Error_Msg = &quot;Login Failed. Try Again.&quot;\n    ShowLogin\nElse\n    Session(&quot;UserLoggedIn&quot;) = &quot;true&quot;\n    Response.Redirect &quot;protectedpage.asp&quot;\nEnd If\nEnd Sub\n</pre></p><p><p>We also need to take out the line of code that sets the Session variable equal to "". What this did was logout our user anytime they pulled up the login page. The code is:</p></p><p><code>Session(&quot;UserLoggedIn&quot;) = &quot;&quot;</code></p><p><p>And that's it. Your pages are now protected and multiple users can access them.</p></p><p><h2>The Scripts in full</h2></p><p><h3>login.asp</h3></p><p><pre>\n&lt;&#37;\nResponse.Expires = -1000 'Makes the browser not cache this page\nResponse.Buffer = True 'Buffers the content so our Response.Redirect will work</p><p>Dim Error_Msg</p><p>login = Request.Form(&quot;login&quot;)\nIf login = &quot;logout&quot; Then\n    Session(&quot;UserLoggedIn&quot;) = &quot;&quot;\n    ShowLogin\nElse\n    If Session(&quot;UserLoggedIn&quot;) = &quot;true&quot; Then\n        AlreadyLoggedIn\n    Else \n        If login = &quot;true&quot; Then\n            CheckLogin\n        Else\n            ShowLogin\n        End If\n    End If\nEnd If</p><p>Sub ShowLogin\nResponse.Write(Error_Msg &amp; &quot;&lt;br&gt;&quot;)\n&#37;&gt;\n&lt;form name=form1 action=login.asp method=post&gt;\nUser Name : &lt;input type=text name=username&gt;&lt;br&gt;\nPassword : &lt;input type=password name=userpwd&gt;&lt;br&gt;\n&lt;input type=hidden name=login value=true&gt;\n&lt;input type=submit value=&quot;Login&quot;&gt;\n&lt;/form&gt;\n&gt;&#37;\nEnd Sub</p><p>Sub AlreadyLoggedIn\n&#37;&gt;\nYou are already logged in.\nDo you want to logout or login as a different user?\n&lt;form name=form2 action=login.asp method=post&gt;\n&lt;input type=submit name=button1 value=&quot;Yes&quot;&gt;\n&lt;input type=hidden name=login value=&quot;logout&quot;&gt;\n&lt;/form&gt;\n&lt;&#37;\nEnd Sub</p><p>Sub CheckLogin\nDim Conn, cStr, sql, RS, username, userpwd\nusername = Request.Form(&quot;username&quot;)\nuserpwd = Request.Form(&quot;userpwd&quot;)\nSet Conn = Server.CreateObject(&quot;ADODB.Connection&quot;)\ncStr = &quot;DRIVER={Microsoft Access Driver (*.mdb)};&quot;\ncStr = cStr &amp; &quot;DBQ=&quot; & Server.MapPath(&quot;\path\to\database.mdb&quot;) &amp; &quot;;&quot;\nConn.Open(cStr)\nsql = &quot;select username from UserTable where username = '&quot; &amp; LCase(username) &amp; &quot;'&quot;\nsql = sql &amp; &quot; and userpwd = '&quot; &amp; LCase(userpwd) &amp; &quot;'&quot;\nSet RS = Conn.Execute(sql)\nIf RS.BOF And RS.EOF Then\n    Error_Msg = &quot;Login Failed. Try Again.&quot;\n    ShowLogin\nElse\n    Session(&quot;UserLoggedIn&quot;) = &quot;true&quot;\n    Response.Redirect &quot;protectedpage.asp&quot;\nEnd If\nEnd Sub\n&#37;&gt;\n</pre></p><p><h3>protectedpage.asp</h3></p><p><pre>\n&lt;&#37;\nResponse.Expires = -1000 'Makes the browser not cache this page\nResponse.Buffer = True 'Buffers the content so our Response.Redirect will work</p><p>If Session(&quot;UserLoggedIn&quot;) <> &quot;true&quot; Then\n    Response.Redirect(&quot;login.asp&quot;)\nEnd If\n&#37;&gt;</p><p>This page is full of password protected content.  If you are reading this you entered &lt;br&gt;\nthe correct name and password.</p><p></pre>