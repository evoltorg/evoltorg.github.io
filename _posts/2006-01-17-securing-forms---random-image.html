---
layout: post
permalink: securing_forms_random_image
ratings: 0
avgrate: 
category: Code
user: DaButcher
real_name: "Olav Alexander Mjelde"
user_biog: ""
user_since: 21 Dec 2004
avatar: ""
article_count: 1
excerpt: "You might have noticed those \"Enter text as seen on image above\" registration-forms. This article covers how you make your own, quick and simple!"
---
<p>There are several different applications for securing your forms:</p></p><p><strong>When you...</strong></p></p><ul></p><li>Don't want someone doubleposting</li></p><li>Want to protect your pages from computerized registrations (<acronym title="Spam in this case, might be flooding your input-forms for abuse or flooding">spam</acronym>)</li></p><li>want to protect some pages from google or others, without <code>.htaccess</code></li></p></ul></p><h2>Considerations</h2></p><p>There are some considerations, which actually <strong>might block people</strong> from your forms!</p><p><ul></p><li>People who are visually impaired will not see the image!</li></p><li>People who use non-<acronym title="Graphical User Interface">GUI</acronym> browsers will not see the image!</li></p></ul></p><h3>Simple steps to help those with no <acronym title="Graphical User Interface">GUI</acronym></h3></p><p>Provide an alternative way of input, so that the visual-impaired can contact you. This might include options like:</p><ul><li>Emailing you for manual input</li></p><p><li>Some sort of over-ride function, if they type some secret code in the querystring</li></p></ul></p><p>There are several ways to do this, and I urge you to think about, and consider that not everyone on the <acronym title="The World Wide Web">www</acronym> has the same advantages as you and me. Those advantages include that you and me can see images in our web-browsers.</p></p><h2>Backend</h2></p><p>If you are the one who wants things to be quick and simple, this is a great code-sample for your further reading. While some people might also use mySQL for a system like this, you might agree that it's not needed, after seeing the result.</p></p><p><h3>Functions Used</h3></p>To make a script like this, there are several functions that one needs to use.</p>Since this script is quite simple constructed, it does not use a great deal of functions.</p><ul></p><li><code>session_start()</code> - Starts the session</li></p><p><li><code>unset()</code> - Unsets a variable</li></p><li><code>header()</code> - Send a raw HTTP header</li></p><li><code>imagecreatefrompng()</code> - Create a new image from file or URL</li></p><li><code>imagecolorallocate()</code> - Allocate a color for an image</li></p><li><code>imagesx()</code> - Returns the width of the image</li></p><li><code>imagesy()</code> - Returns the height of the image</li></p><li><code>imagestring()</code> - Draw a string horizontally</li></p><li><code>imagepng()</code> - Output a PNG image to either the browser or a file</li></p><li><code>imagedestroy()</code> - Frees any memory associated with image</li></p><p><li><code>substr()</code> - Return part of a string</li></p><li><code>md5()</code> - Calculate the md5 hash of a string</li></p><li><code>time()</code> - Return current Unix timestamp</li></p></ul></p><p><h3>Generating the password, using some of the functions above</h3></p><strong>As quoted from the manual on www.php.net</strong></p><blockquote>Returns the current time measured in the number of seconds since the Unix Epoch (January 1 1970 00:00:00 GMT).</blockquote></p><h4>What does this mean for us?</h4></p><p>We want to generate a random password!</p></p><p><h4> Why not use the <code>time()</code>? </h4></p><p>The <code>time()</code> will be unique, since we all know: <em>time passes!</em></p></p><p><p>However, one might think that the time() might output in a format which might be un-neccessarily hard for the user to read (due to many digits). You and me both know that when we are paying bills, we have to read the account-numbers often twice or three times, to make sure that we have written them correctly. This is however easier if the key can contain both a-z and 0-9. We all know that time is just presented in 0-9, so how do we do this?</p></p><p><p>This is why we only want a part of the time() that we will use for a key.</p>To also make the key more readable, we wrap the time() inside md5().</p>The md5 will then make the key with both integers and letters. (a-z, 0-9).</p></p><p><p>For this tutorial, the key-length is set to 6 characters, which should be more than enough for securing your forms. If you want to calculate how secure your key is, the formula is:<br /></p><p><p>Your key will have a pattern like: xxxxxx (6 characters).<br /></p><p>They might be (a-z, 0-9), which gives 25 possibilities in a-z + 10 possibilities in 0-9.<br /></p>That is a total of 35 possible characters in each character of the key.</p></p><p><p>35 ^ 6 = 1 838 265625 combinations for that key-length.</p></p><p><strong>Also remember:</strong><br /></p>If the user inputs a wrong key, or reloads the page,  the next key will be different, as it's based on the time() function. This makes the possibility for guessing a key: <br /></p>1 / 1 838 265625 ~~ impossible.</p></p><p><h3>Keeping the user on the inside</h3></p><p>There are several ways of making a login script.</p><p>One might use cookies, mysql, flatfiles or other ways.</p>The most simple way of making a login-script, is to use the session variables.</p></p><p><p>While "regular" variables needs to be passed in the query-string, the session_variable does not. You simply start the session with session_start(), at the very top-most of your script.</p>After that is done, you set the wanted variables with <code>$_SESSION['variable_name'] = "value";</code></p></p><p><h2>Backend Code</h2></p><h3>Check for authentication</h3></p><p>This first file, checks if the user is authenticated. Then (if not authenticated), it will generate an random image. If that image is generated, the input by the user must EQUAL the key that the image is based on.</p></p><?php</p>/* Session must always start at the very top of the php file! */</p>session_start();</p><p>if (isset($submit)) { // if user submitted the form</p>  if ($submit == "logout") { // if user wants to logout</p>      unset($_SESSION['key']); // unset the key</p>    }</p>  }</p><p>// if the key is wrong, or not excistant</p>if ($_SESSION['key'] != $_POST['key']    (!($_SESSION['key']))) {</p>  $_SESSION['key'] = substr(md5(time()), 0, 6); // make a key</p> /* Make a form for inputing the key*/</p>  echo " </p>  <form action=\"\" method=\"post\"></p>  <img src=\"img.php\" /></p>  <input type=\"text\" name=\"key\" /></p><p>  <input type=\"submit\" name=\"submit\" value=\"submit\" /></p>  </form>";</p>  }</p>else { // if key is set and input is correct</p> // process the page</p>  echo " </p>  <form action=\"\" method=\"post\"></p>  Access OK</p>  <input type=\"submit\" name=\"submit\" value=\"logout\" /></p>  </form>";</p>  }</p>?></p><p><h3>The image generator (img.php)</h3></p>The image-generator simply applies a string (from the session variable 'key') on to an image, which in this script has to be <code>/images/bg.png</code></p><p><?php</p>// once again, start the session at the very top!</p>session_start();</p><p>/* if there is a key */</p>if ($_SESSION['key']) { </p> /* define that the browser should treat </p>  the output of this file as an image */</p>  header("Content-type: image/png");</p><p>  // set the string to the key</p>  $string = $_SESSION['key']; </p><p>  // create an temporary image from a PNG file</p>  $im    = imagecreatefrompng("images/bg.png");</p><p>  // get a color from the image (in this case, yellow)</p>  $orange = imagecolorallocate($im, 220, 210, 60);</p><p>  /* Now we need to get widh and height of the image, so that we can center the</p>  key on the image, so that it does not go outside of the borders or look strange */</p>  $px    = (imagesx($im) - 7.5 * strlen($string)) / 2;</p>  $h = (imagesy($im) - 7.5) / 2;</p><p>  // here we write the key (the string)  on the image</p>  imagestring($im, 3, $px, $h, $string, $orange);</p><p>  // now create the final image</p>  imagepng($im);</p><p>  // to free up results, we need to destroy the temporary image.</p>  imagedestroy($im);</p>  }</p>?></p><p><h2>Improvements that can be made</h2></p><p></p>There are several improvements that can be made, like the ones mentioned above.The most important one of them all, is the one about the visual impaired, as they will not be able to view an image.</p>