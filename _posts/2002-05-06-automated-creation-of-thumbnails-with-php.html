---
layout: post
permalink: Automated_Creation_of_Thumbnails_With_PHP
ratings: 10
avgrate: 4.3000
category: Site Development
user: gvtulder
real_name: "Gijs van Tulder"
user_biog: "<p>
<a href=\"http://vantulder.net/\" rel=\"nofollow\">Gijs van Tulder</a> is a Dutch student. He likes to play with all things web related and fancies himself as a part-time amateur web developer.
</p>"
user_since: 05 Feb 2002
avatar: /images/pictures/picture-20899.jpg
article_count: 7
excerpt: "When using a Content Management System, it would be easy if you could just upload images, without having to worry about file type and image size. Thumbnails are created on the fly, images are automatically converted to the right file type. With PHP and the GD library, it is very easy to bu..."
---
<p></p>If you are using a Content Management System to manage the content your site, you will run into some problems very early. Publishing images with your articles will soon be the only task not fully automated. You still have to create thumbnails, convert them to the right file type or resize them manually. When, in a later redesign of your site, the requested image size changes, you will have to convert them all over again. Web developers are lazy, so it is time for an easy-to-use solution.</p></p></p><p><h2>The Idea</h2></p><p></p>The idea is simple, yet powerful: supply an image once; retrieve it in all possible formats, sizes and file types. We will build a PHP script that will automate these actions for us. We would like to use the URL of the image to supply our wishes to the script. A possible URL could be:</p><code>http://www.example.com/img.php?f(3cb7f702a5967)+w(300)</code></p>Using this URL, we would like to get the image identified by 3cb7f702a5967, resized to a width of 300 pixels and the corresponding height.</p>The possibilities of our newly created script will be:</p></p></p><ol><li>resize an image to a given width and/or height, possibly preserve the aspect ration;</li></p><li>accept new image sizes as absolute values, and as percentages of the original size;</li></p><li>resize an image when width or height exceed a given limit;</li></p><li>return the image as a PNG or JPEG-file.</li></ol></p><p><h2>What We Need</h2></p><p></p>To build and use this script, you will need <a href="http://www.php.net/" title="You will probably have this" target="_blank">PHP</a> compiled with the <a href="http://www.boutell.com/gd/" title="The GD library by Boutell.com" target="_blank">GD</a> library and JPEG-support.</p></p></p><p><h2>The Syntax</h2></p><p></p>For telling our script what to return, we will use the following syntax. The arguments are delimited by one or more +-es. An example URL could be: <code>http://www.example.com/img.php?f(3cb7f702a5967)+w(300)</code></p></p><table cellspacing="0" class="data"></p><tr><th>Code</th><th>Meaning</th></tr></p><tr><td><code>f(3cb7f702a5967)</code></td><td>The 13-character filename of the requested image. The images are saved without an extension, with the name defined by the current value of <code>uniqid();</code>. That way, new uploaded files will automatically have an unique id.</td></tr></p><tr><td><code>w(123)</code> or <code>w(10%)</code></td><td>The wanted width of the returned image, either in absolute pixels or relative to the original size.</td></tr></p><tr><td><code>h(123)</code> or <code>h(10%)</code></td><td>Same as above, but this is for the height of the image. When just one of the size-commands are given, the other size is automatically calculated, so that de aspect ratio of the image stays the same.</td></tr></p><tr><td><code>x(123)</code></td><td>Defines the maximum width of the returned image. Resizing only takes place if the original width exceeds the given maximum. Only absolute values are accepted.</td></tr></p><tr><td><code>y(123)</code></td><td>Same but for height.</td></tr></p><tr><td><code>t(png jpg)</code></td><td>Defines the requested file type of the image. If no type is given, the image is returned as the original saved type.</td></tr></p><tr><td><code>q(100)</code></td><td>Only for JPEG. Asks for a specific quality of the returned image. Quality can vary from 0 to 100.</td></tr></p></table></p><p><h2>The Script</h2></p><p></p>Now that we have defined the syntax of the script, it is time to take a closer look at the actual code.</p></p></p><p><h3>Checking the arguments</h3></p><p></p>First of all, the given arguments are read from the query string by a simple preg. The regular expression returns all possible tags. Then the tags have to be checked for incorrect values. Defining an array of possible tags and corresponding regular expressions, is an easy way to check the tags in a for-loop. The checked and correct tags are saved in an associative array for later use. As a last check, the script verifies that a filename is given and that that file really does exist.</p></p></p><pre></p>// define the base image dir</p>$base_img_dir = "./img/";</p><p>// find tags</p>preg_match_all("/\+*(([a-z])\(([^\)]+)\))\+*/", $QUERY_STRING,</p>                $matches, PREG_SET_ORDER);</p><p>// empty array and set regular expressions for the check</p>$tags = array();</p>$check = array( "f" => "[0-9a-zA-Z]{13}",</p>                "w" => "[0-9]+%?",</p>                "h" => "[0-9]+%?",</p>                "x" => "[0-9]+",</p>                "y" => "[0-9]+",</p>                "t" => "jpg png",</p>                "q" => "1?[0-9]{1,2}" );</p><p>// check tags and save correct values in array</p>for ($i=0; $i < count($matches); $i++) {</p>    if (isset($check[$matches[$i][2]])) {</p>        if (preg_match('/^('.$check[$matches[$i][2]].')$/',</p>               $matches[$i][3])) {</p>            $tags[$matches[$i][2]] = $matches[$i][3];</p>        }</p>    }</p>}</p><p>function notfound() {</p>    header("HTTP/1.0 404 Not Found");</p>    exit;</p>}</p><p>// check that filename is given</p>if (!isset($tags["f"])) {</p>    notfound();</p>}</p><p>// check if file exists</p>if (!file_exists($base_img_dir.$tags["f"])) {</p>    notfound();</p>}</p></pre></p><p><h3>Loading the Image</h3></p><p></p>The next step is the actual loading of the image. The <code>getimagesize();</code> function is used to determine the file type, and then the correct method is used to load the image. In case the requested type of the returned image is not given, the file type of the original image is set as a default.</p></p></p><pre></p>// retrieve file info</p>$imginfo = getimagesize($base_img_dir.$tags["f"]);</p><p>// load image</p>switch ($imginfo[2]) { </p>    case 2:     // jpg</p>        $img_in = imagecreatefromjpeg($base_img_dir.$tags["f"]) or notfound();</p>        if (!isset($tags["t"])) {</p>            $tags["t"] = "jpg";</p>        }</p>        break;</p>    case 3:     // png</p>        $img_in = imagecreatefrompng($base_img_dir.$tags["f"]) or notfound();</p>        if (!isset($tags["t"])) {</p>            $tags["t"] = "png";</p>        }</p>        break;</p>    default:</p>        notfound();</p>}</p></pre></p><p><h3>Possible resize</h3></p><p></p>The most important part of the script is, of course, the resize. First, we have to look whether or not a resize is needed. When width or height tags are given, the new width and height are calculated using the size of the original image. The new size is used to copy the original image to the new, resized instance.</p></p></p><p><pre></p>// check for maximum width and height</p>if (isset($tags["x"])) {</p>    if ($tags["x"] < imagesx($img_in)) {</p>        $tags["w"] = $tags["x"];</p>    }</p>}</p>if (isset($tags["y"])) {</p>    if ($tags["y"] < imagesy($img_in)) {</p>        $tags["h"] = $tags["y"];</p>    }</p>}</p><p>// check for need to resize</p>if (isset($tags["h"]) or isset($tags["w"])) {</p>    // convert relative to absolute</p>    if (isset($tags["w"])) {</p>        if (strstr($tags["w"], "%")) {</p>            $tags["w"] = (intval(substr($tags["w"], 0, -1)) / 100) *</p>                          $imginfo[0];</p>        }</p>    }</p>    if (isset($tags["h"])) {</p>        if (strstr($tags["h"], "%")) {</p>            $tags["h"] = (intval(substr($tags["h"], 0, -1)) / 100) *</p>                          $imginfo[1];</p>        }</p>    }</p><p>    // resize</p>    if (isset($tags["w"]) and isset($tags["h"])) {</p>        $out_w = $tags["w"];</p>        $out_h = $tags["h"];</p>    } elseif (isset($tags["w"]) and !isset($tags["h"])) {</p>        $out_w = $tags["w"];</p>        $out_h = $imginfo[1] * ($tags["w"] / $imginfo[0]);</p>    } elseif (!isset($tags["w"]) and isset($tags["h"])) {</p>        $out_w = $imginfo[0] * ($tags["h"] / $imginfo[1]);</p>        $out_h = $tags["h"];</p>    } else {</p>        $out_w = $tags["w"];</p>        $out_h = $tags["h"];</p>    }</p>    </p>    // new image in $img_out</p>    $img_out = imagecreate($out_w, $out_h);</p>    imagecopyresized($img_out, $img_in, 0, 0, 0, 0, imagesx($img_out),</p>               imagesy($img_out), imagesx($img_in), imagesy($img_in));</p>} else {</p>    // no resize needed</p>    $img_out = $img_in;</p>}</p></pre></p><p><h3>Returning the image</h3></p><p></p>The last step in our script is the actual returning of the image. The image and corresponding headers are returned as set in the query string. If the wanted type is not given, the image is returned as the original type of the saved file.</p></p></p><pre></p>// check for a given jpeg-quality, otherwise set to default</p>if (!isset($tags["q"])) {</p>    $tags["q"] = 75;</p>}</p><p>// returning the image</p>switch ($tags["t"]) {</p>    case "jpg":</p>        header("Content-type: image/jpeg");</p>        imagejpeg($img_out, "", $tags["q"]);</p>        exit;</p>    case "png":</p>        header("Content-type: image/png");</p>        imagepng($img_out);</p>        exit;</p>   default:</p>        notfound();</p>}</p></pre></p><p><h2>What We Did</h2></p><p></p>Now we have a script that fulfils the tasks we described above. Images are uploaded once and can be resized to whatever you want, without manual action. For the editors, the users of your CMS, uploading images is very simple. They upload the file in the size and type they want, and the script takes care of the resizing and converting. Without more work, your site can show thumbnails in many different sizes. If you, in the near future, would like to redesign your site, it is easy to get a new image size, without having to resize your whole archive.</p></p></p><p></p>The complete script discussed above, is available for download <a href="http://gvtulder.f2o.org/evolt/img/img.php.txt" title="PHP source code" target="_blank">here</a>. A demo of the script is running <a href="http://gvtulder.f2o.org/evolt/img/img.php?f(3cb7f702a5967)" title="Play with the arguments in the query string" target="_blank">here</a>, change the arguments in the query string to try the different commands like <code>w()</code> and <code>t()</code>.</p></p></p><h2>Where to go from here</h2></p><p></p>Some thoughts about possible extensions of this script:</p></p></p><ul><li>Enabling GIF-output. Using the command-line pngtopnm and pmmtogif programs, you can convert PNG-images to GIF on the fly. That way, you do not have to worry about older browsers not supporting the PNG-format.</li></p><li>Uploading of files in more formats. For the users of your CMS, it would be very easy if they could upload images as GIF, Windows bitmaps and TIFF. Using open source conversion utilities, you can still save these images as PNG of JPEG after uploading.</li></p><li>Using normal filenames for the images. Filenames generated with <code>uniqid();</code> are easy and unique, but not very descriptive.</li></p><li>Saving file information like default ALT-tags in a database. You can easily find images for use in articles.</li></ul>