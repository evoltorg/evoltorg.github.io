---
layout: post
permalink: creating_a_login_script_with_php4_part_2
---
<p>There was a fair bit of interest in my <a href="/article/Creating_a_Login_Script_with_PHP_4/17/19661/index.html" title="First login article">previous article</a> which showed you how to create a crude login script included in each document. This article is an update offering better coding, a user database, sign-up script, login/logout scripts and a little script we will use to check a user's login status. Let's get started.</p>\n<h2>Notes</h2>\n<p>There are a few things you should know before you attempt to use this script. The next release of <a href="http://www.php.net" title="PHP Homepage. Opens in a new window." target="_blank">PHP</a> will have register_globals set to Off by default. You're encouraged to write your scripts with this in mind, in this article we won't be using normal variables, we will be using <code>$_POST</code>, <code>$_GET</code>... etc.</p>\n<p>We will also be using <a href="http://www.php.net/manual/en/ref.session.php" title="PHP.net: Sessions reference page. Opens in a new window." target="_blank">sessions</a> with PHP, if you don't understand sessions, or don't know what they are it would be a good idea to <a href="http://www.php.net/manual/en/ref.session.php. Opens in a new window." title="PHP.net: Sessions reference page" target="_blank">read the page</a> so you can understand the coding, and edit it to your needs.</p>\n<p>I will be using the <a href="http://pear.php.net" title="PEAR::DB. Opens in a new window." target="_blank">PEAR::DB</a> classes to access the database, so you can easily make the scripts work with whatever database you are using. If you are unfamiliar with PEAR::DB read this great article: <a href="/article/Abstract_PHP_s_database_code_with_PEAR_DB/17/21927/index.html" title="Abstract PHP's database code with PEAR::DB">Abstract PHP's database code with PEAR::DB</a>.</p>\n<p>With this in mind, I recommend using a <code>.htaccess</code> file (if you use apache) to set some PHP values, use the following, if relevant.</p></p><p><pre>\nphp_value register_globals Off\nphp_value track_vars On\nphp_value arg_separator.output "&amp;amp;"\nphp_value arg_separator.input "&amp;"\n</pre></p><p><h2>Planning</h2>\n<p>We want a system that will allow a user to 'login', preserve that user's login data across multiple requests, allow them access to certain areas only when they are logged in, and allow them to be able to logout. So let's think logically, what do we need?</p>\n<ul>\n<li>User database, containing their password, username, and some personal information to create a community feel.</li>\n<li>Allow them to 'sign up' if they aren't a member.</li>\n<li>A method of checking whether or not the user is 'logged in.'</li>\n<li>Allow them to 'log in' if they're not.</li>\n<li>Allow them to 'log out' when they are done.</li>\n</ul>\n<p>Now we need to turn that logic into code, so let us continue....</p>\n<h2>User database</h2>\n<p>We need a place to store user information. We need to be able to extract this data to authenticate them and insert new data for new members. This article will use an SQL database for this. We need to design the user database, but first of all we need to connect to the database.</p>\n<h3>Connecting</h3>\n<p>We are using the PEAR::DB classes for more portable database coding, rather than using database-specific functions.</p></p><p><pre>\n&lt;?php\nrequire_once 'DB.php';	//require the PEAR::DB classes.</p><p>$db_engine = 'mysql';\n$db_user = 'jester';\n$db_pass = 'password';\n$db_host = 'localhost';\n$db_name = 'database';</p><p>$datasource = $db_engine.'://'.$db_user.':'.$db_pass.'@'.$db_host.'/'.$db_name;</p><p>$db_object = DB::connect($datasource, TRUE);\n/* assign database object in $db_object, if the connection fails $db_object will contain\nthe error message. */</p><p>if(DB::isError($db_object)) {\n	die($db_object->getMessage());	// If $db_object contains an error print out the\n}							// error and exit.</p><p>$db_object->setFetchMode(DB_FETCHMODE_ASSOC);</p><p>include('check_login.php'); // we write this later on, ignore for now.\n?&gt;\n</pre></p><p><p>There we have it, that script will create a connection object which we can use in other scripts to do stuff with the database. This script should be put outside your document tree, or in a protected directory to prevent people accessing it directly. There are various things you need to customise.</p>\n<ul>\n<li>$db_engine - Your database engine, a list of possible values is below.</li>\n<li>$db_user - Your username to access the database.</li>\n<li>$db_pass - Your password.</li>\n<li>$db_host - The host of the database server.</li>\n<li>$db_name - The name of the database to connect to.</li>\n</ul>\n<p>A list of possible database engine values are:</p>\n<p><code>mysql -&gt; MySQL<br>\npgsql -&gt; PostgreSQL<br>\nibase -&gt; InterBase<br>\nmsql -&gt; Mini SQL<br>\nmssql -&gt; Microsoft SQL Server<br>\noci8 -&gt; Oracle 7/8/8i<br>\nodbc -&gt; ODBC (Open Database Connectivity)<br>\nsybase -&gt; SyBase<br>\nifx -&gt; Informix<br>\nfbsql -&gt; FrontBase</code></p>\n<p>So now we have our connection to the database, save this file as <code>db_connect.php</code>. Next we need to design the database, I am providing a script that will create this table for you.</p>\n<h3>Our Table</h3></p><p><pre>\n&lt;?php\nrequire('db_connect.php');	// require above script, change the path to match wherever you put it.</p><p>$table = "CREATE TABLE users (\nid int(10) DEFAULT '0' NOT NULL auto_increment, \nusername varchar(40),\npassword varchar(50), \nregdate varchar(20),\nemail varchar(100),\nwebsite varchar(150),\nlocation varchar(150),\nshow_email int(2) DEFAULT '0',\nlast_login varchar(20),\nPRIMARY KEY(id))";</p><p>$create = $db_object->query($table);	// perform query</p><p>if(DB::isError($create)) {\n	die($create->getMessage());	// check is query was successful\n}						// if not error and exit.\nelse{\n	echo 'Table created successfully.';\n}\n$db_object->disconnect();\n?&gt;\n</pre></p><p><p>That script will create a table in the database you specified, once you have executed this script you can take it out of your document tree so others cannot run it. We will use this table to store user information, retrieve it and check it. Now we need to allow users to become members.</p>\n<h2>Allow Them To 'Sign Up'</h2>\n<p>A user database is no good unless we have users in it, so we need to allow users to add themselves, we use a simple form to allow them to pick a username, password, enter their e-mail address and any other information they choose, and then insert this data into the database.</p>\n<pre>\n&lt;?php\nrequire('db_connect.php');	// database connect script.</p><p>?&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Register an Account&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;?php\nif(isset($_POST['submit'])) { // if form has been submitted\n	/* check they filled in what they supposed to, passwords matched, username\n	isn't already taken, etc. */\n	if(!$_POST['uname']   !$_POST['passwd']   !$_POST['passwd_again']   !$_POST['email']) {\n		die('You didn\'t fill in a required field.');\n	}\n	// check if username exists in database.\n	if(!get_magic_quotes_gpc()) {\n		$_POST['uname'] = addslashes($_POST['uname']);\n	}\n	$name_check = $db_object->query("SELECT username FROM users WHERE username = '".$_POST['uname']."'");\n	if(DB::isError($name_check)) {\n		die($name_check->getMessage());\n	}\n	$name_checkk = $name_check->numRows();</p><p>	if($name_checkk != 0) {\n		die('Sorry, the username: <strong>'.$_POST['uname'].'</strong> is already taken, please pick another one.');\n	}\n	// check passwords match\n	if($_POST['passwd'] != $_POST['passwd_again']) {\n		die('Sorry your password and confirmation password did not match, please try again.');\n	}\n	// check e-mail format\n	if(!preg_match("/.*\@.*\..*/", $_POST['email'])   preg_match("/(\< \>)/", $_POST['email'])) {\n		die('Sorry the e-mail address you submitted was of invalid format.');\n	}\n	// no HTML tags in username, website, location, password\n	if(preg_match("/(\< \>)/", $_POST['uname'])   preg_match("/(\< \>)/", $_POST['passwd'])   preg_match("/(\< \>)/", $_POST['website'])   preg_match("/(\< \>)/", $_POST['location'])) {\n		die('Invalid input, no HTML tags are allowed.');\n	}\n	// check show_email data\n	if($_POST['show_email'] != 0 & $_POST['show_email'] != 1) {\n		die('Nope.');\n	}\n	/* the rest of the information is optional, the only thing we need to check is if they\n	submitted a website, and if so, check the format is ok. */\n	if($_POST['website'] != '' & !preg_match("/^(http ftp):\/\//", $_POST['website'])) {\n		$_POST['website'] = 'http://'.$_POST['website'];\n	}\n	// now we can add them to the database.\n	// encrypt password\n	$_POST['passwd'] = md5($_POST['passwd']);\n	if(!get_magic_quotes_gpc()) {\n		$_POST['passwd'] = addslashes($_POST['passwd']);\n		$_POST['email'] = addslashes($_POST['email']);\n		$_POST['website'] = addslashes($_POST['website']);\n		$_POST['location'] = addslashes($_POST['location']);\n	}\n	$regdate = date('m d, Y');\n	$insert = "INSERT INTO users (username, password, regdate, email, website, location, show_email, last_login) VALUES ('".$_POST['uname']."', '".$_POST['passwd']."', '$regdate', '".$_POST['email']."', '".$_POST['website']."', '".$_POST['location']."', '".$_POST['show_email']."', 'Never')";\n	$add_member = $db_object->query($insert);\n	if(DB::isError($add_member)) {\n		die($add_member->getMessage());\n	}\n	$db_object->disconnect();\n?>\n&lt;h1&gt;Registered&lt;/h1&gt;\n&lt;p&gt;Thank you, your information has been added to the database, you may now &lt;a href="login.php" title="Login"&gt;log in&lt;/a&gt;.&lt;/p&gt;\n&lt;?php\n}\nelse {	// if form hasn't been submitted\n?&gt;\n&lt;h1&gt;Register&lt;/h1&gt;\n&lt;form action="&lt;?=$HTTP_SERVER_VARS['PHP_SELF']?&gt;" method="post"&gt;\n&lt;table align="center" border="1" cellspacing="0" cellpadding="3"&gt;\n&lt;tr&gt;&lt;td&gt;Username*:&lt;/td&gt;&lt;td&gt;&lt;input type="text" name="uname" maxlength="40"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Password*:&lt;/td&gt;&lt;td&gt;&lt;input type="password" name="passwd" maxlength="50"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Confirm Password*:&lt;/td&gt;&lt;td&gt;&lt;input type="password" name="passwd_again" maxlength="50"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;E-Mail*:&lt;/td&gt;&lt;td&gt;&lt;input type="text" name="email" maxlength="100"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Website:&lt;/td&gt;&lt;td&gt;&lt;input type="text" name="website" maxlength="150"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Location&lt;/td&gt;&lt;td&gt;&lt;input type="text" name="location" maxlength="150"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Show E-Mail?&lt;/td&gt;&lt;td&gt;&lt;select name="show_email"&gt;&lt;option value="1" selected="selected"&gt;Yes&lt;/option&gt;&lt;option value="0"&gt;No&lt;/option&gt;&lt;/select&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td colspan="2" align="right"&gt;&lt;input type="submit" name="submit" value="Sign Up"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;\n&lt;/form&gt;\n&lt;?php\n}\n?&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</pre>\n<p>The above script allows the user to register an account, inserting their data into the database, we must perform various checks before we allow this. Checking if the username has been taken, if their passwords matched, and a few security checks. We also encrypt the password in the database for extra security. If all checks are okay we insert the data. Now the user is in the database, we still have to allow them to login, but first we need to write the script that will check if they are logged in or not.</p></p><p><h2>Check if they are logged in</h2>\n<p>This script will assign a variable, <code>$logged_in</code> to either <code>1</code> (if they are logged in), or <code>0</code> if they aren't. We can then use this variable in our scripts. A few points:</p>\n<ul>\n<li>We are going to use <code>$_SESSION['username']</code> for our user's username and <code>$_SESSION['password']</code> for their password.</li>\n<li><code>$_SESSION['password']</code> will be encrypted.</li>\n<li>We need to start our session somewhere, here is a good place.</li>\n</ul>\n<pre>\n&lt;?php\n/* check login script, included in db_connect.php. */</p><p>session_start();</p><p>if(!isset($_SESSION['username'])   !isset($_SESSION['password'])) {\n	$logged_in = 0;\n	return;\n}\nelse {\n// remember, $_SESSION['password'] will be encrypted.</p><p>if(!get_magic_quotes_gpc()) {\n	$_SESSION['username'] = addslashes($_SESSION['username']);\n}\n// addslashes to session username before using in a query.</p><p>$pass = $db_object->query("SELECT password FROM users WHERE username = '".$_SESSION['username']."'");\nif(DB::isError($pass)) {\n	$logged_in = 0;\n	unset($_SESSION['username']);\n	unset($_SESSION['password']); // kill incorrect session variables.\n}\n$db_pass = $pass->fetchRow();\n// now we have encrypted pass from DB in $db_pass['password'], stripslashes() just incase:</p><p>$db_pass['password'] = stripslashes($db_pass['password']);\n$_SESSION['password'] = stripslashes($_SESSION['password']);\n//compare:</p><p>if($_SESSION['password'] == $db_pass['password']) { // valid password for username\n	$logged_in = 1; // they have correct info in session variables.\n}\nelse {\n	$logged_in = 0;\n	unset($_SESSION['username']);\n	unset($_SESSION['password']); // kill incorrect session variables.\n}\n}\n// clean up\nunset($db_pass['password']);\n$_SESSION['username'] = stripslashes($_SESSION['username']);\n?&gt;\n</pre></p><p><p>What we did here was:</p>\n <blockquote>If session variables aren't set, they're not logged in. If they are set, fetch the password row from the database where the username is equal to the session variable username. If password cannot be fetched, the username mustn't exist, kill bad session variables. If the password is fetched, username is correct, compare the encrypted password from the database to the session variable password, if it matches log them in, if not the password is incorrect. Don't set them as logged in and kill bad session variables.</blockquote>\n<p>So now we have our database connection, users can register accounts, we are capable of checking whether they are logged in or not. We can use <code>$logged_in</code> in our scripts now. All that is left is to allow users to log in and log out.</p></p><p><h2>Allow them to 'log in'</h2>\n<p>Now we need to create the script that will allow the user to submit their username and password, check if they are correct and, if so, register them as session variables. Once we register the session variables the user will be deemed as "logged in", <code>$logged_in</code> will be true until they 'log out.'</p></p><p><pre>\n&lt;?php\nrequire('db_connect.php');	// database connect script.\nif($logged_in == 1) {\n	die('You are already logged in, '.$_SESSION['username'].'.');\n}\n?&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Login&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;?php\nif(isset($_POST['submit'])) { // if form has been submitted\n	/* check they filled in what they were supposed to and authenticate */\n	if(!$_POST['uname']   !$_POST['passwd']) {\n		die('You didn\'t fill in a required field.');\n	}\n	// authenticate.\n	if(!get_magic_quotes_gpc()) {\n		$_POST['uname'] = addslashes($_POST['uname']);\n	}\n	$check = $db_object->query("SELECT username, password FROM users WHERE username = '".$_POST['uname']."'");\n	if(DB::isError($check)) {\n		die('That username doesn\'t exist in our database.');\n	}\n	$info = $check->fetchRow();\n	// check passwords match\n	$_POST['passwd'] = stripslashes($_POST['passwd']);\n	$info['password'] = stripslashes($info['password']);\n	$_POST['passwd'] = md5($_POST['passwd']);\n	if($_POST['passwd'] != $info['password']) {\n		die('Incorrect password, please try again.');\n	}</p><p>	// if we get here username and password are correct, register session variables and set\n	// last login time.\n	$date = date('m d, Y');\n	$update_login = $db_object->query("UPDATE users SET last_login = '$date' WHERE username = '".$_POST['uname']."'");\n	$_POST['uname'] = stripslashes($_POST['uname']);\n	$_SESSION['username'] = $_POST['uname'];\n	$_SESSION['password'] = $_POST['passwd'];\n	$db_object->disconnect();\n?>\n&lt;h1&gt;Logged in&lt;/h1&gt;\n&lt;p&gt;Welcome back &lt;?=$_SESSION['username']?&gt;, you are logged in.&lt;/p&gt;\n&lt;?php\n}\nelse {	// if form hasn't been submitted\n?&gt;\n&lt;h1&gt;Login&lt;/h1&gt;\n&lt;form action="&lt;?=$HTTP_SERVER_VARS['PHP_SELF']?&gt;" method="post"&gt;\n&lt;table align="center" border="1" cellspacing="0" cellpadding="3"&gt;\n&lt;tr&gt;&lt;td&gt;Username:&lt;/td&gt;&lt;td&gt;&lt;input type="text" name="uname" maxlength="40"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Password:&lt;/td&gt;&lt;td&gt;&lt;input type="password" name="passwd" maxlength="50"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td colspan="2" align="right"&gt;&lt;input type="submit" name="submit" value="Login"&gt;&lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;\n&lt;/form&gt;\n&lt;?php\n}\n?&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</pre>\n<p>Now we have our 'log in' script. When the user loads this page they are presented with a form that allows them to submit their username and password. We then check if thatsuers is in the database, if it is we take the password associated with that username and compare it with the user's submitted password, if they match the user submitted the correct information. We can register the username and password (encrypted) as session variables. Now these session variables will be subject to inspection by the <code>check_login.php</code> script, authenticating the user each time a page is loaded, allowing us to use our <code>$logged_in</code> variable to check for a correct log in. When the user has done, it's a good idea to allow them to "log out".</p>\n<h2>Allow them to 'log out'</h2>\n<p>To log a user out we simply destroy their session variables and their session.</p></p><p><pre>\n&lt;?php\nrequire('db_connect.php');	// database connect script.\nif($logged_in == 0) {\n	die('You are not logged in so you cannot log out.');\n}</p><p>unset($_SESSION['username']);\nunset($_SESSION['password']); // kill session variables\n$_SESSION = array(); // reset session array\nsession_destroy();   // destroy session.\nheader('Location: index.php'); // redirect them to anywhere you like.\n?&gt;\n</pre></p><p><p>That script is very simple, once the session variables are unset the <code>check_login.php</code> script will set <code>$logged_in</code> to zero, so they will not be classed as "logged in".</p></p><p><h2>Usage</h2>\n<p>Now we have the base of a login system, so let's look at a practical usage of these scripts. A page would look like so:</p></p><p><pre>\n&lt;?php\nrequire('db_connect.php');	// require our database connection\n					// which also contains the check_login.php\n					// script. We have $logged_in for use.</p><p>if($logged_in == 0) {\n	die('Sorry you are not logged in, this area is restricted to registered members. <a href="login.php">Click here</a> to log in.');\n}</p><p>// show content</p><p>$db_object->disconnect(); // when you are done.\n?&gt;\n</pre>\n<p>This makes it very easy to restrict access to a document, only a person whose information has been authenticated by <code>check_login.php</code> will be able to view the page, the others will be offered a link to 'log in.'</p>				\n<h2>More...</h2>\n<p>There are various ways we can jazz up this little member system, such as a user online script, a member list, member profiles, instant message system... the list goes on and on. This is the bear minumum, it's up to you to edit it to your needs, if you need any help use the comments system below and someone will answer.</p>\n<p>We can use <code>$_SESSION['username']</code> to interact with the database row associated with the current logged in user, <code>$logged_in</code> to check for a positive login, we can do just about anything now. We could do this:</p></p><p><pre>\n&lt;?php\nrequire('db_connect.php');</p><p>if($logged_in == 1) {\n	echo 'Logged in as '.$_SESSION['username'].', <a href="logout.php">logout</a>';\n}\nelse {\n	echo 'Not logged in. <a href="login.php">Login</a>';\n}</p><p>?&gt;\n</pre></p><p><p>Showing the user what name they are logged in as and offering a link to logout, while they are logged in, or telling them they aren't logged in and offering them a link to do so, if they're not logged in.</p>\n<p>The list really is endless, I cannot really include more, this article is long enough, if you would like to see a how-to on a few things you can do with this, leave a comment below, if there is enough interest I will find the time to write it.</p></p><p><h2>Conclusion</h2>\n<p>Remember this script isn't ready-to-go, you will need to do some editing. The layout of each page leaves a lot to be desired, jazz them up, you can add more to the user table, create different user levels so members have different access rights depending on their rank -- be creative. Just rememeber to include the <code>db_connect.php</code> script in any document that is part of the member system.</p>\n<p>Here are a few links that may help you get to grips with the features discussed in this article.</p>\n<ul>\n<li><a href="http://www.php.net/manual/en/ref.session.php" title="PHP Manual: session reference. Opens in a new window." target="_blank">PHP Sessions</a></li>\n<li><a href="http://vulcanonet.com/soft/?pack=pear_tut" title="Using PEAR::DB. Opens in a new window." target="_blank">Using PEAR::DB</a></li>\n<li><a href="http://www.php.net/manual/en/security.database.php" title="Database Security. Opens in a new window." target="_blank">Database Security</a></li>\n</ul>\n<p>These scripts have been tested and worked fine for me, if you have any problems feel free to comment, certain databases may require the system to be edited slightly. This article is somewhat discursive, if anyone is confused by my rambling feel free to drop me an e-mail and I'll be happy to elaborate on the areas in which you are having difficulties.</p>\n<p>-Jester (<a href="http://members.evolt.org/jesteruk/index/contact/" title="Contact Me">contact</a>)</p>