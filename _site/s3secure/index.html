<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Hosting And Streaming Your Own Videos Securely Using Amazon S Simple Storage Service S3</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">evolt.org</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Hosting And Streaming Your Own Videos Securely Using Amazon S Simple Storage Service S3</h2>
<p class="meta">12 Nov 2009</p>

<div class="post">
<style> \n	.ln1 {\n	background-color:#ededcc;\n	}\n	.ln2 {\n	background-color:#cceded;\n	}\n	pre {\n	line-height:1.25\n	}\n</style> \n<div class="content"> \n<p>There's more than one tutorial out there about creating your own Flash video, and a handful that show how to use Amazon's Simple Storage Service (S3) to host them. I discovered recently, rather painfully, that if you want to protect your bandwidth costs by restricting access to the video, the details are sketchy and often conflicting.</p> \n<p>This is not the ultimate guide to online video, or even a fairly complete guide to hosting and streaming your own video online. It is, instead, the method I've found which works, start to finish, for me.</p> \n<p>Some parameters: I've long ago forgotten my UNIX skills, and my Mac is nearly antique, so my process happens on a Windows XP box. If you'll check your religious preferences at the door, with a little analysis you can probably translate the video conversion process to your chosen temple.</p> \n<p>Your hosting, though, must have at least PHP5. One hitch I ran into was that my current Windows hosting has PHP4, the and grief of their 'free' upgrade to a computer built this century isn't worth the hassle. I set up hosting at <a href="http://www.charlottezweb.com/" title="link to Charlottezweb; tell Jason that Joel sent you">Charlottezweb.com</a> for $4.99 a month, which comes with all the goodies you'll need, and Jason Saunders as your own personal djinn. That was a plug, a commercial of sorts, because Jason is, as they say, the bomb.</p> \n \n<a name="equipment"></a> \n<h2>My Equipment</h2> \n<p>I don't have professional equipment; you don't need it for web video. My pair of JVC Everio GZ-MG130U Hard Disk camcorders have done just fine for me; I wish I had two more to make staging and scene cuts easier.</p> \n<p>My computer is a tad underpowered; it's a Dell Precision Workstation 330 with 1GB of RAM; it should have about 4GB. I often work directly from my Cavalry external 1TB USB drive (on, believe it or not, USB, not USB2 or SATA since my computer is too old to offer the faster choices and I haven't been bothered enough by transfer speed to do anything about it.)</p> \n<p>I connect to the internet with a 384/128 DSL line which I share with two other people in our office.</p> \n \n<a name="videoprocessing"></a> \n<h2>Processing the Video</h2> \n<p>Until I have a newer Mac and Final Cut, I'm using <a href="http://www.sonycreativesoftware.com/products/vegasfamily.asp" title="link to information about Sony Vegas">Sony Vegas</a> to edit my video. It's inexpensive ($59) and so far hasn't disappointed me.</p> \n<p>Occasionally I separate the video and audio using SUPER (more on that in a moment) and process the audio in Audacity, which is free, and which I've also used for recording all my music demos (I have exactly three professionally recorded tracks, and the real difference on those is the mixing and mastering, not the recording.)</p> \n<p>I'm not going to teach you how to process your video from camera output to watchable video. We'll skip ahead to the point where you have the output; whether it's the Windows Movie file (WMV) you created with your software, a raw AVI from your camera, or whatever, SUPER will convert it to a Flash Video file (FLV.)</p> \n \n<a name="SUPER"></a> \n<h2>SUPER (Simplified Universal Player Encoder & Renderer)</h2> \n<p>You can download the impressively powerful file conversion tool <a href="http://www.erightsoft.com/SUPER.html" title="link to information about SUPER">SUPER</a> (I highly recommend you carefully follow their <a href="http://www.erightsoft.com/dlhelp.html" title="link to SUPER's download tutorial">download tutorial</a>. I have no idea why they make it so hard that they need a tutorial just to download it, but it's free and it's good and it's theirs, so I'll live with it.)</p> \n<p>Once SUPER opens (on my machine, it can take two full minutes) change selection box #1 to 'FLV/SWF (Flash) and don't touch any other settings.</p> \n<p>Open Windows Explorer (I'll pause a moment for one of my favorite rants: since Microsoft named their operating system's navigation tool the same name as their internet navigation tool, this is, remarkably, the place you're most likely to get hung up. Do this: press the Windows key and the letter 'E' on your keyboard at the same time. That's Windows Explorer that pops up. The other one; the one you should never ever use for surfing the web [except when doing your online banking because banks seem to think IE is still the only browser] is Internet Explorer. Ah well.)</p> \n<p>Find your video file, and drag it into the large window at the bottom of SUPER. Here's another confusion: it has a clearly labeled space that says in all caps 'Drop a valid multimedia file here'â€”but that's wrong. They don't mean drag it to where the instruction is written, you drag it to the box below the instruction, which has the headings 'Active', 'FileName', 'Streaming Link' and 'Output Status'</p> \n<p>SUPER will now jump back to the center of your screen, no matter where you've dragged it trying to keep it out of the way. Get used to it. If you know a way to make it stay put, please tell me.</p> \n<p>Press CTRL and 'T' on your keyboard. SUPER shows the file management window. Tell it where you want the FLV file to land when it's created.</p> \n<p>Now, click the first button under the file window, 'Encode (Active Files)' and SUPER, after jumping to mid-screen again, pops up a window asking whether you want a Flash video file (FLV) or ShockWave Flash (SWF) and since I can't help you with processing, embedding, or even understanding ShockWave, we're going with FLV. You can also enter your customized meta tag for the FLV file, according to the instructions, but I never have since I only use this process for private videos and another meta tag wouldn't add much, as far as I can tell.</p> \n<p>Now, we wait. SUPER does all kinds of things we'll never understand, and eventually, you have an FLV file.</p> \n \n<a name="uploadtoS3"></a> \n<h2>Uploading to Amazon</h2> \n<p>Create your Amazon S3 account. Go to <a href="http://aws.amazon.com/s3/" title="link to the homepage of Amazon's S3 service">http://aws.amazon.com/s3/</a>, follow the link in the upper right 'Create an AWS Account' and follow the instructions. If you really truly get stuck at this point, email me and I'll do my best to help.</p> \n<p>Amazon has boundless storage space and bandwidth. There is no charge to create an account, they only charge to use their storage space and bandwidth. It's cheap. Really cheap. For example, I have a pretty high quality (for the web) video that's about 45 minutes long. The FLV file is about 140MB. It cost about once cent for the upload bandwidth. It costs about two cents per month for storage. It will cost almost two and a half cents every time someone streams the entire video.</p> \n<p>So, one full cycle (upload, storage for a month, one view) would cost under six cents. And that's what they bill you; my first month, I played around a bit, and got a charge of eight cents on my credit card.</p> \n \n<a name="security"></a> \n<h2>Control</h2> \n<p>When you stream video or audio on the web, it's pretty simple for the average geek to suss the location of the original file, and link directly to it, either to download or embed on their own site without your knowledge. While I think it's fruitless trying to protect the data itself (if someone can watch your video or listen to your audio, they can capture and copy it and there's nothing on earth you can do to stop them) you should be very concerned about protecting your costs, and here's where it gets sticky.</p> \n<p>Most tutorials for using S3 to host video tell you to change the permissions to, essentially, wide open; visible to everyone. That's the easy route, and it's the normal security setting for web files since, y'know, you want to share them with everyone.</p> \n<p>You get charged for the bandwidth as it's used. That means that if someone were to (accidentally or maliciously) download your video 1,000 times a day for a month, you'd have nearly $700 US in charges before you saw what was happening. Sure, that's very unlikely, but not impossible. Since a surprise charge of $700 would be tough on most small businesses, let's protect ourselves right up front.</p> \n<p>We're in luck. Amazon provides something called Query String Authentication to allow us to essentially password protect our video files.</p> \n<p>Please leave the security alone on your FLV files at Amazon. They're set, by default, to allow only you to touch them. That's okay; QSA lets you securely pass your credentials so that the web browser is allowed to touch the video file.</p> \n<p>Here's where it gets ugly: implementing QSA is a bear. Despite my fairly strong background in technology and the web, I spent about 40 hours over a period of a month trying to sort it out.</p> \n<p>You get to skip over the first 39 hours and just spend the one that actually does something. But first, let's set up our video player, so we have somewhere to send this locked-down video.</p> \n \n<a name="flowplayer"></a> \n<h2>Flowplayer</h2> \n<p>There are quite a few pretty snappy FLV players you can use on your website. If you're not using them for business, that is. Most clearly tell you that they're for personal use only; if you want to use them for business, you pay.</p> \n<p>Many people don't. I don't work that way. That's why I went with <a href="http://flowplayer.org/" title="link to the Flowplayer website">Flowplayer</a>. As far as I can find, while they definitely have a commercial version, it's a choice, if you want to brand it with your logo and all, not a requirement. If you wanna use their free version for your business video, you're just sharing some free word of mouth advertising for them.</p> \n<p>Download and unzip the player, and upload the whole enchilada to the folder you've chosen on your website. While you can share this player among many different folders all over your website, it is left to the reader to sort out pathing and linking and all that. We're just gonna dump it all in the same folder.</p> \n \n<a name="samplepage"></a> \n<h2>The Web Page</h2> \n<p>Here's the code I'm using; I'll explain it down below.</p> \n<p>You can <a href="http://bizba6.com/code/secure_s3_code.php" title="link to the code; opens in a new window. Yes, I did that on purpose." target="_blank">open the code</a> and <a href="http://bizba6.com/code/secure_s3_walkthru.php" title="link to the walk-through; opens in a new window. Yes, I did that on purpose." target="_blank">the walk-through</a> in their own windows to compare them side-by-side.</p> \n<a name="code"></a> \n<pre> \n<a name="code_line_1"> 1 &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"\n<a name="code_line_2"> 2   "http://www.w3.org/TR/xhtml4/DTD/xhtml1-strict.dtd"&gt;\n<a name="code_line_3"> 3 &lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" &gt;\n<a name="code_line_4"> 4 &lt;head&gt;\n<a name="code_line_5"> 5  	&lt;title&gt;The Title of Your Page Should Be Meaningful to Search Engines &amp; Humans Both&lt;/title&gt;\n<a name="code_line_6"> 6  	&lt;meta http-equiv="content-type" content="text/html; charset=iso-8859-1" /&gt;\n<a name="code_line_7"> 7  	&lt;meta name="description" content="Of course, so should your meta description . . ." /&gt;\n<a name="code_line_8"> 8  	&lt;meta name="keywords" content=" . . . and your keywords." /&gt;\n<a name="code_line_9"> 9  	&lt;meta name="author" content="Joel D Canfield, Spinhead Web Design" /&gt;\n<a name="code_line_10">11  	&lt;meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /&gt;\n<a name="code_line_11">12  	&lt;meta http-equiv="imagetoolbar" content="no" /&gt;\n<a name="code_line_12">13  	&lt;link rel="stylesheet" type="text/css" href="yourstylesheet.css" /&gt;\n<a name="code_line_13">14  	&lt;link rel="shortcut icon" href="favicon.ico" /&gt;\n<a name="code_line_14">15 &lt;/head&gt;\n<a name="code_line_15">16 &lt;body&gt;\n<a name="code_line_17"></a><span class="ln1">17 &lt;?php</span> \n<a name="code_line_18"><span class="ln2">18     define("AWS_S3_KEY", "put your real S3 public key here");</span> \n<a name="code_line_19"><span class="ln1">19     define("AWS_S3_SECRET", "put your real S3 secret key here");</span> \n<a name="code_line_20"><span class="ln2">20     $expires = time()+60*60;</span> \n<a name="code_line_21"><span class="ln1">21     $bucket = "mybucket";</span> \n<a name="code_line_22"><span class="ln2">22     $resource = "video.flv";</span> \n<a name="code_line_23"><span class="ln1">23     $string_to_sign = "GET</p><p>\n{$expires}\n/{$bucket}/{$resource}";</span> \n<a name="code_line_24"><span class="ln2">24     $signature = urlencode(base64_encode(hash_hmac("sha1", utf8_encode($string_to_sign), AWS_S3_SECRET, TRUE)));</span> \n<a name="code_line_24a"><span class="ln1">24a                                                                       $string_to_sign), </span> \n<a name="code_line_24b"><span class="ln2">24b                                                           utf8_encode(</span> \n<a name="code_line_24c"><span class="ln1">24c                                                   "sha1",</span> \n<a name="code_line_24d"><span class="ln2">24d                                                                                         AWS_S3_SECRET, </span> \n<a name="code_line_24e"><span class="ln1">24e                                                                                                        TRUE</span> \n<a name="code_line_24f"><span class="ln2">24f                                         hash_hmac(</span> \n<a name="code_line_24g"><span class="ln1">24g                                                                                                            )</span> \n<a name="code_line_24h"><span class="ln2">24h                           base64_encode(</span> \n<a name="code_line_24i"><span class="ln1">24i                                                                                                             )</span> \n<a name="code_line_24j"><span class="ln2">24j                 urlencode(</span> \n<a name="code_line_24k"><span class="ln1">24k                                                                                                              )</span> \n<a name="code_line_24l"><span class="ln2">24l                                                                                                               ;</span> \n<a name="code_line_25"><span class="ln1">25     $authentication_params = "AWSAccessKeyId=".AWS_S3_KEY;</span> \n<a name="code_line_26"><span class="ln2">26     $authentication_params.= "&Expires={$expires}";</span> \n<a name="code_line_27"><span class="ln1">27     $authentication_params.= "&Signature={$signature}";</span> \n<a name="code_line_28"><span class="ln2">28     $link = "https://{$bucket}.s3.amazonaws.com/{$resource}?{$authentication_params}";</span> \n<a name="code_line_29"><span class="ln1">29 ?&gt;</span> \n<a name="code_line_30"><span class="ln2">30</span> \n<a name="code_line_31"><span class="ln1">31 &lt;script type="text/javascript" src="flowplayer-3.1.4.min.js"&gt;&lt;/script&gt;</span> \n<a name="code_line_32"><span class="ln2">32</span> \n<a name="code_line_33"><span class="ln1">33 &lt;?php</span> \n<a name="code_line_34"><span class="ln2">34     echo "&lt;a href=\"".urlencode($link)."\" id=\"player\"&gt;&lt;/a&gt;";</span> \n<a name="code_line_35"><span class="ln1">35 ?&gt;</span> \n<a name="code_line_36"><span class="ln2">36 	&lt;script type="text/javascript"&gt;</span> \n<a name="code_line_37"><span class="ln1">37 	flowplayer("player", "flowplayer-3.1.3.swf",</span> \n<a name="code_line_38"><span class="ln2">38 	{</span> \n<a name="code_line_39"><span class="ln1">39 		clip:</span> \n<a name="code_line_40"><span class="ln2">40 		{</span> \n<a name="code_line_41"><span class="ln1">41 			autoPlay: false,</span> \n<a name="code_line_42"><span class="ln2">42 			autoBuffering: true</span> \n<a name="code_line_43"><span class="ln1">43 		}</span> \n<a name="code_line_44"><span class="ln2">44 	});</span> \n<a name="code_line_45"><span class="ln1">45 	&lt;/script&gt;</span> \n<a name="code_line_46">46\n<a name="code_line_47">47 &lt;/body&gt;\n<a name="code_line_48">48 &lt;/html&gt;\n</pre> \n<a name="walkthrough"></a> \n<p>Lines 1-16 are pretty standard web stuff. If you're not using that type of header in your web pages, figure out why. The rest is discussed below, line by line:</p> \n<p><span class="ln1">17 Begins the PHP code</span><br /> \n<span class="ln2">18 Tells the code what your public shareable not-secret Amazon S3 key is</span><br /> \n<span class="ln1">19 Tells the code what your private, never ever let anyone see this Amazon S3 secret key is. Do not type this; copy and paste from Amazon's tool.</span><br /> \n<span class="ln2">20 Your link needs to expire at some point so folks can't just share the page forever. This sets the timeout to one hour from now, sixty seconds times sixty. Adjust as needed.</span><br /> \n<span class="ln1">21 When you created your Amazon account, you created a unique bucket name. Put it here.</span><br /> \n<span class="ln2">22 This is the name of the video file. Please don't use spaces. Spaces are evil on the web.</span><br /> \n<span class="ln1">23 Don't touch this line. It tells the encryption tool important information.</span><br /> \n<span class="ln2">24 This is where the magic happens; your password info is encrypted along with the timeout, so the resulting link is secure. I'll share the tiny bit I know about each step. It actually happens inside out, so we start in the middle and work towards both ends.</span><br /> \n<span class="ln1">24a The magic text string we created in line 23, which is Amazon's required format.</span><br /> \n<span class="ln2">24b To process the string, we first encode it as UTF-8. It's about using characters that won't break later in the process. Look it up.</span><br /> \n<span class="ln1">24c The first parameter of the encryption function. <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function" title="link to Wikipedia's article">Read painful amounts of info about cryptographic hash functions</a> if you really must.</span><br /> \n<span class="ln2">24d The next parameter of the encryption function, your super-secret Amazon S3 key.</span><br /> \n<span class="ln1">24e Tells the encryption function to output raw binary data instead of, well, something else. I'm gonna have to ask you not to mess with the case, because, especially if you're a Windows user, you'll be amazed to discover that some things on the web are case sensitive. Really. Oh; fine, <a href="http://us2.php.net/function.hash_hmac" title="link to the PHP manual entry on hash_hmac">there's more</a> if you want it.</span><br /> \n<span class="ln2">24f The encryption function is called.</span><br /> \n<span class="ln1">24g The closing paren of the encryption function.</span><br /> \n<span class="ln2">24h And now we do character-encoding using base 64. I do not know why. I barely know what base 64 character-encoding is.</span><br /> \n<span class="ln1">24i The closing paren of the base64 encoding function.</span><br /> \n<span class="ln2">24j And finally, we use PHP's urlencode function to make sure all the characters in our string are web-ready. Don't use htmlentities.</span><br /> \n<span class="ln1">24k The closing paren of the urlencode function, and</span><br /> \n<span class="ln2">24l the magic closing semicolon without which PHP is reduced to a blank white page, driving me mad.</span><br /> \n<span class="ln1">25 The next three lines string together the command S3 needs to see to allow access to the file.</span><br /> \n<span class="ln2">26 </span><br /> \n<span class="ln1">27 </span><br /> \n<span class="ln2">28 This compiles the bits into a single link.</span><br /> \n<span class="ln1">29 Thus endeth the PHP code.</span><br /> \n<span class="ln2">30 </span><br /> \n<span class="ln1">31 This opens the Flowplayer code.</span><br /> \n<span class="ln2">32 </span><br /> \n<span class="ln1">33 Back to PHP for a moment.</span><br /> \n<span class="ln2">34 Tell Flowplayer where the file lives by passing it the encrypted secure link we've created. Here's where it got dodgy. Okay, it got downright ugly. Flowplayer chokes on the plus sign (+) when it really shouldn't. The plus sign is a perfectly viable symbol even in a web link, except somewhere along the line it became tradition for it to symbolize a blank space (please see 'Spaces Are Evil' above.) The original code I found used PHP's 'htmlentities' function to make the link web-ready, and it refused to work. Someone on the Flowplayer forum suggested PHP's 'urlencode' function instead, and it was a huge bingo.</span><br /> \n<span class="ln1">35 End the PHP.</span><br /> \n<span class="ln2">36 More Flowplayer code starts.</span><br /> \n<span class="ln1">37 This is the unique ID of the link we created in line 34, and the location of the Flowplayer itself. Since we put it in the same folder as this web page, it's simply the name of the player's SWF file.</span><br /> \n<span class="ln2">38 Opening the Javascript function.</span><br /> \n<span class="ln1">39 Telling Flowplayer what to do with the video clip.</span><br /> \n<span class="ln2">40 </span><br /> \n<span class="ln1">41 I hate audio or video that start yelling at me on a web page so I've set 'autostart' to 'false.' You are free to follow my fine example of courteous behaviour.</span><br /> \n<span class="ln2">42 Streaming without buffering is goofy unless your visitors have optical fiber right to their computer.</span><br /> \n<span class="ln1">43 Closing up the Flowplayer parameters</span><br /> \n<span class="ln2">44 and the Flowplayer code</span><br /> \n<span class="ln1">45 and the script that called it.</span><br /> \nLines 46-48 end the web page.</p> \n \n<a name="feedback"></a> \n<h2>How's That Workin' for Ya?</h2> \n<p>I'd love to hear feedback on whether this resolved any issues, got you successfully through the process, or left you confused and frustrated. Send me email at joel@spinhead.com and I promise I'll read and respond. If I can help, I will.</p> \n<p style="font-size:80%;font-style:italic;">&copy; 2009 Joel D Canfield except for the Flowplayer code and the original PHP code; feel free to copy and share this all you like, but if you found it helpful, I'm a sucker for credit.</p> \n</div> 
</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
