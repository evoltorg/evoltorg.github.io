<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Handling Undeliverable Mail In Coldfusion</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">evolt.org</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Handling Undeliverable Mail In Coldfusion</h2>
<p class="meta">27 Nov 2001</p>

<div class="post">
<p><em>Note: This script has been tested on a Windows 2000 box running ColdFusion versions 4.5 and 5.0.  Unfortunately with no Solaris or Linux boxes around to test this, I can only assume that it works there as well.  My cursory research shows that it *should* work.  If this is not the case, please leave a comment below.</em></p></p><p><p>If you've used ColdFusion for any length of time, you've probably had to deal with undeliverable mail before.  When you use the <code>&lt;CFMAIL&gt;</code> tag and it cannot successfully send the message to its destination, it deposits the message in the UNDELIVR directory (by default on Windows, is at C:\CFUSION\MAIL\UNDELIVR\).</p></p><p><p>Now, wouldn't it be great to do something with these e-mail bounces?  Maybe you could remove a user from the database if the e-mail address is incorrect, send an e-mail to an administrator or simply delete the message.  Well, that's what this script allows you to do.</p></p><p><h2>The .cfmail File</h2></p><p><p>Let's first look at the kind of .cfmail file that ColdFusion creates.  Here is an example file.  The line numbers have been added in, more on that later.</p></p><p><pre>\n 1: x-cf-version: 4.5.0\n 2: x-cf-server: mail.somewhere.com\n 3: x-cf-port: 25\n 4: x-cf-timeout: 60\n 5: x-cf-from: automated_beacon@somewhere.com\n 6: x-cf-to: lamer@aol.com\n 7:\n 8: Content-type: text/plain\n 9: Date: Wed, 15 Nov 2001 14:09:47 -0500\n10: From: automated_beacon@somewhere.com\n11: Subject: [Your Site] Thank You For Registering!\n12: To: lamer@aol.com\n13:\n14: Thank you for registering with us!  Keep this e-mail for future reference.\n15: \n16: etc. etc.\n</pre></p><p><p>So, what we need to do is to capture the information from this directory and then set up rules to handle the different messages based on subject, from, to, date, anything that is in those standard headers.</p></p><p><h2>The Code</h2></p><p><p>After we first specify our default directory in a variable, we use the <code>&lt;CFDIRECTORY&gt;</code> tag to select the contents of the UNDELIVR directory and deposit them into a query: <code>&lt;CFDIRECTORY ACTION=&quot;LIST&quot; DIRECTORY=&quot;#tmpUndeliverDefaultPath#&quot; NAME=&quot;qryDir&quot; SORT=&quot;Name&quot; FILTER=&quot;*.cfmail&quot;&gt;</code>.  This will allow us to loop through the contents of the directory and then run a particular action based on different criteria.</p></p><p><p>Next, we read the file using the <code>&lt;CFFILE&gt;</code> tag and extract the pertinent information we will need to determine how to handle each e-mail.  Then, once we have the contents of the file, we can deposit the contents in an array by treating the file contents as a list that is delimited by the line feed character using the function <code>Chr(10)</code>.</p></p><p><pre>\n&lt;CFFILE ACTION=&quot;READ&quot; FILE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot; VARIABLE=&quot;tmpTxt&quot;&gt;</p><p>&lt;CFSET tmpEmailContents = ListToArray(tmpTxt,Chr(10))&gt;\n</pre></p><p><p>So, now we have the contents of .cfmail file in a format that we can easily use.  This is where the line numbers from earlier come into play.  We can use the line numbers because they match up with the contents of the array.  For example, the To address is on line six, so it is also in the sixth element in the array.  We can set a variable that contains this text, but since it contains the whole line, including the prefix &quot;x-cf-to:&quot;, we'll use the <code>ReplaceNoCase()</code> function to remove it so that we only have the contents of the element we need:</p></p><p><pre>\n&lt;CFSET tmpEmail = Trim(ReplaceNoCase(tmpEmailContents[6],&quot;x-cf-to:&quot;,&quot;&quot;))&gt;\n</pre></p><p><p>However, this only works for the first six lines of the .cfmail file.  After that the location of the elements can vary from e-mail to e-mail, specifically, when the <code>&lt;CFMAILPARAM&gt;</code> tag is used.  To find an element that varies in location, we simply loop through the elements that can vary (which start at element 8) until we find it.  Below is an example of how we would retrieve the Subject element, whose location is not guaranteed:</p></p><p><pre>\n&lt;CFLOOP FROM=&quot;8&quot; TO=&quot;#ArrayLen(tmpEmailContents)#&quot; INDEX=&quot;i&quot;&gt;\n	&lt;CFIF Find(&quot;Subject:&quot;, tmpEmailContents[i])&gt;\n		&lt;CFSET tmpEmailLoc = i&gt;\n		&lt;CFBREAK&gt;\n	&lt;/CFIF&gt;\n&lt;/CFLOOP&gt;</p><p>&lt;CFSET tmpSubject = Trim(ReplaceNoCase(tmpEmailContents[tmpEmailLoc],&quot;Subject:&quot;,&quot;&quot;))&gt;\n</pre></p><p><p>You can retrieve any elements in the header in this manner.  If the element you need is in the first six lines, you can call it directly, otherwise, loop through until you find it.</p></p><p><p>Now we have the variables we need, it's just a matter of setting up the rules.  If you are going to set up rules based on one variable, such as the Subject line, <code>&lt;CFSWITCH&gt;</code> would be a good way to go, otherwise, you'll need to use a combination of <code>&lt;CFIF&gt;</code>, <code>&lt;CFELSEIF&gt;</code> and <code>&lt;CFELSE&gt;</code> statements.  Here are some example rules:</p></p><p><pre>\n&lt;CFIF tmpSubject IS &quot;[Your Site] Thank You For Registering!&quot;&gt;</p><p>	&lt;!--- Delete this person from the database. ---&gt;\n	&lt;CFQUERY DATASOURCE=&quot;#DSN#&quot; NAME=&quot;qryDelThisEmail&quot;&gt;\n		DELETE\n		FROM tblMembers\n		WHERE txtEmail = '#tmpEmail#'\n	&lt;/CFQUERY&gt;\n	&lt;!--- Delete the message. ---&gt;\n	&lt;CFFILE ACTION=&quot;DELETE&quot; FILE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot;&gt;</p><p>&lt;CFELSEIF tmpEmail CONTAINS &quot;@AtSomeDomainThatAlwaysHasProblems.com&quot;&gt;</p><p>	&lt;CFIF ReFindNoCase(&quot;^([[:alnum:]][-a-zA-Z0-9_%\.]*)?[[:alnum:]]@[[:alnum:]][-a-zA-Z0-9%\>.]*\.[[:alpha:]]{2,}$&quot;, tmpEmail)&gt;\n		&lt;!--- If this e-mail is well-formed according to the regular expression above, try resending it. ---&gt;\n		&lt;CFFILE ACTION=&quot;MOVE&quot; SOURCE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot; DESTINATION=&quot;#tmpSpoolDefaultPath##qryDir.Name#&quot;&gt;\n	&lt;CFELSE&gt;\n		&lt;!--- Otherwise, delete the e-mail. ---&gt;\n		&lt;CFFILE ACTION=&quot;DELETE&quot; FILE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot;&gt;\n	&lt;/CFIF&gt;</p><p>&lt;CFELSE&gt;</p><p>	&lt;!--- E-mail the Administrator ---&gt;\n	&lt;CFMAIL TO=&quot;admin@somewhere.com&quot; FROM=&quot;automated_beacon@somewhere.com&quot; SUBJECT=&quot;[Your Site] Random Message&quot;&gt;\n	Check out the undelivered message folder.\n	\n	&lt;/CFMAIL&gt;\n&lt;/CFIF&gt;\n</pre></p><p><p>Or you could apply whatever other conditions you'd like, and have them perform any actions you'd like.</p></p><p><h2>And That's It</h2></p><p><p>If you wanted to automate this script, you could schedule it in ColdFusion or Windows Scheduler and have it run once a day or once a week, however often e-mail accumulates on your site.</p></p><p><p>Below is the final code.  If you have any questions or improvements, leave your comments below.</p></p><p><pre>\n&lt;CFPARAM NAME=&quot;tmpUndeliverDefaultPath&quot; DEFAULT=&quot;C:\CFUSION\MAIL\UNDELIVR\&quot;&gt;&lt;!--- Path to undelivered e-mail folder. ---&gt;\n&lt;CFPARAM NAME=&quot;tmpSpoolDefaultPath&quot; DEFAULT=&quot;C:\CFUSION\MAIL\SPOOL\&quot;&gt;&lt;!--- Path to spool folder. ---&gt;</p><p>&lt;!--- CFDirectory call to the aforementioned directory. ---&gt;\n&lt;CFDIRECTORY ACTION=&quot;LIST&quot; DIRECTORY=&quot;#tmpUndeliverDefaultPath#&quot; NAME=&quot;qryDir&quot; SORT=&quot;Name&quot; FILTER=&quot;*.cfmail&quot;&gt;</p><p>&lt;CFIF qryDir.RecordCount&gt;\n	&lt;CFOUTPUT QUERY=&quot;qryDir&quot;&gt;\n		&lt;CFFILE ACTION=&quot;READ&quot; FILE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot; VARIABLE=&quot;tmpTxt&quot;&gt;</p><p>		&lt;CFSET tmpEmailContents = ListToArray(tmpTxt,Chr(10))&gt;</p><p>		&lt;CFSET tmpEmail = Trim(ReplaceNoCase(tmpEmailContents[6],&quot;x-cf-to:&quot;,&quot;&quot;))&gt;</p><p>		&lt;CFLOOP FROM=&quot;8&quot; TO=&quot;#ArrayLen(tmpEmailContents)#&quot; INDEX=&quot;i&quot;&gt;\n			&lt;CFIF Find(&quot;Subject:&quot;, tmpEmailContents[i])&gt;\n				&lt;CFSET tmpEmailLoc = i&gt;\n				&lt;CFBREAK&gt;\n			&lt;/CFIF&gt;\n		&lt;/CFLOOP&gt;</p><p>		&lt;CFSET tmpSubject = Trim(ReplaceNoCase(tmpEmailContents[tmpEmailLoc],&quot;Subject:&quot;,&quot;&quot;))&gt;\n			\n		&lt;CFIF tmpSubject IS &quot;[Your Site] Thank You For Registering!&quot;&gt;</p><p>			&lt;!--- Delete this person from the database. ---&gt;\n			&lt;CFQUERY DATASOURCE=&quot;#DSN#&quot; NAME=&quot;qryDelThisEmail&quot;&gt;\n				DELETE\n				FROM tblMembers\n				WHERE txtEmail = '#tmpEmail#'\n			&lt;/CFQUERY&gt;\n			&lt;!--- Delete the message. ---&gt;\n			&lt;CFFILE ACTION=&quot;DELETE&quot; FILE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot;&gt;</p><p>		&lt;CFELSEIF tmpEmail CONTAINS &quot;@AtSomeDomainThatAlwaysHasProblems.com&quot;&gt;</p><p>			&lt;CFIF ReFindNoCase(&quot;^([[:alnum:]][-a-zA-Z0-9_%\.]*)?[[:alnum:]]@[[:alnum:]][-a-zA-Z0-9%\>.]*\.[[:alpha:]]{2,}$&quot;, tmpEmail)&gt;\n				&lt;!--- If this e-mail is well-formed according to the regular expression above, try resending it. ---&gt;\n				&lt;CFFILE ACTION=&quot;MOVE&quot; SOURCE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot; DESTINATION=&quot;#tmpSpoolDefaultPath##qryDir.Name#&quot;&gt;</p><p>			&lt;CFELSE&gt;</p><p>				&lt;!--- Otherwise, delete the e-mail. ---&gt;\n				&lt;CFFILE ACTION=&quot;DELETE&quot; FILE=&quot;#tmpUndeliverDefaultPath##qryDir.Name#&quot;&gt;</p><p>			&lt;/CFIF&gt;</p><p>		&lt;CFELSE&gt;\n		\n			&lt;!--- E-mail the Administrator ---&gt;\n			&lt;CFMAIL TO=&quot;admin@somewhere.com&quot; FROM=&quot;automated_beacon@somewhere.com&quot; SUBJECT=&quot;[Your Site] Random Message&quot;&gt;\n			Check out the undelivered message folder.\n			&lt;/CFMAIL&gt;\n		&lt;/CFIF&gt;\n	&lt;/CFOUTPUT&gt;\n&lt;/CFIF&gt;\n</pre></p><p><p><em>Big thanks to <a href="/user/jeff/15/index.html" title=".jeff Plug">.jeff</a> for all his help with this code.</em></p>
</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
