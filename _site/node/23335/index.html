<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Mission Impossible   Mouse Position</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">evolt.org</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Mission Impossible   Mouse Position</h2>
<p class="meta">15 Apr 2002</p>

<div class="post">
<p>At the moment I am writing an\n<a href="http://www.xs4all.nl/~ppk/js/index.html?introevents.html"\n	title="To my JavaScript Section"\n	target="_blank">Introduction to Events</a>.\nAs part of my study I wanted to create a generic, simple script that detects the mouse coordinates at\nthe time of the event. Because such a script <strong>can</strong> work in\n<a href="http://home.netscape.com/computing/download/index.html?cp=hophb2"\n	title="Download Netscape 6"\n	target="ppk">Netscape</a>,\n<a href="http://www.microsoft.com/windows/ie/downloads/ie6/default.asp"\n	title="Download Explorer 6"\n	target="ppk">Explorer</a>,\n<a href="http://www.opera.com"\n	title="Event handling improved dramatically between 5 and 6"\n	target="ppk">Opera</a>,\n<a href="http://www.konqueror.org"\n	title="An excellent, very standard conforming Linux browser"\n	target="ppk">Konqueror</a> and\n<a href="http://www.icab.de"\n	title="A good standard conforming Mac browser"\n	target="ppk">iCab</a>, it <strong>should</strong> work in all these browsers.</p></p><p><p>But I failed. In fact the situation is so bad that I have reluctantly come to the conclusion that\na cross&#8211;browser script for finding the mouse coordinates during an event\nmust necessarily use a browser detect, something I truly loathe.</p></p><p><p>The problem is, believe it or not, that Explorer\ncorrectly follows the standard &#8212; or rather that\nOpera, Konqueror and iCab have <em>en masse</em> decided\nnot to follow the standard &#8212; or maybe that the standard is in fact not the\nstandard.</p></p><p><p>Detecting the mouse coordinates became such a complex matter, and the story\ncontains such fundamental lessons about standardization, that I wrote this article.</p></p><p><h3>In search of a reference point</h3></p><p><p>But let&#8217;s begin at the beginning. We are looking for mouse coordinates.</p></p><p><p>The main question is &#8220;mouse coordinates relative to what?&#8221;\nIf a mouse coordinate property has a value of 300 this always means &#8220;300 pixels\nfrom my reference point&#8221;, but it doesn&#8217;t tell us what this reference\npoint is.</p></p><p><p>So first we have to decide which reference point we need and then search the properties to\nmatch from the six available pairs (see also my\n<a href="http://www.xs4all.nl/~ppk/js/index.html?events_compinfo.html"\n	title="To my JavaScript Section"\n	target="_blank">compatibility table</a>).</p></p><p>\n<p>Please note the difference between document and window. The window is the &#8220;viewport&#8221;\nthe user has available to view the document in. The document is frequently far longer than the window; in that\ncase we scroll it to get another portion of the document into our viewport.</p></p><p><pre>\n  ---------------------\n    Start of document  \n-------------------------\n    X                    \n                         \n &lt;--- Browser window --&gt; \n                         \n-------------------------\n                       \n     End of document   \n  ---------------------\n</pre></p><p><p>For example, the coordinates of the <strong>X</strong> relative to the window would be 10,10\nwhile its coordinates relative to the document would be 10,100.</p><p><p>What we need are the mouse coordinates <strong>relative to the document</strong> because we often\nwant to place some kind of DHTML layer on or just next to the mouse position. DHTML layers\nalso calculate their position relative to document.\nIf we can find the mouse coordinates relative to the document we can immediately paste them into the\n<code>top</code> and <code>left</code> properties of the DHTML layer we wish to move, avoiding\nall kinds of trouble.</p></p><p><p>So where can we find these mouse coordinates relative to the document?</p></p><p><h3>DOM implementation&#8217;s client area</h3></p><p><p>The\n<a href="http://www.w3.org/TR/2002/WD-DOM-Level-3-Events-20020208/events.html#Events-eventgroupings-mouseevents"\n	target="_blank">W3C DOM Level 2 Events standard</a>\nspecifies two property pairs for mouse coordinates: <code>screenX/Y</code>, the mouse\ncoordinates relative to the entire computer screen, and <code>clientX/Y</code>, which are defined\nas</p></p><p><p title="W3C specification of clientX and clientY"\n	>&#8220;the horizontal/vertical coordinate at which the event occurred relative to the DOM implementation&#8217;s client area.&#8221;\n</p></p><p><p>Now what, one wonders, is the &#8220;DOM implementation&#8217;s client area&#8221;?\nBecause both Netscape 6 and Explorer define <code>clientX/Y</code> as the mouse coordinates\nrelative to the window, it is commonly translated as <strong>window</strong>.</p></p><p><p>This means that to obtain the mouse position relative to the document\nwe have to add the values of some unstandardized, browser specific scrolling offset properties to the\ncoordinates relative to the window <code>clientX/Y</code> give us.\nThus there is <strong>no standards compatible way</strong> to find this information.\nSo far so bad, though it can be worked around.</p></p><p><h3>The minor browsers</h3></p><p><p>But it gets worse. Opera, Konqueror and iCab define <code>clientX/Y</code> as the mouse\ncoordinates relative to the <strong>document</strong>, not to the window. So three important minor browsers\ndisagree with Netscape 6 and Explorer and even with W3C, though all three have a good name for\nstandards compliance.</p></p><p><p>We don&#8217;t see such incompatibilities often because the minor browsers can&#8217;t\nafford them. Although Netscape/Explorer code branching has been common for many years,\nfew web developers would bother to write special code branches for the minor browsers.\nIf a certain method or property is supported by a minor browser it must\nbe <strong>exactly</strong> equal to the Microsoft property of Explorer or the W3C property of Netscape 6.\nIncompatibility with both of the big ones means that neither code branch will work and\nthat scripts will not function correctly.\nThus incompatibility is uncommon, usually caused by a bug.</p></p><p><p>But now <strong>three</strong> of them disagree with <strong>both</strong> big ones in the <strong>same</strong> way.\nThis is a rare sight, so rare in fact, that we should sit up and take notice. Might they have a point?\nIt is clear that their implementation of <code>clientX/Y</code> would greatly benefit\nweb developers, if it were truly cross&#8211;browser.</p></p><p><h3>Browser incompatibility</h3></p><p><p>But it isn&#8217;t cross&#8211;browser, and in fact our chance at a properly written cross&#8211;browser script\nis destroyed. As we&#8217;ve seen Netscape 6 and Explorer support <code>clientX/Y</code> according to the standard:\nthe properties contain the mouse coordinates relative to the <strong>window</strong>.</p></p><p><p>Netscape fortunately stores the coordinates relative to the document in another\n(non&#8211;standard) property pair,\nso we can avoid using <code>clientX/Y</code>. Again we see that browser vendors\nare willing to help us find the mouse position relative to the document.</p></p><p><p>That leaves Explorer as the single browser that does not give us the information we need,\nas the single browser for which we must follow the W3C specification to the last\ndot and comma. Yet another rare sight.</p></p><p><h3>The standards are not the standards?</h3></p><p><p>Or do we all misunderstand the standard and should &#8220;DOM implementation&#8217;s client area&#8221;\nbe translated as <strong>document</strong>? That would be a blessing to web developers &#8212; and restore\nthe natural order of standards compliance in browser&#8211;land.</p></p><p><p>But if the standard means <strong>document</strong> it hides this fact very carefully.\nOn the other hand, if it means <strong>window</strong> it is pretty vague, too.\nAnd we all know what happens when standards are vague. Browser\nvendors create their own standards. That&#8217;s what has happened here.</p></p><p><p>So let&#8217;s go down the sewer for some dirty fixes.</p></p><p><h3>pageX, pageY</h3></p><p><p>The old Netscape event model contains the <code>pageX/Y</code> property pair, which gives the mouse coordinates\nrelative to the entire document. Since this is exactly the information we&#8217;re looking for,\nwe try to apply these properties.</p></p><p><p><code>pageX/Y</code> is supported by Netscape 4 and 6 and sometimes by iCab. So for the benefit\nof these browsers we start up a bit of\n<a href="http://www.xs4all.nl/~ppk/js/index.html?support.html"\n	title="My explanation of this important principle"\n	target="_blank">object detection</a>.\nDoes the browser actually support these\nproperties? If so, use them.</p></p><p><pre>\nfunction doSomething(e)\n{\n	var posx = 0;\n	var posy = 0;\n	if (!e) var e = window.event;\n	if (e.pageX    e.pageY)\n	{\n		posx = e.pageX;\n		posy = e.pageY;\n	}\n	...\n</pre></p><p><p>Not only have we made our script Netscape 4 compatible, we have also neatly evaded the <code>clientX/Y</code>\nproblem in Netscape 6.</p></p><p><h3>clientX, clientY</h3></p><p><p>If the browser doesn&#8217;t support <code>pageX/Y</code> we have to use <code>clientX/Y</code>.\nIf your page does not need to scroll you can ignore all compatibility questions.\nAfter all when the page hasn&#8217;t scrolled the coordinates relative to the window are the same as\nthose relative to the document.</p></p><p><p>You just do</p></p><p><pre>\n	...\n	else if (e.clientX    e.clientY)\n	{\n		posx = e.clientX;\n		posy = e.clientY;\n	}\n	// posx and posy contain the mouse position relative to the document\n	// Do something with this information\n}\n</pre></p><p><p>and you&#8217;re ready.</p></p><p><h3>Browser detect</h3></p><p><p>However, if the page can scroll we have some very serious problems. There are two options.</p></p><p><ol>\n<li>If <code>clientX/Y</code> contain the coordinates relative to the document, we read them out and\nare ready.</li>\n<li>If <code>clientX/Y</code> contain the coordinates relative to the window, we read them out, add the scrolling\noffset of the page and are ready.</li>\n</ol></p><p><p>But how do we know which of these two options we have to use?\nI studied the remaining four property pairs to see if they offer a way out, but they\ndon&#8217;t. I looked at the problem from a theoretical point of view: is it possible to ascertain the\nmeaning of <code>clientX/Y</code> by reading out some screen properties like scrolling offset\nand window height and performing complex calculations? No go.</p></p><p>\n<p>Therefore I&#8217;m forced to use a browser detect. I loathe it, but there is no other way.\nSo let&#8217;s hold our noses and do it.</p></p><p><pre>\nvar isOpera = (navigator.userAgent.indexOf('Opera') != -1);\nvar isIE = (!isOpera && navigator.userAgent.indexOf('MSIE') != -1)\n</pre></p><p><p>Remember that Opera can try to disguise itself as Explorer, which would be fatal to this script.\nTherefore we have to check for Opera first. Konqueror and iCab\ncan disguise themselves too, by the way, but when they do they completely switch identity and are undetectable.\nToo Bad, cannot be helped.</p></p><p><p>Now we do</p></p><p><pre>\n	...\n	else if (e.clientX    e.clientY)\n	{\n		posx = e.clientX;\n		posy = e.clientY;\n		if (isIE)\n		{\n			posx += document.body.scrollLeft;\n			posy += document.body.scrollTop;\n		}\n	}\n	// posx and posy contain\n	// the mouse position relative to the document\n	// Do something with this information\n}\n</pre></p><p><p>and the script works, for the moment.</p></p><p><p>(Note that if you use a DOCTYPE in Explorer 6, you may have to search for <code>scrollTop</code>\nin <code>document.documentElement</code> instead of <code>document.body</code>. I&#8217;m not yet\nsure of the details of this problem and in any case they are beyond the scope of this\narticle.)</p></p><p><h3>Drawbacks of a browser detect</h3></p><p><p>This script is an interesting example of the drawbacks of browser detection as a regular programming\ntechnique. At the moment our dirty fix works fine for undisguised Explorer, Opera, Konqueror\nand iCab browsers, sure. But what about the future?</p></p><p><p>If <strong>any</strong> of the four browsers changes its <code>clientX/Y</code> implementation\nthe script doesn&#8217;t work correctly any more &#8212; and if Explorer switched it would\nbe downright disastrous.</p></p><p><p>You could of course rewrite your browser detect, but do you remember <strong>every single\npage</strong> you used the script on? And how about earlier versions of the browser that has changed?\nYou&#8217;d have to write some more code to correctly draw the line between standard&#8211;compatible and\nnon&#8211;standard&#8211;compatible versions. And would these versions be the same on all operating\nsystems?</p></p><p><p>For such reasons I detest the impossible situation W3C&#8217;s vagueness and\nthe browser vendors&#8217; well&#8211;meaning but untimely intervention have created.\nI want to keep my code clean, but thanks to the mishandling of <code>clientX/Y</code>\nI have no choice but to accept the ugly <code>navigator.userAgent</code> mess.</p></p><p><p>The <code>clientX/Y</code> confusion is a blot on the otherwise excellent DOM Level 2 Events\nspec. Let&#8217;s hope for a speedy solution.</p>
</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
